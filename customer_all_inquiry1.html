<?php
include($_SERVER['DOCUMENT_ROOT']."/include/global.php");

$artist_flag = (isset($_SESSION['artist_flag'])) ? $_SESSION['artist_flag'] : "";

if ($artist_flag === true) {
    $artist_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_name = (isset($_SESSION['shop_user_nickname'])) ? $_SESSION['shop_user_nickname'] : "";
} else {
    $artist_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_name = (isset($_SESSION['gobeauty_user_nickname'])) ? $_SESSION['gobeauty_user_nickname'] : "";
}

$yy = (isset($_REQUEST['yy']) && $_REQUEST['yy']) ? $_REQUEST['yy'] : date('Y');
$mm = (isset($_REQUEST['mm']) && $_REQUEST['mm']) ? $_REQUEST['mm'] : date('m');
$dd = (isset($_REQUEST['dd']) && $_REQUEST['dd']) ? $_REQUEST['dd'] : date('d');



$shop_title	= "전체고객조회";
$header_right	= '
	
';
include($_SERVER['DOCUMENT_ROOT']."/include/skin/header_shop.php");
include($_SERVER['DOCUMENT_ROOT']."/include/check_login_shop.php");


$r_search = ($_GET["q"] && $_GET["q"] != "")? $_GET["q"] : "1";
$artist_id = ($_SESSION['artist_flag'] == true)? $_SESSION['shop_user_id'] : $_SESSION['gobeauty_user_id'];
$pet_type_arr = array(
    "dog" => "개",
    "cat" => "고양이"
);
// 펫샵 여부 체크
$sql = "
	SELECT *
	FROM tb_shop
	WHERE customer_id = '".$artist_id."'
";
$result = mysqli_query($connection, $sql);
$shop_cnt = mysqli_num_rows($result);
while($row = mysqli_fetch_assoc($result)){
    $data["shop"] = $row;
}

$sql = "
    SELECT a.cellphone, COUNT(*) AS cnt
    FROM (
        SELECT pl.cellphone, COUNT(*) AS cnt
        FROM tb_payment_log AS pl
        WHERE pl.artist_id = '".$artist_id."'
            #AND pl.product_type = 'B'
            AND pl.data_delete = 0 
            AND pl.cellphone != ''
            AND (pl.pet_seq != '' OR pl.pet_seq != '0')
        GROUP BY pl.cellphone

        UNION ALL

        SELECT hpl.cellphone, COUNT(*) AS cnt
        FROM tb_hotel_payment_log AS hpl
        WHERE hpl.artist_id = '".$artist_id."'
            AND hpl.cellphone != ''
            AND (hpl.pet_seq != '' OR hpl.pet_seq != '0')
        GROUP BY hpl.cellphone
    ) AS a
    GROUP BY a.cellphone
";
$result = mysqli_query($connection, $sql);
$cus_cnt = mysqli_num_rows($result);
?>

    <!-- container -->
    <section id="container">
        <!-- page-body -->
        <div class="page-body">

            <div class="customer-all-inquiry">
                <div class="con-title-group">
                    <h5 class="con-title"><strong>정렬방식</strong></h5>
                    <select class="arrow" name="search_btn" id="search_tab">
                        <option value="1">최신순</option>
                        <option value="2">가나다순</option>
                        <option value="3">이용횟수별</option>
                        <option value="4">견종별</option>
                        <option value="5">등급별</option>
                    </select>
                </div>
                <!--<div class="customer-state-graph doughnut-graph">
                    <div class="graph-inner">
                        <canvas id="doughnut"></canvas>
                    </div>
                </div>-->

                <div class="customer-all-inquiry-result" id="manage_customer_view_pc">
                    <div class="sort-tab big">
                        <div class="sort-tab-inner">
                            <!-- 활성화시 actived클래스 추가 -->
                            <div class="tab-cell actived"><a href="#" class="btn-tab-item"><strong>고객</strong> (<span class="customer_count"></span>)</a></div>
                            <div class="tab-cell"><a href="#" class="btn-tab-item"><strong>동물</strong> (<span class="pet_count"></span>)</a></div>
                        </div>
                        <!-- 20220310 수정 -->
                        <div class="right-items">
                            <button type="button" onclick="javascript:pop.open('allMemberGradeAddPop');" class="btn btn-outline-gray btn-round btn-inline btn-small-size">전체회원 등급부여</button>
                        </div>
                        <!-- //20220310 수정 -->
                    </div>
                    <!-- tab-data-cell 클래스에 actived클래스 추가시 활성화 -->
                    <div class="tab-data-group">
                        <!-- 고객 -->
                        <div class="tab-data-cell actived">
                            <div>
                                <div class="customer-all-inquiry-list">
                                    <table class="customer-table">
                                        <colgroup>
                                            <col style="width:26%"/>
                                            <col style="width:20%"/>
                                            <col style="width:25%"/>
                                            <col style="width:10%"/>
                                            <col style="width:19%"/>
                                        </colgroup>
                                        <thead>
                                        <tr>
                                            <th rowspan="2">펫이름/등급</th>
                                            <th rowspan="2">견종</th>
                                            <th rowspan="2">전화번호/적립금</th>
                                            <th colspan="2">총 이용내역</th>
                                        </tr>
                                        <tr>
                                            <th>건수</th>
                                            <th>카드/현금</th>
                                        </tr>
                                        </thead>
                                        <tbody class="customer_list_wrap">

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- //고객 -->
                        <!-- 동물 -->
                        <div class="tab-data-cell">
                        </div>
                        <!-- //동물 -->
                    </div>
                </div>
            </div>
        </div>
        <!-- //page-body -->
        <article id="memberGradeAddPop" class="layer-pop-wrap " style="z-index: 100000;">
            <div class="layer-pop-parent">
                <div class="layer-pop-children">
                    <div class="pop-data alert-pop-data">
                        <div class="pop-header">
                            <h4 class="con-title">회원등급 부여</h4>
                        </div>
                        <div class="pop-body">
                            <div class="msg-txt"></div>
                            <div class="form-group">
                                <div class="form-group-item">
                                    <select name="member_grade" id="member_grade">
                                        <?php
                                        $que = "SELECT * FROM tb_grade_of_shop WHERE artist_id = '{$user_id}' ORDER BY grade_ord ASC";
                                        echo $que;
                                        $tgos = sql_fetch_array($que);
                                        if(count($tgos)){
                                            foreach($tgos as $tgos){
                                                //echo $tgos['grade_name'].':'.$grade[0]['name'];
                                                ?>
                                                <option value="<?php echo $tgos['idx'];?>"><?php echo $tgos['grade_name'];?></option>
                                            <?php }}?>
                                    </select>
                                    <div class="form-input-info">선택 후 저장하시면 반영됩니다.</div>
                                </div>
                            </div>
                        </div>
                        <div class="pop-footer">
                            <button type="button" class="btn btn-confirm" onclick="set_grade();">저장</button>
                            <button type="button" class="btn btn-confirm" onclick="popalert.close();">취소</button>
                        </div>
                        <button type="button" class="btn-pop-close" onclick="popalert.close();">닫기</button>
                    </div>
                </div>
            </div>
        </article>

        <!-- 전체등급부여 -->
        <article id="allMemberGradeAddPop" class="layer-pop-wrap">
            <div class="layer-pop-parent">
                <div class="layer-pop-children">
                    <div class="pop-data alert-pop-data">
                        <div class="pop-header">
                            <h4 class="con-title">전체회원 등급부여</h4>
                        </div>
                        <div class="pop-body">
                            <div class="msg-txt">모든 고객님의 등급을<br>하나의 등급으로 반영합니다.</div>
                            <div class="form-group">
                                <div class="form-group-item">
                                    <select name="member_grade_all" id="member_grade_all">
                                        <?php
                                        $que = "SELECT * FROM tb_grade_of_shop WHERE artist_id = '{$user_id}' ORDER BY grade_ord ASC";
                                        //echo $que;
                                        $tgos = sql_fetch_array($que);
                                        if(count($tgos)){
                                            foreach($tgos as $tgos){
                                                //echo $tgos['grade_name'].':'.$grade[0]['name'];
                                                ?>
                                                <option value="<?php echo $tgos['idx'];?>" ><?php echo $tgos['grade_name'];?></option>
                                            <?php }}?>
                                    </select>
                                    <div class="form-input-info">선택 후 저장하시면 반영됩니다.</div>
                                </div>
                            </div>
                        </div>
                        <div class="pop-footer">
                            <button type="button" class="btn btn-confirm" onclick="set_grade_all();">저장</button>
                            <button type="button" class="btn btn-confirm" onclick="pop.close();">취소</button>
                        </div>
                        <button type="button" class="btn-pop-close" onclick="pop.close();">닫기</button>
                    </div>
                </div>
            </div>
        </article>
        <!-- //전체등급부여 -->

        <article id="memberGradeComPop1" class="layer-pop-wrap">
            <div class="layer-pop-parent">
                <div class="layer-pop-children">
                    <div class="pop-data alert-pop-data">
                        <div class="pop-body">
                            <div class="msg-txt">등급이 부여되었습니다.</div>
                        </div>
                        <div class="pop-footer">
                            <button type="button" class="btn btn-confirm" onclick="popalert.close();">확인</button>
                        </div>
                    </div>
                </div>
            </div>
        </article>
    </section>



    <script>
        var search_btn = "<?=$r_search ?>";
        var artist_id = '<?=$artist_id ?>';
        var pet_type_arr = JSON.parse('<?=json_encode($pet_type_arr) ?>');
        var hangul_arr = ['가','나','다','라','마','바','사','아','자','차','카','타','파','하'];
        var hangul_code_arr = [];

        // 총 고객수 구하기
        var total_cnt = <?=$cus_cnt ?>;

        $(document).ready(function(){
            $("#manage_customer_view_pc .customer_count").text(total_cnt.format());
            $(".customer-table").on("click", ".customer-table-toggle", function(){
                $(".customer-table-view").hide();
                $(this).parents(".customer-table-cell").next().show();
            })
        })
        $(function(){
            //$("#loading").css("align-items", "center").css("justify-content", "center");
            //$("#loading").html("<span style='color: #fff; max-width: 50%; text-align:center;'><img src='/pet/images/logo_loading0.gif' style='width: 100px; height: 100px;'/><br/>소중한 고객의 정보를 수집중입니다...</span>");

            for(var _i = 0; _i < hangul_arr.length; _i++){
                var tmp_str = hangul_arr[_i];
                hangul_code_arr.push(String(tmp_str).charCodeAt(0));
            }

            //get_customer_list(artist_id, search_btn);
            //get_customer_count(artist_id);
            get_customer_pet_count(artist_id);
            get_customer_list(artist_id, search_btn);
        });

        $('#search_tab').change(function(){
            console.log($('#search_tab option:selected').val())
            search_btn = $('#search_tab option:selected').val();
            history.pushState(null, null, window.location.pathname+"?q="+search_btn);
            get_customer_list(artist_id, search_btn);
        })
        $(document).on("click", "#manage_customer_view_pc input[name='search_btn']", function(){
            search_btn = $(this).val();
            history.pushState(null, null, window.location.pathname+"?q="+search_btn);
            get_customer_list(artist_id, search_btn);
        });

        function get_customer_list(artist_id, search_btn){
            //$("#loading").css("display", "flex");
            console.log("get_customer_list_start"+total_cnt);

            for(var i=0;i<total_cnt;i+=20){
                var limit_st = i;
                var limit_fi = i+20;

                $.ajax({
                    url: 'data/manage_customer_allview_ajax.php',
                    data: {
                        mode: "get_customer_list",
                        artist_id: artist_id,
                        search_btn: search_btn,
                        limit_st: limit_st,
                        limit_fi: limit_fi
                    },
                    type: 'POST',
                    dataType: 'JSON',
                    beforeSend: function(){
                        $("#loading").addClass("actived");
                        $("#manage_customer_view_pc .customer_list_wrap").html("");
                    },
                    success: function(data) {
                        if(data.code == "000000"){
                            $("#loading").removeClass("actived");
                            //console.log(data.data);
                            var html = '';
                            var code_cnt = 0;
                            var this_code = 0;
                            var no_data = 0;
                            var this_type = "";
                            var chk_end = 0;
                            var pay_type_count1	= 0;
                            var pay_type_count2	= 0;
                            var pay_type_count3	= 0;
                            $.each(data.data, function(i, v){
                                console.log(v);
                                var pet_name = (v.pet_name == "" || v.pet_name == null)? "[이름없음]" : v.pet_name;
                                var pet_type = (v.pet_type == "" || v.pet_type == null)? "[미기입]" : v.pet_type;
                                var service = (v.service == "" || v.service == null)? "" : v.service;
                                var service2 = (v.service2 == "" || v.service2 == ":0" || v.service2 == "all:0" || v.service2 == null)? "" : ((v.type == "dog")? v.service2 : "");
                                var ba_seq = (v.ba_seq && v.ba_seq != "")? '<a href="<?=$shop_directory ?>/beauty_sign_view.php?ba_seq='+v.ba_seq+'&backurl=<?php echo urlencode($_SERVER["REQUEST_URI"]); ?>"><i class="far fa-circle"></i></a>' : '';
                                var is_cancel = (v.is_cancel == "1")? ' class="is_cancel" ' : '';
                                var user_reserve = (v.user_reserve && v.user_reserve != "")? v.user_reserve : '0';
                                var border_color = '';
                                if(v.payment_type == 'beauty'){ border_color = '#daebff'; }
                                if(v.payment_type == 'hotel'){ border_color = '#ffdae3'; }
                                if(v.payment_type == 'playroom'){ border_color = '#fef9e9'; }

                                if(search_btn == "2"){ // 가나다순
                                    code_cnt = String(pet_name).charAt(0).charCodeAt(0);
                                    if(hangul_code_arr[0] < code_cnt){
                                        $.each(hangul_code_arr, function(i, v2){
                                            if(v2 > code_cnt){
                                                if(this_code != v2){
                                                    this_code = v2;
                                                    html += '<tr>';
                                                    html += '	<td colspan="10" class="lft sub_line">'+hangul_arr[i-1]+'</td>';
                                                    html += '</tr>';
                                                }
                                                return false;
                                            }else{
                                                if(hangul_code_arr[hangul_code_arr.length - 1] <= code_cnt && chk_end == 0){
                                                    html += '<tr>';
                                                    html += '	<td colspan="10" class="lft sub_line">'+hangul_arr[hangul_code_arr.length - 1]+'</td>';
                                                    html += '</tr>';
                                                    chk_end++;
                                                    return false;
                                                }
                                            }
                                        });
                                    }else{
                                        if(no_data == 0){
                                            html += '<tr>';
                                            html += '	<td colspan="10" class="lft sub_line">[이름없음]</td>';
                                            html += '</tr>';
                                            no_data++;
                                        }
                                    }
                                }else if(search_btn == "4"){ // 견종별
                                    code_cnt = String(pet_type).charAt(0).charCodeAt(0);
                                    if(hangul_code_arr[0] < code_cnt){
                                        $.each(hangul_code_arr, function(i, v2){
                                            if(v2 > code_cnt){
                                                if(this_code != v2){
                                                    this_code = v2;
                                                    html += '<tr>';
                                                    html += '	<td colspan="10" class="lft sub_line">'+pet_type_arr[v.type]+' - '+hangul_arr[i-1]+'</td>';
                                                    html += '</tr>';
                                                }
                                                return false;
                                            }else{
                                                if(hangul_code_arr[hangul_code_arr.length - 1] <= code_cnt){
                                                    html += '<tr>';
                                                    html += '	<td colspan="10" class="lft sub_line">'+hangul_arr[hangul_code_arr.length - 1]+'</td>';
                                                    html += '</tr>';
                                                    return false;
                                                }
                                            }
                                            if(this_type != v.type){
                                                this_type = v.type;
                                            }
                                        });
                                    }else{
                                        if(no_data == 0){
                                            html += '<tr>';
                                            html += '	<td colspan="10" class="lft sub_line">[미기입]</td>';
                                            html += '</tr>';
                                            no_data++;
                                        }
                                    }
                                }

                                if(v.payment_type == "beauty"){
                                    pay_type_text	= "미용";
                                    //console.log(parseInt(v.cnt.format()));

                                    pay_type_count1	+= parseInt(v.cnt.format());


                                    //html += '		<a class="view_payment_btn" href="<?=$shop_directory ?>/view_payment_customer_info_pc.php?payment_log_seq='+v.payment_log_seq+'&backurl=<?php echo urlencode($_SERVER["REQUEST_URI"]); ?>">'+v.update_time2+'</a>';
                                }else if(v.payment_type == "hotel"){
                                    pay_type_text	= "호텔";
                                    pay_type_count2	+= v.cnt.format();
                                    //html += '		<a class="view_payment_btn" href="<?=$shop_directory ?>/view_hotel_payment_customer_info_pc.php?order_num='+v.payment_log_seq+'&backurl=<?php echo urlencode($_SERVER["REQUEST_URI"]); ?>">'+v.update_time2+'</a>';
                                }else if(v.payment_type == "playroom"){
                                    pay_type_text	= "유치원";
                                    pay_type_count3	+= v.cnt.format();
                                    //html += '		<a class="view_payment_btn" href="<?=$shop_directory ?>/view_playroom_payment_customer_info_pc.php?order_num='+v.payment_log_seq+'&backurl=<?php echo urlencode($_SERVER["REQUEST_URI"]); ?>">'+v.update_time2+'</a>';
                                }

                                var start_txt = '';
                                var reserve_info = '';
                                if(v.cnt == '0'){
                                    start_txt = "신규등록일시";
                                    service = "[신규등록]";
                                    service2 = "[신규등록]";
                                }else{
                                    start_txt = "최근이용일시";
                                    reserve_info = '<a href="reserve_pay_management_2?payment_log_seq='+v.payment_log_seq+'" class="btn btn-outline-gray btn-small-size btn-round">예약내역</a>';
                                }

                                // 등급 아이콘
                                if(v.grade_ord == 1){
                                    var grade_icon = '<div class="icon icon-grade-vip"></div>';
                                }else if(v.grade_ord == 2){
                                    var grade_icon = '<div class="icon icon-grade-normal"></div>';
                                }else{
                                    var grade_icon = '<div class="icon icon-grade-normalb"></div>';
                                }

                                var type = (pet_type_arr[v.type])? pet_type_arr[v.type] : "알수없음";
                                html2	= `
							<!-- 하나의 아이템 -->
							<tr class="customer-table-cell">
								<td>
									<button type="button" class="customer-table-toggle">${pet_name}</span></span>
										<!--<span class="toggle-grade"><span class="icon icon-grade-vip"></span></span>-->
									</button>
								</td>
								<td>
									<div class="customer-table-txt"><strong>${type}</strong></div>
									<div class="customer-table-txt">${pet_type}</div>
								</td>
								<td>
									<div class="customer-table-txt">${v.cellphone}</div>
									<div class="customer-table-txt">${user_reserve.format()}P</div>
								</td>
								<td>
									<div class="customer-table-txt">${pay_type_text	}</div>
									<div class="customer-table-txt">${v.cnt.format()}</div>
								</td>
								<td>
									<div class="customer-table-txt">${v.sum_local_price.format()}원</div>
									<div class="customer-table-txt">${v.sum_local_price_cash.format()}원</div>
								</td>
							</tr>
							<tr class="customer-table-view">
								<td colspan="5">
									<div class="flex-table">
										<div class="flex-table-cell">
											<div class="flex-table-item">
												<div class="flex-table-title"><div class="txt">${start_txt}</div></div>
												<div class="flex-table-data">
													<div class="flex-table-data-inner">
														<div class="flex align-items-center">
															<div class="flex-auto mr-px-12">
																<div class="flex-table-value">${v.update_time2}</div>
																<!--div class="flex-table-value">${v.update_time2}</div-->
															</div>
															<div class="flex-1">
																<div class="grid-layout btn-grid-group">
																	<div class="grid-layout-inner">
                                                                        <div class="grid-layout-cell grid-2">${reserve_info}</div>
																		<div class="grid-layout-cell grid-2"><a href="customer_view?customer_cellphone=${v.cellphone}&pet_seq=${v.pet_seq}" class="btn btn-outline-gray btn-small-size btn-round">고객정보</a></div>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="flex-table-cell">
											<div class="flex-table-item">
												<div class="flex-table-title"><div class="txt">최근이용내역</div></div>
												<div class="flex-table-data">
													<div class="flex-table-data-inner">
														${service}
													</div>
												</div>
											</div>
										</div>
										<div class="flex-table-cell">
											<div class="flex-table-item">
												<div class="flex-table-title"><div class="txt">최근추가내역</div></div>
												<div class="flex-table-data">
													<div class="flex-table-data-inner">
														${service2}
													</div>
												</div>
											</div>
										</div>
										<div class="flex-table-cell">
											<div class="flex-table-item">
												<div class="flex-table-title"><div class="txt">최근취소일시</div></div>
												<div class="flex-table-data">
													<div class="flex-table-data-inner">
														${v.cancel_time}
													</div>
												</div>
											</div>
										</div>
										<div class="flex-table-cell">
											<div class="flex-table-item">
												<div class="flex-table-title"><div class="txt">이용동의서</div></div>
												<div class="flex-table-data">
													<div class="flex-table-data-inner">
														<div class="grid-layout btn-grid-group">
															<div class="grid-layout-inner">
																<div class="grid-layout-cell grid-2"><a href="customer_beauty_agree?aid=${artist_id}&uid=${v.cellphone}&pid=${v.pet_seq}" class="btn btn-outline-gray btn-small-size btn-round">미용동의서</a></div>
																<div class="grid-layout-cell grid-2"><a href="customer_hotel_agree?aid=${artist_id}&uid=${v.cellphone}&pid=${v.pet_seq}" class="btn btn-outline-gray btn-small-size btn-round">호텔동의서</a></div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="flex-table-cell">
											<div class="flex-table-item">
												<div class="flex-table-title"><div class="txt">등급</div></div>
												<div class="flex-table-data">
													<div class="flex-table-data-inner">
														<div class="grid-layout btn-grid-group">
															<div class="grid-layout-inner">
																<div class="grid-layout-cell grid-2">
																	<div class="user-grade-item">
																		${grade_icon}
																		<div class="icon-grade-label">${v.grade_name}</div>
																	</div>
																</div>
																<!--<div class="grid-layout-cell grid-2"><a href="javascript:open_grade('${pet_name}','${v.cellphone}','${v.grade_name}','${v.grade_ord}');" class="btn btn-outline-gray btn-small-size btn-round set-grade" data-id="" data-grade="">등급부여하기</a></div>-->
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</td>
							</tr>
							<!-- //하나의 아이템 -->
						`;
                                //console.log(html2);
                                $(".customer_list_wrap").append(html2);
                                /*
                                html += '<tr>';
                                html += '	<td data-no="'+(i+1)+'" style="border-left: 5px solid '+border_color+'; white-space: nowrap;">';
                                html += '		<a href="<?=$shop_directory ?>/manage_customer_view_pc.php?customer_cellphone='+v.cellphone+'&customer_pet_seq='+v.pet_seq+'&backurl=<?php echo urlencode($_SERVER["REQUEST_URI"]); ?>">'+pet_name+'</a>';
						html += '	</td>';
						html += '	<td>'+pet_type_arr[v.type]+'<br/>'+pet_type+'</td>';
						html += '	<td>'+v.cellphone+'<br/><div style="text-align: right;">'+user_reserve.format()+' 원</div></td>';
						html += '	<td '+is_cancel+'>';
						if(v.payment_type == "beauty"){
							html += '		<a class="view_payment_btn" href="<?=$shop_directory ?>/view_payment_customer_info_pc.php?payment_log_seq='+v.payment_log_seq+'&backurl=<?php echo urlencode($_SERVER["REQUEST_URI"]); ?>">'+v.update_time2+'</a>';
						}else if(v.payment_type == "hotel"){
							html += '		<a class="view_payment_btn" href="<?=$shop_directory ?>/view_hotel_payment_customer_info_pc.php?order_num='+v.payment_log_seq+'&backurl=<?php echo urlencode($_SERVER["REQUEST_URI"]); ?>">'+v.update_time2+'</a>';
						}else if(v.payment_type == "playroom"){
							html += '		<a class="view_payment_btn" href="<?=$shop_directory ?>/view_playroom_payment_customer_info_pc.php?order_num='+v.payment_log_seq+'&backurl=<?php echo urlencode($_SERVER["REQUEST_URI"]); ?>">'+v.update_time2+'</a>';
						}
						html += '	</td>';
						html += '	<td '+is_cancel+' style="font-size: 10px;">'+service+'</td>';
						html += '	<td '+is_cancel+' style="font-size: 10px;">'+service2+'</td>';
						html += '	<td class="rht">'+v.cnt.format()+' 건</td>';
						html += '	<td class="rht">'+v.sum_local_price.format()+' 원</td>';
						html += '	<td class="rht">'+v.sum_local_price_cash.format()+' 원</td>';
						html += '	<td>'+ba_seq+'</td>';
						html += '</tr>';
						*/
                            });
                            //console.log(html);

                            //$("#manage_customer_view_pc .customer_list_wrap").html("").html(html);
                        }else{
                            $("#loading").removeClass("actived");
                            alert(data.data+"("+data.code+")");
                            console.log(data.data);
                        }

                        console.log(pay_type_count1);
                        console.log(pay_type_count2);
                        console.log(pay_type_count3);
                        /*var  doughnutData = {
                            labels: [
                                '미용',
                                '호텔',
                                '유치원'
                            ],
                            datasets: [{
                                data: [pay_type_count1, pay_type_count2, pay_type_count3],
                                backgroundColor: [
                                    'rgb(253, 217, 78)',
                                    'rgb(255, 72, 72)',
                                    'rgb(104, 64, 177)'
                                ],
                                hoverBackgroundColor : [
                                    'rgb(253, 217, 78)',
                                    'rgb(255, 72, 72)',
                                    'rgb(104, 64, 177)'
                                ],
                                borderWidth:0,
                                hoverOffset: 0,
                                datalabels : {
                                    anchor : 'center'
                                }
                            }]
                        };

                        var doughnutConfig = {
                            //plugins:[ChartDataLabels],
                            type: 'doughnut',
                            data: doughnutData,
                            options:{
                                reponsive : true,
                                maintainAspectRatio : false,
                                cutoutPercentage :50,
                                title : {
                                    display:false
                                },
                                legend : {
                                    display:true
                                },
                                animation : false,
                                plugins:{
                                    labels : {
                                        render : 'value',
                                        fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'",
                                        fontSize : 14,
                                        fontColor : '#fff'
                                    }
                                }
                            }
                        };

                        var doughnutCtx = document.getElementById('doughnut');
                        var doughnut = new Chart(doughnutCtx , doughnutConfig);
                        */
                    },
                    error: function(xhr, status, error) {
                        //alert(error + "네트워크에러");
                        if(xhr.status != 0){
                            alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                        }
                    }
                });
            }

            console.log(artist_id+':'+search_btn)

        }

        function get_customer_count(artist_id){
            $.ajax({
                url: 'data/manage_customer_allview_ajax.php',
                data: {
                    mode: "get_customer_count",
                    artist_id: artist_id
                },
                type: 'POST',
                dataType: 'JSON',
                success: function(data) {
                    if(data.code == "000000"){
                        //console.log(data.data);
                        $("#manage_customer_view_pc .customer_count").text(data.data.format());
                        console.log(total_cnt);
                    }else{
                        alert(data.data+"("+data.code+")");
                        console.log(data.data);
                    }
                },
                error: function(xhr, status, error) {
                    //alert(error + "네트워크에러");
                    if(xhr.status != 0){
                        alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                    }
                }
            });
        }

        function get_customer_pet_count(artist_id){
            $.ajax({
                url: 'data/manage_customer_allview_ajax.php',
                data: {
                    mode: "get_customer_pet_count",
                    artist_id: artist_id
                },
                type: 'POST',
                dataType: 'JSON',
                success: function(data) {
                    if(data.code == "000000"){
                        //console.log(data.data);
                        $("#manage_customer_view_pc .pet_count").text(data.data.format());
                    }else{
                        alert(data.data+"("+data.code+")");
                        console.log(data.data);
                    }
                },
                error: function(xhr, status, error) {
                    //alert(error + "네트워크에러");
                    if(xhr.status != 0){
                        alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                    }
                }
            });
        }

        // 세자리 숫자 콤마
        Number.prototype.format = function() {
            if (this == 0) return 0;

            var reg = /(^[+-]?\d+)(\d{3})/;
            var n = (this + '');

            while (reg.test(n)) n = n.replace(reg, '$1' + ',' + '$2');

            return n;
        };

        // 문자열 타입에서 쓸 수 있도록 format() 함수 추가
        String.prototype.format = function() {
            var num = parseFloat(this);
            if (isNaN(num)) return "0";

            return num.format();
        };

        $(document).ready(function(){

            $('#header_bell').css('display','none');
            $('#btn_page_prev').prop('href','customer_inquiry');

        });

        // 개별 등급 수정 창
        function open_grade(pet_name, cellphone, grade_name, grade_ord){
            $('#memberGradeAddPop').find('.msg-txt').text('현재 '+pet_name+' ('+cellphone+')고객님의 등급은 '+grade_name+' 입니다.');
            $('#member_grade').val(grade_ord).prop("selected",true);
            popalert.open('memberGradeAddPop');
        }

        // 개별 등급 수정
        function set_grade(){
            var grade = $('#member_grade option:selected').val(); // 바꿀 등급
            var org_grade = '<?php echo $grade[0]['grade_idx'];?>'; // 기존 등급
            var id = '<?php echo $grade_id;?>';
            $.ajax({
                type : 'post',
                url : './data/get_book_data_ajax.php',
                data : {'mode':'gradeChange','grade':grade, 'id':id, 'org_grade':org_grade},
                dataType : 'json',
                success : function(json){
                    if(json.flag == true){
                        popalert.open('memberGradeComPop1','등급이 변경되었습니다.');
                    }
                }
            });
        }

        // 전체 고객 등급 변경
        function set_grade_all(){

            var grade = $('#member_grade_all option:selected').val(); // 바꿀 grade_idx
            var shop_id = '<?php echo $user_id; ?>'; // 샵 계정

            // customer_id, tmp_seq 가져오기
            $.ajax({
                type : 'post',
                url : './data/get_book_data_ajax.php',
                data : {'mode':'getAllGrade','id':shop_id},
                dataType : 'json',
                beforeSend: function(){
                    $("#loading").addClass("actived");
                },
                success : function(json){
                    if(json.flag == true){
                        console.log(json);
                        //console.log(json.sql.length);
                        $.each(json.sql, function(i, v){
                           //console.log(v);

                           // 등급설정하기
                            $.ajax({
                                type : 'post',
                                url : './data/get_book_data_ajax.php',
                                data : {'mode':'gradeChangeAll', 'grade':grade, 'shop_id':shop_id, 'grade_id':v},
                                dataType : 'json',
                                beforeSend: function(){
                                    $("#loading").addClass("actived");
                                },
                                success : function(data){
                                    if((i+1) == json.sql.length){
                                        $("#loading").removeClass("actived");
                                        pop.close();
                                        popalert.open('memberGradeComPop1','등급이 변경되었습니다.');
                                    }
                                }
                            });

                        });
                    }
                }
            });
        }
    </script>



    <!-- //container -->
    <script src="/static/pub/js/chart2/Chart.bundle.min.js"></script>
    <script src="/static/pub/js/chart2/chartjs-plugin-labels.js"></script>
    <script src="/static/pub/js/chart2/chartjs-chart-treemap@0.2.3.js"></script>
    <script>


    </script>


<?
//include($_SERVER['DOCUMENT_ROOT']."/include/skin/footer_shop.php");
?>
