<?
include($_SERVER['DOCUMENT_ROOT']."/include/global.php");

$artist_flag = (isset($_SESSION['artist_flag'])) ? $_SESSION['artist_flag'] : "";

if ($artist_flag === true) {
    $artist_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_name = (isset($_SESSION['shop_user_nickname'])) ? $_SESSION['shop_user_nickname'] : "";
} else {
    $artist_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_name = (isset($_SESSION['gobeauty_user_nickname'])) ? $_SESSION['gobeauty_user_nickname'] : "";
}

$yy = (isset($_GET['yy']) && $_GET['yy']) ? $_GET['yy'] : date('Y');
$mm = (isset($_GET['mm']) && $_GET['mm']) ? $_GET['mm'] : date('m');
$dd = (isset($_GET['dd']) && $_GET['dd']) ? $_GET['dd'] : date('d');



$shop_title	= "예약관리";
include($_SERVER['DOCUMENT_ROOT']."/include/skin/header_shop.php");
include($_SERVER['DOCUMENT_ROOT']."/include/check_login_shop.php");

?>

<?

$from = $_GET['from'];

$sql = array();
$data = array();
$wait_count = 0;

$ch = (isset($_GET['ch']) && $_GET['ch']) ? $_GET['ch'] : 'month';
$yy = (isset($_GET['yy']) && $_GET['yy']) ? $_GET['yy'] : date('Y');
$mm = (isset($_GET['mm']) && $_GET['mm']) ? $_GET['mm'] : date('m');
$dd = (isset($_GET['dd']) && $_GET['dd']) ? $_GET['dd'] : date('d');
$week = $_GET['week'];

$backurl = $_GET['backurl'];

$daily = array('일', '월', '화', '수', '목', '금', '토');
$selected_date = $yy . "-" . $mm . "-" . $dd;

$y_yy = date("Y", strtotime($selected_date . "-1day"));
$y_mm = date("m", strtotime($selected_date . "-1day"));
$y_dd = date("d", strtotime($selected_date . "-1day"));
$t_yy = date("Y", strtotime($selected_date . "+1day"));
$t_mm = date("m", strtotime($selected_date . "+1day"));
$t_dd = date("d", strtotime($selected_date . "+1day"));

// 오늘 날짜
$today_year = date("Y");
$today_month = date("m");
$today_day = date("d");

// var_dump($_SESSION);

$shop_sql = "select * from tb_shop where customer_id = '" . $user_id . "'";
$shop_result = mysqli_query($connection, $shop_sql);
if ($shop_datas = mysqli_fetch_object($shop_result)) {
    $front_image = $shop_datas->front_image;
    $name = $shop_datas->name;
    $working_years = $shop_datas->working_years;
    $self_introduction = $shop_datas->self_introduction;
    $professional_field = $shop_datas->professional_field;
    $career = $shop_datas->career;
    $license_indexs = $shop_datas->license_indexs;
    $region_and_cost = $shop_datas->region_and_cost;
    $enable_flag = $shop_datas->enable_flag;
    $update_time = $shop_datas->update_time;

    //----- 상담 대기 건수 조회
    $pet_sql =
        "SELECT count(tpl.payment_log_seq) AS wait_count
            FROM tb_payment_log tpl, tb_mypet tm, tb_customer tc
            WHERE tpl.approval = 0
            AND tpl.pet_seq = tm.pet_seq 
            AND tpl.customer_id = tc.id
			AND tc.enable_flag = 1
            AND timestampdiff(minute, update_time, now()) < 720
            AND tpl.artist_id = '{$user_id}'";
    $pet_result = mysqli_query($connection, $pet_sql);
    // error_log('----- $pet_sql : ' . $pet_sql);
    if ($pet_result_rows = mysqli_fetch_object($pet_result)) {
        $wait_count = $pet_result_rows->wait_count;
    }

    //크기 데이터,  상품 데이터
    $dog_static_query = "SELECT *, second_type AS product_type FROM tb_product_dog_static WHERE customer_id = '{$user_id}'";
    $dog_static_result = mysqli_query($connection, $dog_static_query);
    $dog_static_list = array();
	$dog_static_list2 = array(); // worktime
    $dog_service_list = array();
    while ($dog_static_data = mysqli_fetch_object($dog_static_result)) {
        $product_type = $dog_static_data->product_type;
        $dog_static_list[] = $product_type;

        $sanitation = $dog_static_data->sanitation_price;
        $bath = $dog_static_data->bath_price;
        $part = $dog_static_data->part_price;
        $bath_part = $dog_static_data->bath_part_price;
        $all = $dog_static_data->all_price;
        $spoting = $dog_static_data->spoting_price;
        $summercut = $dog_static_data->summercut_price;
        $scissors = $dog_static_data->scissors_price;

        if ($bath != null && $bath != "") {
            $dog_service_list[$product_type]["목욕"] = "목욕";
			$dog_static_list2[1] = "목욕";
        }

        if ($part != null && $part != "") {
            $dog_service_list[$product_type]["부분미용"] = "부분미용";
			$dog_static_list2[2] = "부분미용";
        }

        if ($bath_part != null && $bath_part != "") {
            $dog_service_list[$product_type]["부분+목욕"] = "부분+목욕";
			$dog_static_list2[3] = "부분+목욕";
        }

        if ($all != null && $all != "") {
            $dog_service_list[$product_type]["전체미용"] = "전체미용";
			$dog_static_list2[4] = "전체미용";
        }

        if ($spoting != null && $spoting != "") {
            $dog_service_list[$product_type]["스포팅"] = "스포팅";
			$dog_static_list2[5] = "스포팅";
        }

        if ($scissors != null && $scissors != "") {
            $dog_service_list[$product_type]["가위컷"] = "가위컷";
			$dog_static_list2[6] = "가위컷";
        }

		if ($sanitation != null && $sanitation != "") {
            $dog_service_list[$product_type]["위생"] = "위생";
			$dog_static_list2[7] = "위생";
        }

        if ($summercut != null && $summercut != "") {
            $dog_service_list[$product_type]["썸머컷"] = "썸머컷";
			$dog_static_list2[8] = "썸머컷";
        }

        // if (($sanitation != null && $sanitation != "") && ($summercut != null && $summercut != "")) {
        //     $dog_service_list[$product_type] = ["위생" => "위생", "목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "썸머컷" => "썸머컷", "가위컷" => "가위컷"];
        // } else if (($sanitation != null && $sanitation != "") && ($summercut == null || $summercut == "")) {
        //     $dog_service_list[$product_type] = ["위생" => "위생", "목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "가위컷" => "가위컷"];
        // } else if (($sanitation == null || $sanitation == "") && ($summercut != null && $summercut != "")) {
        //     $dog_service_list[$product_type] = ["목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "썸머컷" => "썸머컷", "가위컷" => "가위컷"];
        // } else {
        //     $dog_service_list[$product_type] = ["목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "가위컷" => "가위컷"];
        // }
    }

	$dog_worktime_query = "SELECT * FROM tb_product_dog_worktime WHERE artist_id = '".$user_id."' AND is_delete = '2' ";
	$dog_worktime_result = mysqli_query($connection, $dog_worktime_query);
	$dog_worktime_cnt = mysqli_num_rows($dog_worktime_result);
	$dog_worktime_list = array(); 
	$dog_worktime_txt = array("dog","목욕","부분미용","부분+목욕","전체미용","스포팅","가위컷","위생","썸머컷");
	// 순서대로 목욕,부분미용,부분+목욕,전체미용,스포팅,가위컷,위생,썸머컷
	if($dog_worktime_cnt > 0){
		while($dog_worktime_data = mysqli_fetch_assoc($dog_worktime_result)){
			for($_i = 1; $_i <= 8; $_i++){
				foreach($dog_static_list2 AS $key => $value){
					if($dog_worktime_txt[$_i] == $value){
						$dog_worktime_list[$value] = $dog_worktime_data["worktime".$_i];
					}
				}
			}
		}
	}else{
		$dog_worktime_list = array(
			"dog" => "dog",
			"목욕" => "120",
			"부분미용" => "120",
			"부분+목욕" => "120",
			"전체미용" => "120",
			"스포팅" => "120",
			"가위컷" => "120",
			"위생" => "120",
			"썸머컷" => "120"
		);
	}
	//print_r($dog_worktime_list);
    

    $cat_static_query = "SELECT * FROM tb_product_cat WHERE customer_id = '{$user_id}'";
    $cat_static_result = mysqli_query($connection, $cat_static_query);
    $cat_static_list = array();
    while ($cat_static_data = mysqli_fetch_object($cat_static_result)) {
        $cat_static_list[] = $cat_static_data->second_type;
        $cat_product = $cat_static_data;
    }

    //기타 상품 데이터
    $dog_etc_list = array();
    $dog_etc_query = "SELECT * FROM tb_product_dog_etc WHERE customer_id = '{$user_id}'";
    $dog_etc_result = mysqli_query($connection, $dog_etc_query);
    while ($dog_etc = mysqli_fetch_object($dog_etc_result)) {
        $dog_etc_list[] = $dog_etc;
    }

    $cat_etc_list = array();
    $cat_etc_query = "SELECT * FROM tb_product_cat_etc WHERE customer_id = '{$user_id}'";
    $cat_etc_result = mysqli_query($connection, $cat_etc_query);
    while ($cat_etc = mysqli_fetch_object($cat_etc_result)) {
        $cat_etc_list[] = $cat_etc;
    }

    //쿠폰 상품 데이터
    $coupon_list = array();
    $coupon_query = "SELECT * FROM tb_coupon WHERE customer_id = '{$user_id}' AND del_yn = 'N' ORDER BY reg_date";
    $coupon_result = mysqli_query($connection, $coupon_query);
    while ($coupon_data = mysqli_fetch_object($coupon_result)) {
        $coupon_list[] = $coupon_data;
    }
}
?>








<?php

$daily = array('일', '월', '화', '수', '목', '금', '토');
$month_list = array('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12');

$worker = $_GET['worker'] ? $_GET['worker'] : (($artist_flag === true) ? $_SESSION['shop_user_id'] : $_SESSION['gobeauty_user_id']);
$now = new DateTime($yy . '-' . $mm . '-' . $dd);
$now_date = date_format($now, 'Y-m-d');
$week_index = date_format($now, 'w');

$first_date = date('Y-m-d', strtotime($now_date . " -{$week_index} days")); // 주중 첫날
$last_date = date('Y-m-d', strtotime($first_date . " +6 days")); //  주중 마지막날

//미용사 체크
$check_query = "SELECT * FROM tb_artist_list WHERE `name` = '{$worker}' AND artist_id = '{$user_id}' AND is_view = '2' ";
$check_result = mysqli_query($connection, $check_query);
$check_cnt = mysqli_num_rows($check_result);

/* 현재 선택된 미용사의 정보를 가져온다. 2020-02-18 james */
$rs = mysqli_fetch_assoc($check_result);

if ($check_cnt <= 0) {
    $search_query = "SELECT * FROM tb_artist_list WHERE artist_id = '{$user_id}' AND is_view = '2' LIMIT 1";
    $search_result = mysqli_query($connection, $search_query);


    $search_data = mysqli_fetch_object($search_result);
    $worker = $search_data->name;
//    $artist['nicname'] = $search_data->nicname;

}



// 법정 공휴일 쉬는 여부 true가 쉰다.
$is_rest_public_holiday = false;
$working_sql = "select * from tb_working_schedule where customer_id = '" . $user_id . "';";
$working_result = mysqli_query($connection, $working_sql);
if ($working_datas = mysqli_fetch_object($working_result)) {
    $is_rest_public_holiday = ($working_datas->rest_public_holiday == 1) ? true : false;
}

// 공휴일
$holiday_arr = array();
$sql_public_holiday = "SELECT * FROM tb_public_holiday WHERE year = $yy AND month = $mm AND (day between DATE_FORMAT( '$first_date' , '%d' ) and DATE_FORMAT( '$last_date' , '%d' ))";
$sql_public_holiday_result = mysqli_query($connection, $sql_public_holiday);
while ($sql_public_holiday_row = mysqli_fetch_object($sql_public_holiday_result)) {
    if ($sql_public_holiday_row->day == $dd) {
        array_push($holiday_arr, $sql_public_holiday_row->day);
    }
}

// 2019.01.08 developlay - 휴식시간 설정 [START]
// $ph_sql = "SELECT * FROM `tb_private_holiday` 
//             WHERE customer_id = '{$user_id}' 
//             AND start_year = {$weekend_year[1]} 
//             AND start_month = {$weekend_month[1]}";
//             error_log('----- $ph_sql : '.$ph_sql);
// $ph_result = mysqli_query($connection, $ph_sql);
// while ($ph_datas = mysqli_fetch_object($ph_result)) {
// }
// 2019.01.08 developlay - 휴식시간 설정 [END]

// 일일 오픈시간과 종료시간을 가지고 온다. [START]
$sql['working_schedule'] = "select * from tb_working_schedule where customer_id='{$artist_id}'";
$result['working_schedule'] = mysqli_query($connection, $sql['working_schedule']);
$rows['working_schedule'] = mysqli_fetch_object($result['working_schedule']);

$time_open = $rows['working_schedule']->working_start; // 오픈시간
$time_close = $rows['working_schedule']->working_end; // 종료시간
// 일일 오픈시간과 종료시간을 가지고 온다. [END]

// 예약중건 추출
$data['reservation'] = array();
$sql['reservation'] = "SELECT
    res.* ,
    DATE_FORMAT( CONCAT( res.year,'-',res.month,'-',res.day,' ',res.hour,':',IFNULL(res.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_start
FROM
    `tb_reservation` res
WHERE
    1
    AND res.artist_id = '{$artist_id}'
    AND res.worker='{$worker}'
    AND DATE_FORMAT( CONCAT( res.year,'-',res.month,'-',res.day,' ',res.hour,':',IFNULL(res.minute,'00'),':00' ), '%Y-%m-%d' ) >= DATE_FORMAT( '$first_date' , '%Y-%m-%d' )
    AND DATE_FORMAT( CONCAT( res.year,'-',res.month,'-',res.day,' ',res.hour,':',IFNULL(res.minute,'00'),':00' ), '%Y-%m-%d' ) <= DATE_FORMAT( '$last_date' , '%Y-%m-%d' )
    AND res.update_time > DATE_ADD(now(), INTERVAL -10 MINUTE )
";
//echo $sql['reservation'];
$result = mysqli_query($connection, $sql['reservation']);
while ($rows = mysqli_fetch_assoc($result)) {
    if ($worker = $rows['worker']) {
        $dateFull =  $rows['res_time_start'] . ":00";
        $date =  date('Y-m-d', strtotime($dateFull));
        $time =  date('H:i', strtotime($dateFull));
        // echo '<Br/>';
        // $now = date_create($date);
        // $time = date_format($now, "H:i");

        $data['reservation'][$date][$time]['data'] = $reservation[$date][$time]['data'] = $rows; // 예약중인 건에 대한 정보

        $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($rows['res_time_start']))));
        $time_end =  $time_start + (int) ($rows['rowspan'] * (60 * 30));
        $time_full = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);

        $time_block_cnt = $time_full / (60 * 30); // 블럭갯수

        $rowspan['reservation'][$date][$time]['count'] = $time_block_cnt;

        for ($h = $time_start; $h < $time_end; $h += (60 * 30)) {
            // echo $h;
            $rowspan['reservation'][$date][$time]['time'][] = date('H:i', $h);
            $reservation_artist[$firstTime]['time'];
            $data['reservation'][$date][$time]['time'][] = $reservation[$date][$time]['time'][] = date('H:i', $h); // 각 시간대 저장
        }

        // $data['reservation'][(string)$rows_day][(string)$rows_time] = $payment_log;
    }
}

// echo '<pre>';
// var_dump($data['reservation']);
// var_dump($rowspan['reservation']);
// echo '</pre>';

// 결제예약 정보 [START]
$sql['payment'] = "SELECT
    pay.* ,
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_date ,
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_start ,
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.to_hour,':',IFNULL(pay.to_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_end
FROM 
    `tb_payment_log` AS pay
WHERE
    1
    AND pay.artist_id='{$artist_id}'
    AND pay.worker='{$worker}'
    AND pay.is_cancel=0
	AND pay.data_delete = '0'
    AND DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d' ) >= DATE_FORMAT( '$first_date' , '%Y-%m-%d' )
    AND DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d' ) <= DATE_FORMAT( '$last_date' , '%Y-%m-%d' )
";
$result = mysqli_query($connection, $sql['payment']);
while ($rows = mysqli_fetch_object($result)) {
    // $rows_rowspan = $rows->rowspan;
    $rows_my_order = $rows->my_order;
    $rows_session_id = $rows->session_id;

    $date = date('Y-m-d', strtotime($rows->res_date));
    $time = date('H:i', strtotime($rows->res_date));

    $datetime1 = new DateTime($rows->res_time_start);
    $datetime2 = new DateTime($rows->res_time_end);
    $interval = $datetime2->diff($datetime1);
    // echo ( $interval->format('%h') * 60 ) / 30 ;
    // $resTime = date('H:i',strtotime($rows->res_time_start .' +'.($t*30).' minute'));
    // $rowspan_count = ( $interval->format('%h') * 60 ) / 30;

    // $data['payment_log'][(string)$rows_day][(string)$rows_time] = $payment_log;
    $payment_log = array(
        'session_id' => $rows->session_id,
        'order_id' => $rows->order_id,
        'payment_log_seq' => $rows->payment_log_seq,
        'cellphone' => $rows->cellphone,
        'customer_id' => $rows->customer_id,
        'is_no_show' => $rows->is_no_show,
        // 'rowspan'=>$rowspan_count ,
        'product' => $rows->product,
		'pet_seq' => $rows->pet_seq,
        'res_date' => $rows->res_date,
        'status' => $rows->status,
        'local_price' => $rows->local_price,
		'local_price_cash' => $rows->local_price_cash,
        'pay_type' => $rows->pay_type,
        'res_time_start' => $rows->res_time_start,
        'res_time_end' => $rows->res_time_end,
		'is_confirm' => $rows->is_confirm,
        'product_arr' => explode('|', $rows->product),
        'between_hour' => $interval->format('%h')
    );

    $data['payment'][$date][$time]['data'] = $payment[$date][$time]['data'] = $payment_log; // 예약중인 건에 대한 정보

    $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($rows->res_time_start))));
    $time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($rows->res_time_end))));
    // $time_end =  $time_start + (int)( $rows['rowspan'] * (60*30));
    $time_full = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);

    $time_block_cnt = $time_full / (60 * 30); // 블럭갯수

    $rowspan['payment'][$date][$time]['count'] = $time_block_cnt;

    for ($h = $time_start; $h < $time_end; $h += (60 * 30)) {
        // echo $h;
        $rowspan['payment'][$date][$time]['time'][] = date('H:i', $h);
        $payment_artist[$firstTime]['time'];
        $data['payment'][$date][$time]['time'][] = $payment[$date][$time]['time'][] = date('H:i', $h); // 각 시간대 저장
    }

    // $data['payment_log'][(string)$rows_day][(string)$rows_time] = $payment_log;
}
// 결제예약 정보 [END]

// echo '<pre>';
// var_dump($data['payment']);
// echo '</pre>';


// 2019.01.07 developlay - 요일별 휴일여부 추출 [START]
$holiweek_arr = array();
$sql_regular = "select * from tb_regular_holiday where customer_id = '" . $artist_id . "';";
$sql_regular_result = mysqli_query($connection, $sql_regular);
if ($sql_regular_row = mysqli_fetch_object($sql_regular_result)) {
    $holiweek_arr[0] = $sql_regular_row->is_sunday;
    $holiweek_arr[1] = $sql_regular_row->is_monday;
    $holiweek_arr[2] = $sql_regular_row->is_tuesday;
    $holiweek_arr[3] = $sql_regular_row->is_wednesday;
    $holiweek_arr[4] = $sql_regular_row->is_thursday;
    $holiweek_arr[5] = $sql_regular_row->is_friday;
    $holiweek_arr[6] = $sql_regular_row->is_saturday;
}
// 2019.01.07 developlay - 요일별 휴일여부 추출 [END]

$date_week_list = array();

for ($w = 0; $w <= 6; $w++) {
    $next_date = date('Y-m-d', strtotime($first_date . " +{$w}days"));

    $next_year = date('Y', strtotime($first_date . " +{$w}days"));
    $next_month = date('m', strtotime($first_date . " +{$w}days"));
    $next_day = date('d', strtotime($first_date . " +{$w}days"));
    $next_hour = date('H', strtotime($first_date . " +{$w}days"));
    $next_minute = date('i', strtotime($first_date . " +{$w}days"));
    $date_week_list[$next_date] = array();

    // 일일 오픈시간과 종료시간을 가지고 온다.
    $sql = "select * from tb_working_schedule where customer_id='{$artist_id}'";
    $result = mysqli_query($connection, $sql);
    $rows = mysqli_fetch_object($result);
    $order_my = isset($order_my) ? $order_my : array();
    ksort($order_my);
    // echo '<pre>';
    // var_dump($order_my);
    // echo '</pre>';

    $date_week_list[$next_date] = array();
    $date_week_list[$next_date]['working_start'] =  $rows_working_start = $rows->working_start;
    $date_week_list[$next_date]['working_end'] = $rows_working_end = $rows->working_end;
    // var_dump($date_week_list[$next_date]);

    $sql = "
    SELECT 
        res.* 
        , pay.order_id
        , pay.payment_log_seq
    FROM 
        `tb_reservation` res 
        LEFT JOIN `tb_payment_log` pay on ( pay.session_id=res.session_id )
    WHERE 
        1
        and res.artist_id = '{$_SESSION['gobeauty_cart_artist_id']}'
        and res.year = '{$next_year}'
        and res.month = '{$next_month}'
        and res.day = '{$next_day}'
        and res.worker = '{$worker}'
    ";
    $result = mysqli_query($connection, $sql);
    $date_week_list[$next_date]['reservation'] = array();
    while ($rows = mysqli_fetch_object($result)) {
        // var_dump($rows);


        // var_dump($rows);
        $rows_year = $rows->year;
        $rows_month = $rows->month;
        $rows_day = $rows->day;
        $rows_hour = $rows->hour;
        $rows_minute = $rows->minute;
        $rows_rowspan = $rows->rowspan;
        $rows_my_order = $rows->my_order;
        $rows_session_id = $rows->session_id;

        $date =  $rows_year . '-' . $rows_month . '-' . $rows_day . ' ' . $rows_hour . ":" . $rows_minute . ":00";
        // echo '<Br/>';
        $now = date_create($date);
        $time = date_format($now, "H:i");

        $date_week_list[$next_date]['reservation'][] = $time;

        $reservation[$time][] = $time;
        $rowspan[$time] = $rows_rowspan;
        $session_id[$time] = $rows_session_id;
        if ($rows_my_order) $order_my[$time][] = $time;
        for ($t = 0; $t < $rows->rowspan - 1; $t++) {
            // echo $t.'<br/>';
            $date_add = date_add($now, date_interval_create_from_date_string("30 minutes"));
            $reservation[$time][] = date_format($date_add, "H:i");
            if ($rows_my_order) $order_my[$time][] = date_format($date_add, "H:i");
        }
    }
}

// 일일 오픈시간과 종료시간을 가지고 온다.
$sql = "select * from tb_working_schedule where customer_id='{$artist_id}'";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);
ksort($order_my);

$data['week_time'] = array();
$data['week_time']['working_start'] = $rows->working_start;
$data['week_time']['working_end'] = $rows->working_end;
// var_dump( $data['week_time'] );

// 2019.01.07 developlay - 요일별 휴일여부 추출 [START]
$data['holiweek'] = array();
$sql_holiweek = "SELECT * FROM tb_regular_holiday WHERE customer_id = '" . $artist_id . "';";
$result_holiweek = mysqli_query($connection, $sql_holiweek);
if ($rows = mysqli_fetch_object($result_holiweek)) {
    $data['holiweek'][0] = $rows->is_sunday;
    $data['holiweek'][1] = $rows->is_monday;
    $data['holiweek'][2] = $rows->is_tuesday;
    $data['holiweek'][3] = $rows->is_wednesday;
    $data['holiweek'][4] = $rows->is_thursday;
    $data['holiweek'][5] = $rows->is_friday;
    $data['holiweek'][6] = $rows->is_saturday;
}
// 2019.01.07 developlay - 요일별 휴일여부 추출 [END]



// 임시휴일[START]
$data['private_holiday'] = array();


/** ----- $last_date_custom를 만든 이유
 * 주간 일정에서 토요일의 임시휴일(예약방지)이 표시되지 않았고
 * 해당 문제는 아래의 $sql_private_holiday 쿼리의 결과가 금요일까지만
 * 출력되기 때문에 발생.
 * 
 * 기존 $last_date를 변경 시
 * 이를 사용하는 다른 기능에서 문제가 발생할 수 있기에
 * 
 * 임시로 해당 쿼리에서만 $last_date_custom를 사용하여
 * 출력 범위를 하루 더 추가한 +7일로 변경하여 문제를 해결.
 * 
 * 차후 다른 기능에서도 문제가 발생하는지 확인이 필요.
 */
$last_date_custom = date('Y-m-d', strtotime($first_date . " +7 days"));

$sql_private_holiday = "SELECT * FROM(
        SELECT 
            pholiday.* ,
		    DATE_FORMAT( CONCAT( pholiday.start_year,'-',pholiday.start_month,'-',pholiday.start_day,' ',pholiday.start_hour,':',IFNULL(pholiday.start_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) pri_start_date ,
		    DATE_FORMAT( CONCAT( pholiday.end_year,'-',pholiday.end_month,'-',pholiday.end_day,' ',IF(pholiday.end_hour = 24 AND (pholiday.end_minute IS NULL OR pholiday.end_minute = 0), '23', pholiday.end_hour),':',IF(pholiday.end_hour = 24 AND pholiday.end_minute IS NULL, '59', IFNULL('00',pholiday.end_minute)),':00' ), '%Y-%m-%d %H:%i' ) pri_end_date ,
		    DATE_FORMAT( CONCAT( pholiday.start_year,'-',pholiday.start_month,'-',pholiday.start_day,' ',pholiday.start_hour,':',IFNULL(pholiday.start_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) pri_start_time ,
		    DATE_FORMAT( CONCAT( pholiday.end_year,'-',pholiday.end_month,'-',pholiday.end_day,' ',IF(pholiday.end_hour = 24 AND (pholiday.end_minute IS NULL OR pholiday.end_minute = 0), '23', pholiday.end_hour),':',IF(pholiday.end_hour = 24 AND pholiday.end_minute IS NULL, '59', IFNULL('00',pholiday.end_minute)),':00' ), '%Y-%m-%d %H:%i' ) pri_end_time
        FROM tb_private_holiday pholiday 
    )A
    WHERE 
        A.customer_id='{$artist_id}'
        AND A.worker='{$worker}'
        AND A.pri_start_date >= DATE_FORMAT( '$first_date' , '%Y-%m-%d' )
        AND A.pri_end_date <= DATE_FORMAT( '$last_date_custom' , '%Y-%m-%d' )
";
// error_log('----- $sql_private_holiday : ' . $sql_private_holiday);
$result_private_holiday = mysqli_query($connection, $sql_private_holiday);
while ($rows = mysqli_fetch_assoc($result_private_holiday)) {

    $date = date('Y-m-d', strtotime($rows['pri_start_date']));
    // error_log('----- $date : ' . $date);
    $time = date('H:i', strtotime($rows['pri_start_date']));
    // error_log('----- $time : ' . $time);
    $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($rows['pri_start_date']))));
    $time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($rows['pri_end_date']))));

    $sec = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);
    $time_block_cnt = $sec / (60 * 30); // 블럭갯수

    $data['private_holiday']['data'][$date][$time] = $rows;
    $data['private_holiday']['count'][$date][$time] = $time_block_cnt;

    for ($h = $time_start; $h < $time_end; $h += (60 * 30)) {
        $private[$date][] = date('H:i', $h);
    }

    $data['private_holiday']['time'] = $private;
}
// echo '<pre>';
// var_dump($data['private_holiday']);
// echo '</pre>';

// echo $first_stamp = date2timestamp($first_date);
// echo $first_date;
// echo $last_date;
$first_stamp = date2timestamp(strtotime($first_date));
$last_stamp  = date2timestamp(strtotime($last_date));
for ($d = $first_stamp; $d <= $last_stamp; $d += (60 * 60 * 24)) {
    $w = date('w', $d);
    $sql_artist_list = "SELECT 
        *
    FROM 
        `tb_artist_list` artist
    WHERE 
        artist.artist_id='{$artist_id}' 
        AND name='{$worker}'
        AND week={$w}
		AND is_view = '2'
    ";
    $result_artist_list = mysqli_query($connection, $sql_artist_list);
    while ($rows = mysqli_fetch_assoc($result_artist_list)) {
        $time_start = date2timestamp(strtotime(date('Y-m-d', $d) . ' ' . $rows['time_start']));
        $time_end = date2timestamp(strtotime(date('Y-m-d', $d) . ' ' . $rows['time_end']));

        for ($h = $time_start; $h < $time_end; $h += (60 * 30)) {
            $artist_list[$rows['week']][] = date('H:i', $h);
        }

        $data['artist_list']['time'] = $artist_list;
    }
}

// 2020.04.08 ulmo 예약 스케줄 운영방식 선택
$sql = "select * from tb_time_schedule where artist_id = '{$artist_id}' ";

$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);

$data["time_schedule"] = array();
$data["time_schedule"]["res_time_off"] = $rows->res_time_off;

$sql = "select is_time_type from tb_shop where customer_id = '{$artist_id}' ";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);

$data["time_schedule"]["is_time_type"] = $rows->is_time_type;


// echo '<pre>';
// var_dump($data['artist_list']['time']);
// echo '</pre>';


$sql = " SELECT * FROM `tb_artist_list` WHERE artist_id='{$artist_id}' AND is_view = '2' AND is_out = '2' GROUP BY name ORDER BY sequ_prnt asc, is_main DESC, nicname ASC";
//echo $sql;

$result = mysqli_query($connection, $sql);
$artist_data    = array();
while ($artist_rows = mysqli_fetch_assoc($result)) {
    $artist_data[]  = $artist_rows;
}

?>


<!-- container -->
<section id="container">
    <!-- page-body -->
    <div class="page-body">
        <div class="reserve-calendar-wrap">
            <button type="button" onclick="location.href='reserve_time_sale_step1_3'" class="btn btn-outline-purple btn-middle-size btn-round">빈시간 판매하기</button>
            <!-- 캘린더 정렬 -->
            <div class="reserve-calendar-sort">
                <div class="sort-left">
                    <!-- actived클래스 추가시 활성화 -->
                    <button type="button" onclick="location.href='reserve_main_month?ch=month&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                        class="btn-reserve-calendar-sort">월</button>
                    <button type="button" onclick="location.href='reserve_main_week?ch=week&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                        class="btn-reserve-calendar-sort actived">주</button>
                    <button type="button" onclick="location.href='reserve_main_day?ch=day&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                        class="btn-reserve-calendar-sort">일</button>
                    <button type="button" onclick="location.href='reserve_main_list?ch=list&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                        class="btn-reserve-calendar-sort"><span class="icon icon-type-list-gray off"></span><span
                            class="icon icon-type-list-white on"></span></button>
                </div>
                <div class="sort-right">
                    <select>
                        <option value="beauty" selected>미용</option>
                        <option value="hotel">호텔</option>
                        <option value="playroom">유치원</option>
                    </select>
                </div>
            </div>
            <!-- //캘린더 정렬 -->
            <!-- 캘린더 상단 -->
            <div class="reserve-calendar-top">
                <button type="button" class="btn-reserve-calendar-ui btn-month-prev"><span
                        class="icon icon-calendar-prev-small"></span></button>
                <div class="reserve-calendar-title">
                    <!--
                    <div class="txt"></div>
                    <select>
                        <?for($i=0;$i<48;$i++){?>
                        <option value="<?=date("Y.m", mktime(0, 0, 0, date("m")-$i, date("d"),   date("Y")))?>"><?=date("Y.m", mktime(0, 0, 0, date("m")-$i, date("d"),   date("Y")))?></option>
                        <?}?>
                    </select>
                        -->

                    <div class="txt"></div>
					<select>
                        <?for($i=-48;$i<0;$i++){?>
						<option value="<?= (int) date('Y', strtotime($first_date)-86400*7*$i) ?>.<?= (int) date('m', strtotime($first_date)-86400*7*$i) ?>.<?= (int) date('d', strtotime($first_date)-86400*7*$i) ?>" data-rol1="<?= date('m.d', strtotime($first_date)-86400*7*$i) ?>" data-rol2="<?= date('m.d', strtotime($last_date)-86400*7*$i) ?>"><?= (int) date('m', strtotime($first_date)-86400*7*$i) ?>월 <?= (int) date('d', strtotime($first_date)-86400*7*$i) ?>일 ~
					<?= (int) date('m', strtotime($last_date)-86400*7*$i) ?>월 <?= (int) date('d', strtotime($last_date)-86400*7*$i) ?>일</option>
						<?}?>
                        <?for($i=0;$i<48;$i++){?>
						<option <?if($i==0) echo "selected";?> value="<?= (int) date('Y', strtotime($first_date)-86400*7*$i) ?>.<?= (int) date('m', strtotime($first_date)-86400*7*$i) ?>.<?= (int) date('d', strtotime($first_date)-86400*7*$i) ?>" data-rol1="<?= date('m.d', strtotime($first_date)-86400*7*$i) ?>" data-rol2="<?= date('m.d', strtotime($last_date)-86400*7*$i) ?>"><?= (int) date('m', strtotime($first_date)-86400*7*$i) ?>월 <?= (int) date('d', strtotime($first_date)-86400*7*$i) ?>일 ~
					<?= (int) date('m', strtotime($last_date)-86400*7*$i) ?>월 <?= (int) date('d', strtotime($last_date)-86400*7*$i) ?>일</option>
						<?}?>
					</select>
                </div>
                <button type="button" class="btn-reserve-calendar-ui btn-month-next"><span
                        class="icon icon-calendar-next-small"></span></button>

                
            </div>
			<!-- //캘린더 상단 -->
			<div class="reserve-calendar-master">
				<div class="grid-layout btn-grid-group">
					<div class="grid-layout-inner">
						<!-- btn-toggle-button 클래스에 actived클래스 추가시 활성화 -->
                        <?
                        foreach($artist_data as $key => $val){?>
						<div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button <?= trim($worker) == trim($val['name']) ? 'actived' : '' ?>" onclick="location.href='?ch=<?= $ch ?>&yy=<?= $yy ?>&mm=<?= $mm ?>&dd=<?= $dd ?>&worker=<?= trim($val['name']) ?>';"><?= $val['nicname'] ?> <?=($val['is_out'] == '1')? '퇴사' : '' ?></button></div>
                        <?}?>
						<div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button btn-toggle-basic" onclick="location.href='set_teacher';"><span class="icon icon-plus-more-small"></span></button></div>
					</div>
				</div>
			</div>
			<!-- 캘린더 라벨 -->
			<div class="reserve-calendar-label">
				<div class="reserve-calendar-label-info">* 접수는 빈칸 클릭!</div>
				<div class="grid-layout reserve-calendar-label-group">
					<div class="grid-layout-inner">
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state yellow"></div>앱-선결제</div></div>
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state purple"></div>앱-매장결제</div></div>
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state green"></div>매장예약</div></div>
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state red"></div>NoShow</div></div>
					</div>
				</div>	
			</div>
			<!-- //캘린더 라벨 -->
			<!-- 캘린더 상세 -->
			<div>
				<div class="reserve-calendar-data">
					<div class="reserve-calendar-inner">
                        <input type="hidden" id="bjj_year" value="" />
                        <input type="hidden" id="bjj_month" value="" />
                        <input type="hidden" id="bjj_day" value="" />
                        <input type="hidden" id="bjj_time" value="" />
                        <input type="hidden" id="bjj_time2" value="" />
                        <input type="hidden" id="bjj_worker" value="" />
						<!--
						// calendar-month-header-col 클래스 정의
						//	sunday : 일요일
						//	saturday : 토요일

						// calendar-month-body-col 클래스 정의
						//	sunday : 일요일
						//	saturday : 토요일
						//	break : 휴무 및 예약금지
						//	holiday :공휴일
						// today : 오늘
						// calendar-drag-item-group : 드래그 가능한 영역
						// calendar-drag-item : 드래그 아이템
						-->
						<!--
						// calendar-week-time-item 상황별 클래스값
						// yellow : 앱-선결제
						// purple : 앱-매장결제
						// green : 매장예약
						// red : NoShow
						// gray : 승인대기
						-->

						<div class="calendar-week-wrap">
							<div class="calendar-week-header">
								<div class="calendar-week-header-row">
									<div class="calendar-week-header-col time"></div>
                                    <?php foreach ($date_week_list as $key => $val) { ?>
									<div class="calendar-week-header-col <? if (date('Y-m-d', strtotime($key)) == date('Y-m-d')) { ?>today<? } ?>"><div class="th"><?= $daily[date('w', strtotime($key))] ?></div><div class="day"><a href="reserve_main_day?ch=day&yy=<?= date('Y', strtotime($key)) ?>&mm=<?= date('m', strtotime($key)) ?>&dd=<?= date('d', strtotime($key)) ?>&backurl=<?= urlencode($_SERVER['PHP_SELF']) ?>" class="text_day" style=""><?= (int) date('d', strtotime($key)) ?></a></div></div>
                                    <?}?>
									
								</div>
							</div>
                            




							<div class="calendar-week-body">
                                <?php for ($h = $time_open; $h < $time_close; $h++) { ?>
                                    <?php $week_day = substr($first_date,8,2); $cnt = 0; for ($t30 = 0; $t30 < 60; $t30 += 30) {
                                        $thisTime = sprintf('%02d', $h) . ":" . sprintf('%02d', $t30); ?>
                                            <div class="calendar-week-body-row">
                                                <div class="calendar-week-body-col time">
                                                    <div class="day-division-label"></div>
                                                    <div class="time-label"><div class="time-start-label"><?=$thisTime?></div><div class="time-end-label"><?= date('H:i', strtotime($thisTime . ' +30 minutes')) ?></div></div>								
                                                </div>
                                                <?php foreach ($date_week_list as $key => $val) { 
                                                    $holiday_1  = "";
                                                    $reserv_text    = "";
                                                    $div_class  = "";
                                                    $print_work = false;



                                                    if ($holiweek_arr[(int) date('w', strtotime($key))] == 1) {
                                                        $datetime1 = new DateTime(date('Y-m-d ') . $time_open . date(':00:00'));
                                                        $datetime2 = new DateTime(date('Y-m-d ') . $time_close . date(':00:00'));
                                                        $interval = $datetime2->diff($datetime1);
                                                        $open_time_count = ($interval->format('%h') * 60) / 30;

                                                        $holiday_1  = "정기휴일";
                                                        $div_class  = "break";
                                                    }

                                                    //공휴일
                                                    if ($is_rest_public_holiday && in_array(date('d', strtotime($key)), $holiday_arr)) {
                                                        $datetime1 = new DateTime(date('Y-m-d ') . $time_open . date(':00:00'));
                                                        $datetime2 = new DateTime(date('Y-m-d ') . $time_close . date(':00:00'));
                                                        $interval = $datetime2->diff($datetime1);
                                                        $open_time_count = ($interval->format('%h') * 60) / 30;
                                                        $holiday_1  = "공휴일";
                                                        $div_class  = "break";
                                                    }



                                                    $thisTime = sprintf('%02d', $h) . ":" . sprintf('%02d', $t30);
                                                    $thisTimeTo = date('H:i', date2timestamp(strtotime(date('Y-m-d H:i', strtotime($thisDate . ' ' . $thisTime)))));
                                                    $thisTimeFrom = date('H:i', date2timestamp(strtotime(date('Y-m-d H:i', strtotime($thisDate . ' ' . $thisTime)))) + (60 * 30));
                                                    $thisDataPaymentLog = $data['payment'][$key][$thisTime]['data'];
                                                    $thisDataReservation = $data['reservation'][$key][$thisTime]['data'];
                                                    // if ( !is_null($thisDataReservation) ) var_dump($thisDataReservation);

                                                    // var_dump($rowspan['reservation']);
                                                    // var_dump($rowspan['reservation'][$key][$thisTime]['time']);

                                                    $data['private_holiday']['time'][$key] = isset($data['private_holiday']['time'][$key]) ? $data['private_holiday']['time'][$key] : array();
                                                    $data['payment'][$key][$thisTime]['time'] = isset($data['payment'][$key][$thisTime]['time']) ? $data['payment'][$key][$thisTime]['time'] : array();
                                                    $data['reservation'][$key][$thisTime]['time'] = isset($data['reservation'][$key][$thisTime]['time']) ? $data['reservation'][$key][$thisTime]['time'] : array();
                                                    $data['artist_list']['time'][(int) date('w', strtotime($key))] = $data['artist_list']['time'][(int) date('w', strtotime($key))] ? $data['artist_list']['time'][(int) date('w', strtotime($key))] : array();

                                                    if (in_array($thisTime, $data['private_holiday']['time'][$key])) {
                                                        $firstTime = $thisTime;
                                                    } else
                                                    if (in_array($thisTime, $data['payment'][$key][$thisTime]['time'])) {
                                                        $firstTime = $thisTime;
                                                    } else
                                                    if (in_array($thisTime, $data['reservation'][$key][$thisTime]['time'])) {
                                                        $firstTime = $thisTime;
                                                    }
                                                    // echo $firstTime;
                                                    // var_dump($data['artist_list']['time'][(int)date('w',strtotime($key))]);

                                                    // 2020.04.10 ulmo 타임제 선택시 구분선 출력
                                                    $css_line = '';
                                                    if($data["time_schedule"]["is_time_type"] == "2" && strpos($data["time_schedule"]["res_time_off"], $thisTimeTo."~".$thisTimeFrom) !== false){
                                                        // 타임제 선택시 비활성화
                                                        $css_line = 'time';
                                                    }

                                                    if(!in_array($thisTime, $data['artist_list']['time'][(int) date('w', strtotime($key))])){
                                                        $css_line = 'not2 '.$css_line;
                                                    }

                                                    $color = '';

                                                    $data['payment'][$key][$firstTime]['time'] = isset($data['payment'][$key][$firstTime]['time']) ? $data['payment'][$key][$firstTime]['time'] : array();
                                                    $data['reservation'][$key][$firstTime]['time'] = isset($data['reservation'][$key][$firstTime]['time']) ? $data['reservation'][$key][$firstTime]['time'] : array();

                                                    if (in_array($thisTime, $data['private_holiday']['time'][$key])) {
                                                        // var_dump($data['private_holiday']['time'][$key]);
                                                        // var_dump($data['private_holiday']['time']);
                                                        // var_dump($data['private_holiday']['data'][$key]['ph_seq']);
                                                        $ph_seq = $data['private_holiday']['data'][$key][$thisTime]['ph_seq'];
                                                        $ph_count = $data['private_holiday']['count'][$key][$thisTime];
                                                        $ph_height = (int) $ph_count * 40;
                                                        if ($ph_seq) {
                                                            $reserv_text    = "예약금지";
                                                        }
                                                    
                                                    } else if (in_array($thisTime, $data['payment'][$key][$firstTime]['time'])) {
                                                        // var_dump($thisDataPaymentLog);
                                                        $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($thisDataPaymentLog['res_time_start']))));
                                                        $time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($thisDataPaymentLog['res_time_end']))));
                                                        $time = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);
                                                        $time_block_cnt = $time / (60 * 30); // 블럭갯수

                                                        if (array_search($thisTime, $data['payment'][$key][$firstTime]['time']) == 0) {

                                                            $pay_type = $thisDataPaymentLog['pay_type'];
                                                            $is_no_show = $thisDataPaymentLog['is_no_show'];
                                                            $status = $thisDataPaymentLog['status'];
                                                            $local_price = $thisDataPaymentLog['local_price'];
                                                            $local_price_cash = $thisDataPaymentLog['local_price_cash'];
                                                            $is_confirm = $thisDataPaymentLog['is_confirm'];
                                                            $style_height = 100 * (int) $time_block_cnt;
                                                            $pet_name = $thisDataPaymentLog['product_arr'][0];
                                                            $local_price_txt2 = ($local_price+$local_price_cash > 0)? "<br/><span>".($local_price+$local_price_cash)."</span>" : "";
                                                            // 20200720 ulmo 미용내역+견종 화면 추가표시
                                                            $product_arr_list = array(
                                                                "목욕" => "목욕",
                                                                "부분미용" => "부분",
                                                                "부분+목욕" => "부목",
                                                                "전체미용" => "전체",
                                                                "스포팅" => "스포",
                                                                "가위컷" => "가위",
                                                                "위생" => "위생",
                                                                "썸머컷" => "썸머"
                                                            );
                                                            $temp_result = mysqli_query($connection, "select pet_type from tb_mypet where pet_seq = '".$thisDataPaymentLog['pet_seq']."' ");
                                                            $temp_row = mysqli_fetch_assoc($temp_result);
                                                            $pet_type = ($temp_row["pet_type"] != "")? "<br/><span>".mb_substr($temp_row["pet_type"],0,3,"UTF-8")."</span>" : "";
                                                            $service_type_dog = ($thisDataPaymentLog['product_arr'][1] == "개" && $thisDataPaymentLog['product_arr'][4] != "")? "<br/><span>".$product_arr_list[$thisDataPaymentLog['product_arr'][4]]."</span>" : "";
                                                            //$service_type_dog = ($product_arr_list[$thisDataPaymentLog['product_arr'][4]] == "전체")? "" : $service_type_dog;
                                                            $service_height = 24;
                                                            $service_height += ($temp_row["pet_type"] != "")? 18 : 0;
                                                            $service_height += ($product_arr[1] == "개" && $product_arr[4] != "")? 18 : 0;
                                                            $service_height += ($local_price_txt2 != "")? 18 : 0;

                                                            if($thisDataPaymentLog['pet_seq'] != "" && $user_id != ""){
                                                                $temp_sql = "
                                                                    SELECT *
                                                                    FROM tb_artist_customer_list
                                                                    WHERE artist_id = '".$user_id."'
                                                                        AND pet_seq = '".$thisDataPaymentLog['pet_seq']."'
                                                                ";

                                                                $temp_result = mysqli_query($connection, $temp_sql);
                                                                $temp_row = mysqli_fetch_array($temp_result);
                                                                $ac_cnt = mysqli_num_rows($temp_result);
                                                                if($ac_cnt != 0){ // change pet_name
                                                                    $pet_name = ($temp_row["pet_name"] != "")? $temp_row["pet_name"] : $pet_name;
                                                                }else{
                                                                    $temp_result = mysqli_query($connection, "select name from tb_mypet where pet_seq = '".$thisDataPaymentLog['pet_seq']."' ");
                                                                    $temp_row = mysqli_fetch_array($temp_result);
                                                                    $pet_name = ($temp_row['name'] != "" )? $temp_row['name'] : $pet_name;
                                                                }
                                                            }

                                                            $link_view = ($thisDataPaymentLog['customer_id']) ? 'view_payment_customer_info.php' : 'view_payment_customer_info_guest.php';

                                                            $etc_query = "SELECT * FROM tb_payment_log 
                                                                    WHERE cellphone = '{$thisDataPaymentLog['cellphone']}' AND artist_id = '{$user_id}' 
                                                                        AND payment_log_seq = '{$thisDataPaymentLog['payment_log_seq']}'
                                                                        AND is_cancel = 0 
                                                                    ORDER BY DATE_FORMAT(CONCAT(year,'-',month,'-',day,' ',hour,':',IFNULL(minute,'00'),':00'),'%Y-%m-%d H:i') DESC";
                                                            // AND SUBSTRING_INDEX(SUBSTRING_INDEX(product,'|',1),'|',-1) = '{$pet_name}' // 20201223 ulmo 펫이름 변경시 나오지 않아서 쿼리에서 제외
                                                            $etc_result = mysqli_query($connection, $etc_query);
                                                            $etc = "";
                                                            while ($etc_data = mysqli_fetch_object($etc_result)) {
                                                                $memo = $etc_data->etc_memo;
                                                                if ($memo != null && $memo != "") {
                                                                    $memo = str_replace("\r\n", "<br />", $memo);
                                                                    $memo = str_replace("\n", "<br />", $memo);
                                                                    $etc .= date("Y-m-d", strtotime("$etc_data->year-$etc_data->month-$etc_data->day")) . "<br />" . $memo . "<br />";
                                                                }
                                                            }

                                                            $css_pay_type = $pay_type;
                                                            if (startsWith($pay_type, "pos")) {
                                                                $css_pay_type = "yellow";
                                                            } else if (startsWith($pay_type, "offline")) {
                                                                $css_pay_type = "purple";
                                                            }

                                                            if ($is_no_show) {
                                                                $css_pay_type = "red";
                                                            }

                                                            if($thisDataPaymentLog['payment_log_seq'] == $_SESSION['set_order_worker_update']){
                                                                $order_worker_css = "border:3px dotted #f00;";
                                                                $order_worker_class = "move";
                                                            }else{
                                                                $order_worker_css = "";
                                                                $order_worker_class = "";
                                                            }

                                                            // print html
                                                            $print_work = true;
                                                        } else {
                                                            // 빈공간
                                                        }
                                                        if ($rowspan) {
                                                            $rowspan--;
                                                        }
                                                    } else if (in_array($thisTime, $data['reservation'][$key][$firstTime]['time'])) {
                                                        // var_dump($thisDataPaymentLog);
                                                        $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($thisDataReservation['res_time_start']))));
                                                        $time_end =  $time_start + (int) ($thisDataReservation['rowspan'] * (60 * 30));
                                                        // $time_end = date2timestamp(strtotime(date('Y-m-d H:i',strtotime($thisDataReservation['res_time_end']))));
                                                        $time = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);
                                                        $time_block_cnt = $time / (60 * 30); // 블럭갯수

                                                        if (array_search($thisTime, $data['reservation'][$key][$firstTime]['time']) == 0) {

                                                            $style_height = 100 * (int) $time_block_cnt;

                                                            // $link_view = ( $thisDataPaymentLog['customer_id'] ) ? 'view_payment_customer_info.php' : 'view_payment_customer_info_guest.php';
                                                            $reserv_text    = "앱예약중";
                                                        } else {
                                                            // 빈공간
                                                        }
                                                        if ($rowspan) {
                                                            $rowspan--;
                                                        }
                                                    } else {
                                                        
                                                    }


                                                    if ($css_pay_type != "noshow") {


                                                        if ($pay_type == 'card' || $pay_type == 'bank') { 
                                                            $css_pay_type   = "yellow";
                                                        }else if($pay_type == 'offline-card' || $pay_type == 'offline-cash' || $pay_type == 'offline') { 
                                                            $css_pay_type   = "purple";
                                                        }else if($pay_type == 'pos-card' || $pay_type == 'pos-cash') { 
                                                            $css_pay_type   = "green";
                                                        }

                                                     }else{
                                                        $css_pay_type   = "red";
                                                     }

                                                     $day_link   = "?ch=day&yy={$yy}&mm={$mm}&dd=".(int) date('d', strtotime($key))."&backurl=" . urlencode($_SERVER['PHP_SELF']);
                                                    $select_day = date('Y-m-d',strtotime($yy."-".$mm."-".$week_day."+".$cnt." day"));
                                                    ?>
                                               <div class="calendar-week-body-col <?=$div_class?> time_payment"
                                                    data-worker2="<?= $rs['nicname'] ?>"
                                                    data-worker="<?= $rs['artist_id'] ?>"
                                                    data-date="<?= $select_day ?>"
                                                    data-time="<?= $thisTime ?>"
                                                    data-time-to="<?= $thisTimeTo ?>"
                                                    data-time-from="<?= $thisTimeFrom ?>"
                                                    data-hour="<?= substr($thisTime,0,2) ?>"
                                                    data-minute="<?= substr($thisTime,3,2) ?>"
                                                    data-rowspan="" data-time="<?= $thisTime ?>"
                                                    date-session-id="<?= $session_id[$firstTime] ?>"
                                                    data-pay_seq="<?=$payment_log_seq?>"
                                                   <?if($div_class!="break"){?>  style="cursor:pointer"<?}?>>
                                                    
                                                        <div class="calendar-drag-item-group">
                                                            <?php
                                                                if($cnt == 6) {
                                                                    $week_day = substr($first_date,8,2);
                                                                    $cnt = 0;
                                                                } else {
                                                                    $cnt++;
                                                                }


                                                            ?>
                                                        <?=$reserv_text?> 
                                                        <?
                                                        if($h == $time_open && $t30 == 0){
                                                            echo $holiday_1;
                                                        }
                                                        ?>
                                                        
                                                        <?if ($print_work===true) {?>
                                                                
                                                                    <div class="calendar-week-time-item <?=$css_pay_type?> time_payment" style="height:calc( <?=$style_height?>% - 1px );cursor:pointer;" data-customer-id="<?= $thisDataPaymentLog['customer_id'] ?>" data-order-id="<?= $thisDataPaymentLog['order_id'] ?>" data-payment-log-seq="<?= $thisDataPaymentLog['payment_log_seq'] ?>">
                                                                        <div class="item-name"><?= $pet_name; ?></div>
                                                                        <div class="item-cate"><?=$pet_type ?></div>
                                                                        <div class="item-price"><?=$local_price_txt2 ?></div>
                                                                        <div class="item-option"><?=$service_type_dog ?></div>
                                                                    </div>
                                                               
                                                            
                                                        <?}?>
                                                        </div>
                                                </div>
                                                

                                                
                                                <?}?>
                                            </div>
                                            
                                        <?php } ?>
                                    <?php } ?>
								<div class="calendar-week-current-time"><div class="bar"></div></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- //캘린더 상세 -->
































		</div>
		<div class="reserve-calendar-float">
            <div class="reserve-calendar-float-cell">
                <button onclick="location.href='reserve_main_day';" type="button" class="btn-reserve-calendar-today"><span
                        class="icon icon-circle-float-today"></span></button>
            </div>
            <div class="reserve-calendar-float-cell">
                <button type="button" class="btn-reserve-calendar-menu btn-reserve-calendar-toggle"><span
                        class="icon icon-circle-float-menu"></span><em><?= $wait_count ?></em></button>
                <div class="reserve-calendar-float-menu">
                    <button type="button" class="btn-float-menu" onclick="location.href='customer_inquiry';">고객조회</button>
                    <button type="button" class="btn-float-menu" onclick="location.href='customer_pet_new';">신규등록</button>
                    <button type="button" class="btn-float-menu" onclick="location.href='reserve_advice_list_1';">상담 승인 대기 : <?= $wait_count ?></button>
                    <button type="button" class="btn-float-menu">예약 승인 대기 : </button>
                    <button type="button" onclick="location.href='reserve_time_sale_step1_3'" class="btn-float-menu">빈시간 판매하기</button>
                </div>
            </div>
        </div>
	</div>
	<!-- //page-body -->	
</section>

<!-- 일자 클릭시 예약설정 팝업 보기 -->
<article id="reserveCalendarPop2" class="layer-pop-wrap">
    <div class="layer-pop-parent">
        <div class="layer-pop-children">
            <div class="pop-data alert-pop-data">
                <div class="pop-header">
                    <h4 class="con-title">실장</h4>
                </div>
                <div class="pop-body type-3">
                    <div class="msg-txt"><span class="msg-txt-date">2021.09.08</span>&nbsp;&nbsp;&nbsp;&nbsp;<span  class="msg-txt-time">오후 01:30</span></div>
                </div>
                <div class="pop-footer">
                    <button type="button" class="btn btn-confirm btn-reserv-block" onclick="pop.close();">예약금지설정</button>
                    <button type="button" class="btn btn-confirm btn-reserv-send">예약접수</button>
                </div>
            </div>
        </div>
    </div>
</article>


    <article id="reserveCalendarPop3" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">

                <div class="pop-data alert-pop-data">
                    <div class="pop-header">
                        <h4 class="con-title">예약금지 설정</h4>
                    </div>
                    <div class="pop-body type-3">
                        <form name="form_time" id="form_time">
                            <input type="hidden" name="ph_type" value="notall">
                            <input type="hidden" name="ph_worker" value="">
                            <input type="hidden" name="ph_start_year" id="year" value="">
                            <input type="hidden" name="ph_start_month" id="month" value="">
                            <input type="hidden" name="ph_start_day" id="day" value="">



                            <div class="form-group">
                                <div class="form-group-cell">
                                    <div class="form-group-item">
                                        <div class="form-item-label">시간</div>
                                        <div class="form-item-data type-2">
                                            <div class="form-datepicker-group">
                                                <div class="form-datepicker">
                                                    <select name="ph_start_time">
                                                        <option value="">오전 11:30</option>
                                                    </select>
                                                </div>
                                                <div class="form-unit">~</div>
                                                <div class="form-datepicker">
                                                    <select name="ph_end_time">
                                                        <option value="">오후 11:30</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </form>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm btn-holiday-submit">저장</button>
                        <button type="button" class="btn btn-confirm" onclick="pop.close();">취소</button>
                    </div>
                </div>

            </div>
        </div>
    </article>

    <!-- 예약변경 -->
    <article id="reserveCalendarPop4" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">
                <div class="pop-data alert-pop-data">
                    <div class="pop-header">
                        <h4 class="con-title">실장</h4>
                    </div>
                    <div class="pop-body type-3">
                        <div class="msg-txt"><span class="msg-text-date">2021.09.08</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="msg-text-time">오후 01:30</span><br><br>선택한 예약을<br>이 곳으로 변경합니다.</div>
                        <form name="form_change" id="form_change">
                            <input type="hidden" name="log_type" value="check">
                            <input type="hidden" name="log_seq" value="">
                            <input type="hidden" name="log_worker" value="">
                            <input type="hidden" name="log_date" id="year" value="">
                            <input type="hidden" name="log_start_time" id="month" value="">
                            <input type="hidden" name="log_end_time" id="day" value="">
                        </form>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm btn-change-submit" onclick="pop.close();">확인</button>
                        <button type="button" class="btn btn-confirm btn-reserv-cancel" onclick="pop.close();">예약변경취소</button>
                    </div>
                </div>
            </div>
        </div>
    </article>
    <!-- //예약변경 -->

    <!-- 예약변경 불가 -->
    <article id="reserveCalendarPop5" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">
                <div class="pop-data alert-pop-data">
                    <div class="pop-body">
                        <div class="msg-txt">해당 스케줄에 일정이 있어 스케줄 변경이 불가합니다.</div>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm" onclick="pop.close();">확인</button>
                    </div>
                </div>
            </div>
        </div>
    </article>
    <!-- //예약변경 불가 -->

<!-- //container -->
<script src="/static/pub/js/Sortable.min.js"></script>
<script>
$(function(){
	/*
	$( "#sortable" ).sortable({
		placeholder: "ui-state-highlight",
		cancel:''
    });
	$( "#sortable" ).disableSelection();
	*/

	//https://github.com/SortableJS/Sortable

	$('.calendar-week-body-col').each(function(){
		if(!$(this).hasClass('break') && !$(this).hasClass('time')){
			//휴무가 아닐 경우 드래그앤 드롭 가능 처리
			var sortable = Sortable.create($(this).find('.calendar-drag-item-group')[0] , {
				group : 'shared',
				delay : 500,
				delayOnTouchOnly : true,
				ghostClass: 'guide',
				draggable : '.calendar-week-time-item',
				onStart : function(evt){
					//드래그 시작 
					console.log('drag start');
				},
				onEnd : function(evt){
					//드래그 끝
					console.log('drag end');
					//evt.to;    // 현재 아이템
					//evt.from;  // 이전 아이템
					//evt.oldIndex;  // 이전 인덱스값
					//evt.newIndex;  // 새로운 인덱스값
				},
				onUpdate : function(evt){
					console.log('update');
				},
				onUpdate : function(evt){
					console.log('onChange');
				},
				onRemove: function (/**Event*/evt) {
					console.log('remove');
				}
				
			});
		}
	});

    $(".time_payment").on('click',function(){
        thisDate = $(this).attr('data-date');
        thisTime = $(this).attr('data-time');
        thisWorker = $(this).data('worker2');
        thisTimeStart   = $(this).data('time-to');
        thisTimeEnd   = $(this).attr('data-time-from');


        if($(this).find(".calendar-week-time-item").length==0 && $(this).hasClass("break")===false){
            $("#reserveCalendarPop2 .con-title").text(thisWorker);
            $("#reserveCalendarPop2 .msg-txt-date").text(thisDate);
            $("#reserveCalendarPop2 .msg-txt-time").text(thisTime);

            $("#reserveCalendarPop2 .btn-reserv-send").on('click',function(){
                location.href='./reserve_accept?worker='+thisWorker+'&workTime='+thisTime+'&workDate='+thisDate;
            });
            pop.open('reserveCalendarPop2');
            return false;
        }


    });



    $(".time_payment_link").on('click', function(e) {
        e.preventDefault();
        // console.log('time_payment_link');

        var obj_this = $(this);
        var dat_customer_id = obj_this.attr('data-customer-id');
        var dat_order_id = obj_this.attr('data-order-id'); // 주문아이디
        var dat_payment_log_seq = obj_this.attr('data-payment-log-seq'); // 주문아이디

        var obj_time_cell = obj_this.parent().parent();
        var obj_artist_line = obj_this.closest('td');
        
        
        // 선택가능 시작시점 조사
        var obj_time_cell_prev = obj_time_cell;

        //console.log(obj_time_cell_prev.hasClass('time_payment'));
        // console.log( 'obj_time_cell_prev.length' , obj_time_cell_prev.length );
        var val_time_blank_count = 0;

        var thisTimeStart = obj_time_cell_prev.attr('data-time-to');
        var thisTimeEnd = obj_time_cell_prev.attr('data-time-from');

        // console.log( 'thisTimeStart' , thisTimeStart );
        // 선택가능 시작시점 조사

        // 선택가능 종료시점 조사
        var obj_time_cell_next = obj_time_cell.next();
        var obj_time_cell_all = obj_artist_line.find('>div');
        var val_time_blank_count_max = obj_time_cell_all.length;

        // console.log( obj_time_cell_next.index() , val_time_blank_count_max );

        for (var i = obj_time_cell_next.index(); i < val_time_blank_count_max; i++) {
            // console.log( 'data-time' , obj_time_cell_next.attr('data-time-to') , obj_time_cell_next.attr('data-time-from') , i , obj_time_cell_next.attr('class') );
            var obj_time_cell_next = obj_artist_line.find('>div').eq(i);
            if (!obj_time_cell_next.length) break;
            var idx = i - 1;
            // obj_time_cell_next = obj_artist_line.find('>div').eq(idx);
            // console.log( 'obj_time_cell_next' , i , val_time_blank_count_max , obj_time_cell_next.attr('class') );
            if (obj_time_cell_next.hasClass('time_payment')) {
                idx = i - 1;
                var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i+1);
                thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                // console.log('time_payment', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                i = val_time_blank_count_max;
                continue;
            } else
                // res는 무시한다.
                // if ( obj_time_cell_next.hasClass('res') ) {
                //     idx = i-1;
                //     var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                //     // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                //     thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                //     // console.log( 'thisTimeEnd res' , thisTimeEnd , i , obj_time_cell_next.attr('class') );
                //     i = val_time_blank_count_max;
                //     continue;
                // } else
                if (obj_time_cell_next.hasClass('not')) {
                    idx = i - 1;
                    var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                    thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    // console.log('not', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                    i = val_time_blank_count_max;
                    continue;
                } else
                    // if ( obj_time_cell_next.hasClass('res') ) {
                    //     idx = i-1;
                    //     var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    //     // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                    //     thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    //     // console.log( 'thisTimeEnd res' , thisTimeEnd , i , obj_time_cell_next.attr('class') );
                    //     i = val_time_blank_count_max;
                    //     continue;
                    // } else
                    if (obj_time_cell_next.hasClass('ing')) {
                        idx = i - 1;
                        var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                        // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                        thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                        // console.log('ing', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                        i = val_time_blank_count_max;
                        continue;
                    } else
            if (obj_time_cell_next.hasClass('holiday')) {
                idx = i - 1;
                var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                // console.log('holiday', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                i = val_time_blank_count_max;
                continue;
            } else {
                idx = i;
                var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i);
                thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                // console.log('thisTimeEnd normal', thisTimeEnd, i);
            }
        }
        // console.log( 'thisTimeEnd' , thisTimeEnd , val_time_blank_count_max );
        // 선택가능 종료시점 조사

        // console.log(thisTimeStart, thisTimeEnd);

        var param = '';
        if (dat_payment_log_seq !== undefined && dat_payment_log_seq) {
            param += (param ? '&' : '?') + 'payment_log_seq=' + dat_payment_log_seq;
        }
        if (thisTimeStart !== undefined && thisTimeStart) {
            param += (param ? '&' : '?') + 'thisTimeStart=' + thisTimeStart;
        }
        if (thisTimeEnd !== undefined && thisTimeEnd) {
            param += (param ? '&' : '?') + 'thisTimeEnd=' + thisTimeEnd;
        }
        param += (param ? '&' : '?') + 'backurl=' + encodeURIComponent(window.location.href);
        var link_view = (dat_customer_id !== undefined && dat_customer_id) ? 'reserve_pay_management_1' + param : 'reserve_pay_management_1' + param;
        console.log(link_view);
        
        // var 

        // console.log('link_view', link_view);
        document.location.href = link_view;
        return false;
    });



    
    //$(".reserve-calendar-top select").val('<?= (int) date('Y', strtotime($first_date)) ?>.<?= (int) date('m', strtotime($first_date)) ?>.<?= (int) date('d', strtotime($first_date)) ?>');
    $(".reserve-calendar-top .txt").text($(".reserve-calendar-top select option:selected").attr("data-rol1")+" ~ "+$(".reserve-calendar-top select option:selected").attr("data-rol2"));
    var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
    if(idx==0){
        $(".btn-month-next").hide();
    }

    if(idx==11){
        $(".btn-month-prev").hide();
    }
    

    $(".reserve-calendar-top select").change(function () { 
        
        var yymm    = $(this).val().split(".");
        if(yymm[1]>=10){
            location.href="reserve_main_week?ch=week&yy="+yymm[0]+"&mm="+yymm[1]+"&dd="+yymm[2];
        }else if(yymm[1]<10 && yymm[2]<10){
            location.href="reserve_main_week?ch=week&yy="+yymm[0]+"&mm="+yymm[1].replace("0","")+"&dd="+yymm[2].replace("0","");
        }else if(yymm[1]>10 && yymm[2]<10){
            location.href="reserve_main_week?ch=week&yy="+yymm[0]+"&mm="+yymm[1]+"&dd="+yymm[2].replace("0","");
        }else{
            location.href="reserve_main_week?ch=week&yy="+yymm[0]+"&mm="+yymm[1].replace("0","")+"&dd="+yymm[2];
        }
        
    });

    $(".btn-month-prev").on('click',function (e) {
        var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
        $('.reserve-calendar-top select option:eq(' + (idx+1) + ')').prop('selected', 'selected').change();
        e.preventDefault();
    });

    $(".btn-month-next").click(function (e) { 
        var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
        $('.reserve-calendar-top select option:eq(' + (idx-1) + ')').attr('selected', 'selected').change();
        e.preventDefault();
        
    });

    console.log($(".calendar-week-body").height());


    var now_date = new Date();
    var now_hours = now_date.getHours();
    var now_m = now_date.getMinutes();
    
    
    var line_hieght = ((now_hours-9)*60+now_m)*2.07;
    //console.log((((18-9)*100+now_m)/100));
    if(line_hieght>0 && line_hieght<1240){
        $(".calendar-week-current-time").css("top",line_hieght+"px");
    }else{
        $(".calendar-week-current-time").hide();
    }
    
    
});
</script>


<?
include($_SERVER['DOCUMENT_ROOT']."/include/skin/footer_shop.php");
?>