<?php
include($_SERVER['DOCUMENT_ROOT']."/include/global.php");
include($_SERVER['DOCUMENT_ROOT'] . "/common/TFunc.php");
include($_SERVER['DOCUMENT_ROOT'] . "/common/TSql.php");


$artist_flag = (isset($_SESSION['artist_flag'])) ? $_SESSION['artist_flag'] : "";

if ($artist_flag === true) {
    $artist_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_name = (isset($_SESSION['shop_user_nickname'])) ? $_SESSION['shop_user_nickname'] : "";
} else {
    $artist_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_name = (isset($_SESSION['gobeauty_user_nickname'])) ? $_SESSION['gobeauty_user_nickname'] : "";
}

$shop_title	= "빈시간 판매하기";
include($_SERVER['DOCUMENT_ROOT']."/include/skin/header_shop.php");
include($_SERVER['DOCUMENT_ROOT']."/include/check_login_shop.php");

$_SESSION['week_type'] = '0';

$from = $_GET['from'];

$sql = array();
$data = array();
$wait_count = 0;

$ch = (isset($_GET['ch']) && $_GET['ch']) ? $_GET['ch'] : 'month';
$yy = (isset($_GET['yy']) && $_GET['yy']) ? $_GET['yy'] : date('Y');
$mm = (isset($_GET['mm']) && $_GET['mm']) ? $_GET['mm'] : date('m');
$dd = (isset($_GET['dd']) && $_GET['dd']) ? $_GET['dd'] : date('d');
$week = $_GET['week'];

$_SESSION['backurl1'] = 'reserve_time_sale_step1_2';

$daily = array('일', '월', '화', '수', '목', '금', '토');
$selected_date = $yy . "-" . $mm . "-" . $dd;

$y_yy = date("Y", strtotime($selected_date . "-1day"));
$y_mm = date("m", strtotime($selected_date . "-1day"));
$y_dd = date("d", strtotime($selected_date . "-1day"));
$t_yy = date("Y", strtotime($selected_date . "+1day"));
$t_mm = date("m", strtotime($selected_date . "+1day"));
$t_dd = date("d", strtotime($selected_date . "+1day"));

// 오늘 날짜
$today_year = date("Y");
$today_month = date("m");
$today_day = date("d");

// var_dump($_SESSION);

$shop_sql = "select * from tb_shop where customer_id = '" . $user_id . "'";
$shop_result = mysqli_query($connection, $shop_sql);
if ($shop_datas = mysqli_fetch_object($shop_result)) {
    $front_image = $shop_datas->front_image;
    $name = $shop_datas->name;
    $working_years = $shop_datas->working_years;
    $self_introduction = $shop_datas->self_introduction;
    $professional_field = $shop_datas->professional_field;
    $career = $shop_datas->career;
    $license_indexs = $shop_datas->license_indexs;
    $region_and_cost = $shop_datas->region_and_cost;
    $enable_flag = $shop_datas->enable_flag;
    $update_time = $shop_datas->update_time;

    //----- 상담 대기 건수 조회
    $pet_sql =
        "SELECT count(tpl.payment_log_seq) AS wait_count
            FROM tb_payment_log tpl, tb_mypet tm, tb_customer tc
            WHERE tpl.approval = 0
            AND tpl.pet_seq = tm.pet_seq 
            AND tpl.customer_id = tc.id
			AND tc.enable_flag = 1
            AND timestampdiff(minute, update_time, now()) < 720
            AND tpl.artist_id = '{$user_id}'";
    $pet_result = mysqli_query($connection, $pet_sql);
    // error_log('----- $pet_sql : ' . $pet_sql);
    if ($pet_result_rows = mysqli_fetch_object($pet_result)) {
        $wait_count = $pet_result_rows->wait_count;
    }

    //크기 데이터,  상품 데이터
    $dog_static_query = "SELECT *, second_type AS product_type FROM tb_product_dog_static WHERE customer_id = '{$user_id}'";
    $dog_static_result = mysqli_query($connection, $dog_static_query);
    $dog_static_list = array();
    $dog_static_list2 = array(); // worktime
    $dog_service_list = array();
    while ($dog_static_data = mysqli_fetch_object($dog_static_result)) {
        $product_type = $dog_static_data->product_type;
        $dog_static_list[] = $product_type;

        $sanitation = $dog_static_data->sanitation_price;
        $bath = $dog_static_data->bath_price;
        $part = $dog_static_data->part_price;
        $bath_part = $dog_static_data->bath_part_price;
        $all = $dog_static_data->all_price;
        $spoting = $dog_static_data->spoting_price;
        $summercut = $dog_static_data->summercut_price;
        $scissors = $dog_static_data->scissors_price;

        if ($bath != null && $bath != "") {
            $dog_service_list[$product_type]["목욕"] = "목욕";
            $dog_static_list2[1] = "목욕";
        }

        if ($part != null && $part != "") {
            $dog_service_list[$product_type]["부분미용"] = "부분미용";
            $dog_static_list2[2] = "부분미용";
        }

        if ($bath_part != null && $bath_part != "") {
            $dog_service_list[$product_type]["부분+목욕"] = "부분+목욕";
            $dog_static_list2[3] = "부분+목욕";
        }

        if ($all != null && $all != "") {
            $dog_service_list[$product_type]["전체미용"] = "전체미용";
            $dog_static_list2[4] = "전체미용";
        }

        if ($spoting != null && $spoting != "") {
            $dog_service_list[$product_type]["스포팅"] = "스포팅";
            $dog_static_list2[5] = "스포팅";
        }

        if ($scissors != null && $scissors != "") {
            $dog_service_list[$product_type]["가위컷"] = "가위컷";
            $dog_static_list2[6] = "가위컷";
        }

        if ($sanitation != null && $sanitation != "") {
            $dog_service_list[$product_type]["위생"] = "위생";
            $dog_static_list2[7] = "위생";
        }

        if ($summercut != null && $summercut != "") {
            $dog_service_list[$product_type]["썸머컷"] = "썸머컷";
            $dog_static_list2[8] = "썸머컷";
        }

        // if (($sanitation != null && $sanitation != "") && ($summercut != null && $summercut != "")) {
        //     $dog_service_list[$product_type] = ["위생" => "위생", "목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "썸머컷" => "썸머컷", "가위컷" => "가위컷"];
        // } else if (($sanitation != null && $sanitation != "") && ($summercut == null || $summercut == "")) {
        //     $dog_service_list[$product_type] = ["위생" => "위생", "목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "가위컷" => "가위컷"];
        // } else if (($sanitation == null || $sanitation == "") && ($summercut != null && $summercut != "")) {
        //     $dog_service_list[$product_type] = ["목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "썸머컷" => "썸머컷", "가위컷" => "가위컷"];
        // } else {
        //     $dog_service_list[$product_type] = ["목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "가위컷" => "가위컷"];
        // }
    }

    $dog_worktime_query = "SELECT * FROM tb_product_dog_worktime WHERE artist_id = '".$user_id."' AND is_delete = '2' ";
    $dog_worktime_result = mysqli_query($connection, $dog_worktime_query);
    $dog_worktime_cnt = mysqli_num_rows($dog_worktime_result);
    $dog_worktime_list = array();
    $dog_worktime_txt = array("dog","목욕","부분미용","부분+목욕","전체미용","스포팅","가위컷","위생","썸머컷");
    // 순서대로 목욕,부분미용,부분+목욕,전체미용,스포팅,가위컷,위생,썸머컷
    if($dog_worktime_cnt > 0){
        while($dog_worktime_data = mysqli_fetch_assoc($dog_worktime_result)){
            for($_i = 1; $_i <= 8; $_i++){
                foreach($dog_static_list2 AS $key => $value){
                    if($dog_worktime_txt[$_i] == $value){
                        $dog_worktime_list[$value] = $dog_worktime_data["worktime".$_i];
                    }
                }
            }
        }
    }else{
        $dog_worktime_list = array(
            "dog" => "dog",
            "목욕" => "120",
            "부분미용" => "120",
            "부분+목욕" => "120",
            "전체미용" => "120",
            "스포팅" => "120",
            "가위컷" => "120",
            "위생" => "120",
            "썸머컷" => "120"
        );
    }
    //print_r($dog_worktime_list);


    $cat_static_query = "SELECT * FROM tb_product_cat WHERE customer_id = '{$user_id}'";
    $cat_static_result = mysqli_query($connection, $cat_static_query);
    $cat_static_list = array();
    while ($cat_static_data = mysqli_fetch_object($cat_static_result)) {
        $cat_static_list[] = $cat_static_data->second_type;
        $cat_product = $cat_static_data;
    }

    //기타 상품 데이터
    $dog_etc_list = array();
    $dog_etc_query = "SELECT * FROM tb_product_dog_etc WHERE customer_id = '{$user_id}'";
    $dog_etc_result = mysqli_query($connection, $dog_etc_query);
    while ($dog_etc = mysqli_fetch_object($dog_etc_result)) {
        $dog_etc_list[] = $dog_etc;
    }

    $cat_etc_list = array();
    $cat_etc_query = "SELECT * FROM tb_product_cat_etc WHERE customer_id = '{$user_id}'";
    $cat_etc_result = mysqli_query($connection, $cat_etc_query);
    while ($cat_etc = mysqli_fetch_object($cat_etc_result)) {
        $cat_etc_list[] = $cat_etc;
    }

    //쿠폰 상품 데이터
    $coupon_list = array();
    $coupon_query = "SELECT * FROM tb_coupon WHERE customer_id = '{$user_id}' AND del_yn = 'N' ORDER BY reg_date";
    $coupon_result = mysqli_query($connection, $coupon_query);
    while ($coupon_data = mysqli_fetch_object($coupon_result)) {
        $coupon_list[] = $coupon_data;
    }
}


$daily = array('일', '월', '화', '수', '목', '금', '토');
$month_list = array('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12');

$worker = $_GET['worker'] ? $_GET['worker'] : (($artist_flag === true) ? $_SESSION['shop_user_id'] : $_SESSION['gobeauty_user_id']);
$now = new DateTime($yy . '-' . $mm . '-' . $dd);
$now_date = date_format($now, 'Y-m-d');
$week_index = date_format($now, 'w');

$first_date = date('Y-m-d', strtotime($now_date . " -{$week_index} days")); // 주중 첫날
$last_date = date('Y-m-d', strtotime($first_date . " +6 days")); //  주중 마지막날

//미용사 체크
$check_query = "SELECT * FROM tb_artist_list WHERE `name` = '{$worker}' AND artist_id = '{$user_id}' AND is_view = '2' ";
$check_result = mysqli_query($connection, $check_query);
$check_cnt = mysqli_num_rows($check_result);

/* 현재 선택된 미용사의 정보를 가져온다. 2020-02-18 james */
$rs = mysqli_fetch_assoc($check_result);


/*$sql['artist'] = " SELECT * FROM `tb_artist_list` WHERE artist_id='{$artist_id}' AND name = '{$worker}' AND is_view = '2' AND is_out = '2' GROUP BY name ORDER BY sequ_prnt asc, is_main DESC, nicname ASC";
//echo $sql['artist']."<p>";

// error_log('----- $sql[artist] : '.$sql['artist']);
$result = mysqli_query($connection, $sql['artist']);
while ($artist_rows = mysqli_fetch_assoc($result)) {
    $data['artist'][] = $artist_rows;
}

print_r($data['artist']);*/

if ($check_cnt <= 0) {
    $search_query = "SELECT * FROM tb_artist_list WHERE artist_id = '{$user_id}' AND is_view = '2' LIMIT 1";
    $search_result = mysqli_query($connection, $search_query);


    $search_data = mysqli_fetch_object($search_result);
    $worker = $search_data->name;
//    $artist['nicname'] = $search_data->nicname;

}



// 일일 오픈시간과 종료시간을 가지고 온다. [START]
$sql['working_schedule'] = "select * from tb_working_schedule where customer_id='{$artist_id}'";
$result['working_schedule'] = mysqli_query($connection, $sql['working_schedule']);
$rows['working_schedule'] = mysqli_fetch_object($result['working_schedule']);

$time_open = $rows['working_schedule']->working_start; // 오픈시간
$time_close = $rows['working_schedule']->working_end; // 종료시간
// 일일 오픈시간과 종료시간을 가지고 온다. [END]




// 결제예약 정보 [START]
$sql['payment'] = "SELECT
    pay.* ,
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_date ,
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_start ,
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.to_hour,':',IFNULL(pay.to_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_end
FROM 
    `tb_payment_log` AS pay
WHERE
    1
    AND pay.artist_id='{$artist_id}'
    AND pay.worker='{$worker}'
    AND pay.is_cancel=0
	AND pay.data_delete = '0'
    AND DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d' ) >= DATE_FORMAT( '$first_date' , '%Y-%m-%d' )
    AND DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d' ) <= DATE_FORMAT( '$last_date' , '%Y-%m-%d' )
";
$result = mysqli_query($connection, $sql['payment']);
while ($rows = mysqli_fetch_object($result)) {
    // $rows_rowspan = $rows->rowspan;
    $rows_my_order = $rows->my_order;
    $rows_session_id = $rows->session_id;

    $date = date('Y-m-d', strtotime($rows->res_date));
    $time = date('H:i', strtotime($rows->res_date));


}
// 결제예약 정보 [END]

// echo '<pre>';
// var_dump($data['payment']);
// echo '</pre>';


// 2019.01.07 developlay - 요일별 정기휴일여부 추출 [START]
$holiweek_arr = array();
$sql_regular = "select * from tb_regular_holiday where customer_id = '" . $artist_id . "';";
//echo $sql_regular."<br>";
$sql_regular_result = mysqli_query($connection, $sql_regular);
if ($sql_regular_row = mysqli_fetch_object($sql_regular_result)) {
    $holiweek_arr[0] = $sql_regular_row->is_sunday;
    $holiweek_arr[1] = $sql_regular_row->is_monday;
    $holiweek_arr[2] = $sql_regular_row->is_tuesday;
    $holiweek_arr[3] = $sql_regular_row->is_wednesday;
    $holiweek_arr[4] = $sql_regular_row->is_thursday;
    $holiweek_arr[5] = $sql_regular_row->is_friday;
    $holiweek_arr[6] = $sql_regular_row->is_saturday;
}
// 2019.01.07 developlay - 요일별 휴일여부 추출 [END]

$date_week_list = array();

for ($w = 0; $w <= 6; $w++) {
    $next_date = date('Y-m-d', strtotime($first_date . " +{$w}days"));

    $next_year = date('Y', strtotime($first_date . " +{$w}days"));
    $next_month = date('m', strtotime($first_date . " +{$w}days"));
    $next_day = date('d', strtotime($first_date . " +{$w}days"));
    $next_hour = date('H', strtotime($first_date . " +{$w}days"));
    $next_minute = date('i', strtotime($first_date . " +{$w}days"));
    $date_week_list[$next_date] = array();

    // 일일 오픈시간과 종료시간을 가지고 온다.
    $sql = "select * from tb_working_schedule where customer_id='{$artist_id}'";
    $result = mysqli_query($connection, $sql);
    $rows = mysqli_fetch_object($result);
    $order_my = isset($order_my) ? $order_my : array();
    ksort($order_my);
    // echo '<pre>';
    // var_dump($order_my);
    // echo '</pre>';

    $date_week_list[$next_date] = array();
    $date_week_list[$next_date]['working_start'] =  $rows_working_start = $rows->working_start;
    $date_week_list[$next_date]['working_end'] = $rows_working_end = $rows->working_end;
    // var_dump($date_week_list[$next_date]);


    //필요한 쿼리 인지 확인 필요함
    $sql = "
    SELECT 
        res.* 
        , pay.order_id
        , pay.payment_log_seq
    FROM 
        `tb_reservation` res 
        LEFT JOIN `tb_payment_log` pay on ( pay.session_id=res.session_id )
    WHERE 
        1
        and res.artist_id = '{$_SESSION['gobeauty_cart_artist_id']}'
        and res.year = '{$next_year}'
        and res.month = '{$next_month}'
        and res.day = '{$next_day}'
        and res.worker = '{$worker}'
    ";
    $result = mysqli_query($connection, $sql);
    $date_week_list[$next_date]['reservation'] = array();
    while ($rows = mysqli_fetch_object($result)) {
        // var_dump($rows);


        // var_dump($rows);
        $rows_year = $rows->year;
        $rows_month = $rows->month;
        $rows_day = $rows->day;
        $rows_hour = $rows->hour;
        $rows_minute = $rows->minute;
        $rows_rowspan = $rows->rowspan;
        $rows_my_order = $rows->my_order;
        $rows_session_id = $rows->session_id;

        $date =  $rows_year . '-' . $rows_month . '-' . $rows_day . ' ' . $rows_hour . ":" . $rows_minute . ":00";
        // echo '<Br/>';
        $now = date_create($date);
        $time = date_format($now, "H:i");

        $date_week_list[$next_date]['reservation'][] = $time;

        $reservation[$time][] = $time;
        $rowspan[$time] = $rows_rowspan;
        $session_id[$time] = $rows_session_id;
        if ($rows_my_order) $order_my[$time][] = $time;
        for ($t = 0; $t < $rows->rowspan - 1; $t++) {
            // echo $t.'<br/>';
            $date_add = date_add($now, date_interval_create_from_date_string("30 minutes"));
            $reservation[$time][] = date_format($date_add, "H:i");
            if ($rows_my_order) $order_my[$time][] = date_format($date_add, "H:i");
        }
    }
}

// 일일 오픈시간과 종료시간을 가지고 온다.
$sql = "select * from tb_working_schedule where customer_id='{$artist_id}'";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);
ksort($order_my);

$data['week_time'] = array();
$data['week_time']['working_start'] = $rows->working_start;
$data['week_time']['working_end'] = $rows->working_end;
// var_dump( $data['week_time'] );

// 2019.01.07 developlay - 요일별 휴일여부 추출 [START]
$data['holiweek'] = array();
$sql_holiweek = "SELECT * FROM tb_regular_holiday WHERE customer_id = '" . $artist_id . "';";
$result_holiweek = mysqli_query($connection, $sql_holiweek);
if ($rows = mysqli_fetch_object($result_holiweek)) {
    $data['holiweek'][0] = $rows->is_sunday;
    $data['holiweek'][1] = $rows->is_monday;
    $data['holiweek'][2] = $rows->is_tuesday;
    $data['holiweek'][3] = $rows->is_wednesday;
    $data['holiweek'][4] = $rows->is_thursday;
    $data['holiweek'][5] = $rows->is_friday;
    $data['holiweek'][6] = $rows->is_saturday;
}
// 2019.01.07 developlay - 요일별 휴일여부 추출 [END]



// 임시휴일[START]
$data['private_holiday'] = array();


/** ----- $last_date_custom를 만든 이유
 * 주간 일정에서 토요일의 임시휴일(예약방지)이 표시되지 않았고
 * 해당 문제는 아래의 $sql_private_holiday 쿼리의 결과가 금요일까지만
 * 출력되기 때문에 발생.
 *
 * 기존 $last_date를 변경 시
 * 이를 사용하는 다른 기능에서 문제가 발생할 수 있기에
 *
 * 임시로 해당 쿼리에서만 $last_date_custom를 사용하여
 * 출력 범위를 하루 더 추가한 +7일로 변경하여 문제를 해결.
 *
 * 차후 다른 기능에서도 문제가 발생하는지 확인이 필요.
 */

/*$sql = "
		SELECT *
		FROM `tb_artist_list`
		WHERE artist_id = '".$artist_id."'
			AND NAME = '".$worker."'
			AND WEEK = '".$week_idx."'
			AND is_view = '2'
	";
echo $sql."<p>";
$result = mysqli_query($connection, $sql);
$row = mysqli_fetch_array($result);
$data['artist'][$key]["time_start"] = $row["time_start"];
$data['artist'][$key]["time_end"] = $row["time_end"];*/

$artist['name'] = $_GET['worker'];


$last_date_custom = date('Y-m-d', strtotime($first_date . " +7 days"));

$sql_private_holiday = "SELECT * FROM(
        SELECT 
            pholiday.* ,
		    DATE_FORMAT( CONCAT( pholiday.start_year,'-',pholiday.start_month,'-',pholiday.start_day,' ',pholiday.start_hour,':',IFNULL(pholiday.start_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) pri_start_date ,
		    DATE_FORMAT( CONCAT( pholiday.end_year,'-',pholiday.end_month,'-',pholiday.end_day,' ',IF(pholiday.end_hour = 24 AND (pholiday.end_minute IS NULL OR pholiday.end_minute = 0), '23', pholiday.end_hour),':',IF(pholiday.end_hour = 24 AND pholiday.end_minute IS NULL, '59', IFNULL('00',pholiday.end_minute)),':00' ), '%Y-%m-%d %H:%i' ) pri_end_date ,
		    DATE_FORMAT( CONCAT( pholiday.start_year,'-',pholiday.start_month,'-',pholiday.start_day,' ',pholiday.start_hour,':',IFNULL(pholiday.start_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) pri_start_time ,
		    DATE_FORMAT( CONCAT( pholiday.end_year,'-',pholiday.end_month,'-',pholiday.end_day,' ',IF(pholiday.end_hour = 24 AND (pholiday.end_minute IS NULL OR pholiday.end_minute = 0), '23', pholiday.end_hour),':',IF(pholiday.end_hour = 24 AND pholiday.end_minute IS NULL, '59', IFNULL('00',pholiday.end_minute)),':00' ), '%Y-%m-%d %H:%i' ) pri_end_time
        FROM tb_private_holiday pholiday 
    )A
    WHERE 
        A.customer_id='{$artist_id}'
        AND A.worker='{$worker}'
        AND A.pri_start_date >= DATE_FORMAT( '$first_date' , '%Y-%m-%d' )
        AND A.pri_end_date <= DATE_FORMAT( '$last_date_custom' , '%Y-%m-%d' )
";
//echo $sql_private_holiday."<p>";
// error_log('----- $sql_private_holiday : ' . $sql_private_holiday);
$result_private_holiday = mysqli_query($connection, $sql_private_holiday);
while ($private_holiday_rows = mysqli_fetch_assoc($result_private_holiday)) {

    $tmp_start_hour = $private_holiday_rows['start_hour'];
    $tmp_end_hour = $private_holiday_rows['end_hour'];

    if($private_holiday_rows['start_hour'] == 0){
        $tmp_start_hour = $data['schedule']['working_start']; // 업무시작시간으로 설정
    }else{
        if($private_holiday_rows['start_hour'] < $data['schedule']['working_start']){
            $tmp_start_hour = $data['schedule']['working_start']; // 업무시작시간으로 설정
        }
    }
    if($private_holiday_rows['end_hour'] == 0){
        $tmp_end_hour = $data['schedule']['working_end']; // 업무마감시간으로 설정
    }else{
        if($private_holiday_rows['end_hour'] > $data['schedule']['working_end']){
            $tmp_end_hour = $data['schedule']['working_end']; // 업무마감시간으로 설정
        }
    }

    $data['private_holiday'][$artist['name']]['phseq'] = $private_holiday_rows['ph_seq'];

    //echo $private_holiday_rows['start_hour']."/".$private_holiday_rows['end_hour']."//".$tmp_start_hour."/".$tmp_end_hour;
    $tmp_start_date = DATE("Y-m-d H:i", STRTOTIME($yy."-".$mm."-".$dd." ".$tmp_start_hour.":".$private_holiday_rows['start_minute']));
    $tmp_end_date = DATE("Y-m-d H:i", STRTOTIME($yy."-".$mm."-".$dd." ".$tmp_end_hour.":".$private_holiday_rows['end_minute']));

    // $date = date('Y-m-d', strtotime($private_holiday_rows['pri_start_date']));
    $time = date('H:i', strtotime($tmp_start_date));
    $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($tmp_start_date))));
    $time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($tmp_end_date))));
    //$time = date('H:i', strtotime($private_holiday_rows['pri_start_date']));
    //$time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($private_holiday_rows['pri_start_date']))));
    //$time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($private_holiday_rows['pri_end_date']))));

    $sec = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);
    //echo "sec->".$sec."<p>";
    $time_block_cnt = $sec / (60 * 30); // 블럭갯수

    // 30분간격으로 시간을 저장한다.
    for ($h = $time_start; $h < $time_end; $h += (60 * 30)) {
        $private[$private_holiday_rows['worker']][] = date('H:i', $h);
    }

    //echo $artist['name']."<p>";

    $data['private_holiday'][$artist['name']]['time'] = $private[$artist['name']];
    $data['private_holiday'][$artist['name']]['count'][$time] = (int) $time_block_cnt;
    $data['private_holiday'][$artist['name']]['data'][$time] = $private_holiday_rows;
}


/*echo '<pre>';
var_dump($data['private_holiday'][$artist['name']]);
echo '</pre>';*/

// echo $first_stamp = date2timestamp($first_date);
// echo $first_date;
// echo $last_date;
$first_stamp = date2timestamp(strtotime($first_date));
$last_stamp  = date2timestamp(strtotime($last_date));
for ($d = $first_stamp; $d <= $last_stamp; $d += (60 * 60 * 24)) {
    $w = date('w', $d);
    $sql_artist_list = "SELECT 
        *
    FROM 
        `tb_artist_list` artist
    WHERE 
        artist.artist_id='{$artist_id}' 
        AND name='{$worker}'
        AND week={$w}
		AND is_view = '2'
    ";
    $result_artist_list = mysqli_query($connection, $sql_artist_list);
    while ($rows = mysqli_fetch_assoc($result_artist_list)) {
        $time_start = date2timestamp(strtotime(date('Y-m-d', $d) . ' ' . $rows['time_start']));
        $time_end = date2timestamp(strtotime(date('Y-m-d', $d) . ' ' . $rows['time_end']));

        for ($h = $time_start; $h < $time_end; $h += (60 * 30)) {
            $artist_list[$rows['week']][] = date('H:i', $h);
        }

        $data['artist_list']['time'] = $artist_list;
    }
}

// 2020.04.08 ulmo 예약 스케줄 운영방식 선택
$sql = "select * from tb_time_schedule where artist_id = '{$artist_id}' ";

$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);

$data["time_schedule"] = array();
$data["time_schedule"]["res_time_off"] = $rows->res_time_off;

$sql = "select is_time_type from tb_shop where customer_id = '{$artist_id}' ";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);

$data["time_schedule"]["is_time_type"] = $rows->is_time_type;


// echo '<pre>';
// var_dump($data['artist_list']['time']);
// echo '</pre>';


$sql = " SELECT * FROM `tb_artist_list` WHERE artist_id='{$artist_id}' AND is_view = '2' AND is_out = '2' GROUP BY name ORDER BY sequ_prnt asc, is_main DESC, nicname ASC";
//echo $sql;

$result = mysqli_query($connection, $sql);
$artist_data    = array();
while ($artist_rows = mysqli_fetch_assoc($result)) {
    $artist_data[]  = $artist_rows;
}




$que = " SELECT * FROM `tb_artist_list` WHERE artist_id='{$artist_id}' AND is_view = '2' AND is_out = '2' GROUP BY name ORDER BY sequ_prnt asc, is_main DESC, nicname ASC";
//echo $que;
$result = mysqli_query($connection, $que);
while ($artist_rows = mysqli_fetch_assoc($result)) {
    $data['artist'][] = $artist_rows;
}

$worker_id = $_GET['worker'];
if(empty($worker_id)){
//    print_r($data['artist']);
    $worker_id = $data['artist'][0]['artist_id'];
}

$total_cnt = 0;
$que = "SELECT * FROM tb_sale_free_time_temp WHERE artist_id = '{$artist_id}' AND worker = '{$worker}'";
$sftt = sql_fetch_array($que);
if(count($sftt)>0){
    foreach($sftt as $rs){
        $ed[] = $rs['empty_date'].' '.$rs['empty_datetime'];
        $total_cnt++;
    }
}

//타임제일경우 확인하기
if($data["time_schedule"]["is_time_type"]==2) {
    $que = " SELECT * FROM `tb_artist_list` WHERE artist_id='{$artist_id}' AND is_view = '2' AND is_out = '2' GROUP BY name ORDER BY sequ_prnt asc, is_main DESC, nicname ASC";
    //echo $que;
    $result = mysqli_query($connection, $que);
    while ($artist_rows = mysqli_fetch_assoc($result)) {
        $que = "SELECT * FROM tb_time_schedule WHERE artist_id = '{$artist_id}' AND artist_name = '{$artist_rows['name']}'";
        $row = sql_fetch_array($que);
        if(!empty($row[0]['res_time_off'])) {
            $time_schedule[$artist_rows['name']] = explode(',', $row[0]['res_time_off']);
            for($i=0;$i<count($time_schedule[$artist_rows['name']]);$i++) {
                $tsc[$artist_rows['name']][] = substr($time_schedule[$artist_rows['name']][$i], 0, 5);
            }
        }
    }
}

// 예약중건 추출
$data['reservation'] = array();
$sql = "SELECT
    res.* ,
    DATE_FORMAT( CONCAT( res.year,'-',res.month,'-',res.day,' ',res.hour,':',IFNULL(res.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_start
FROM
    `tb_reservation` res
WHERE
    DATE_FORMAT( CONCAT( res.year,'-',res.month,'-',res.day ), '%Y-%m-%d' ) >= DATE_FORMAT( '{$yy}-{$mm}-{$dd}' , '%Y-%m-%d' )
    AND res.update_time > DATE_ADD(now(), INTERVAL -10 MINUTE )
    AND worker = '{$worker}'
";
//echo $sql;
$arr = sql_fetch_array($sql);

if(count($arr)>0){
    foreach($arr as $arr) {
        $res_time['datetime'][] = strtotime($arr['res_time_start']);
        $res_time['datetime_time'][] = strtotime($arr['res_time_start']);
        $res_time['time_start'][] = strtotime($arr['res_time_start']);
        $res_time['daterow'][] = $arr['rowspan'];
        $res_time['worker'][] = $arr['worker'];
    }
}

for($i=0;$i<count($res_time);$i++) {
    for ($k = 1; $k < $res_time['daterow'][$i]; $k++) {
        array_push($res_time['datetime_time'], $res_time['datetime_time'][$i]+(1800*$k));
    }
}

$rt_cnt = count($res_time['datetime']);
sort($res_time['datetime_time']);
sort($res_time['datetime']);

$que = "SELECT * FROM tb_working_schedule WHERE customer_id = '{$artist_id}'";
//echo $que;
$tws = sql_fetch_array($que);

$reserve_sql = new TReserveSql($connection);
$CantReservationWeek = $reserve_sql->qry_cant_reservation_week($artist_id, $worker, $first_date, $last_date);
$CantReservationWeekNor = $reserve_sql->qry_cant_reservation_week_nor($artist_id);
$st_date_time= $first_date.TFunc::strToFillZero($time_open, 2)."00";
$fi_date_time= $last_date.TFunc::strToFillZero($time_close, 2)."00";
$st_date_time = str_replace("-", "", $st_date_time);
$fi_date_time = str_replace("-", "", $fi_date_time);
$GetReservationChk = $reserve_sql->qry_get_reservation_chk($artist_id, $worker, $st_date_time, $fi_date_time);

if(TFunc::checkPC() == "PC") {
    $memo_count = 0;
    foreach ($GetReservationChk as $val){
        $tmp_memo = $reserve_sql->qry_get_reservation_chk_memo($val['cellphone'], $val['reservation_date']);
        $GetReservationChk[$memo_count]['etc_memo'] = $tmp_memo[0]['before_memo'];
        $memo_count ++;
    }
}

function artist_reservation_chk($row){
    if($row['is_sunday']==1){
        $regular_break_day[] = 0;
    }
    if($row['is_monday']==1) {
        $regular_break_day[] = 1;
    }
    if($row['is_tuesday']==1) {
        $regular_break_day[] = 2;
    }
    if($row['is_wednesday']==1) {
        $regular_break_day[] = 3;
    }
    if($row['is_thursday']==1) {
        $regular_break_day[] = 4;
    }
    if($row['is_friday']==1) {
        $regular_break_day[] = 5;
    }
    if($row['is_saturday']==1) {
        $regular_break_day[] = 6;
    }

    return $regular_break_day;
}

function data_dash($tmp){
    if ($tmp == ""){
        $tmp = "내용 없음";
        return $tmp;
    }
    $tmp = substr_replace($tmp, '-', 4, 0);
    $tmp = substr_replace($tmp, '-', 7, 0);
    $tmp = substr_replace($tmp, ' ', 10, 0);
    $tmp = substr_replace($tmp, ':', 13, 0);
    return $tmp;
}
?>

<!-- container -->
<section id="container">
    <!-- page-body -->
    <div class="page-body">
        <div class="reserve-calendar-wrap">
            <div class="con-title-group">
                <h4 class="con-title">1. 판매할 시간을 선택하세요.</h4>
            </div>
            <!-- 캘린더 정렬 -->
            <div class="reserve-calendar-sort">
                <div class="sort-left">
                    <!-- actived클래스 추가시 활성화 -->
                    <button type="button" onclick="location.href='reserve_time_sale_step1_2';"
                            class="btn-reserve-calendar-sort actived" >주</button>
                    <button type="button" onclick="location.href='reserve_time_sale_step1_3';"
                            class="btn-reserve-calendar-sort">일</button>

                </div>
                <div class="sort-right">
                    <select>
                        <option value="beauty" selected>미용</option>
                        <!--<option value="hotel">호텔</option>
                        <option value="playroom">유치원</option>-->
                    </select>
                </div>
            </div>
            <!-- //캘린더 정렬 -->
            <!-- 캘린더 상단 -->
            <div class="reserve-calendar-top">
                <button type="button" class="btn-reserve-calendar-ui btn-month-prev"><span class="icon icon-calendar-prev-small"></span></button>
                <div class="reserve-calendar-title">
                    <div class="txt"></div>
                    <!--
                    //	select태그는 투명을로 위로 띄웟고 , change 시 txt클래스내 문구 변경으로 디자인 처리
                    -->
                    <select>
                        <?for($i=-48;$i<0;$i++){?>
                            <option value="<?= (int) date('Y', strtotime($first_date)-86400*7*$i) ?>.<?= (int) date('m', strtotime($first_date)-86400*7*$i) ?>.<?= (int) date('d', strtotime($first_date)-86400*7*$i) ?>" data-rol1="<?= date('m.d', strtotime($first_date)-86400*7*$i) ?>" data-rol2="<?= date('m.d', strtotime($last_date)-86400*7*$i) ?>"><?= (int) date('m', strtotime($first_date)-86400*7*$i) ?>월 <?= (int) date('d', strtotime($first_date)-86400*7*$i) ?>일 ~
                                <?= (int) date('m', strtotime($last_date)-86400*7*$i) ?>월 <?= (int) date('d', strtotime($last_date)-86400*7*$i) ?>일</option>
                        <?}?>
                        <?for($i=0;$i<48;$i++){?>
                            <option <?if($i==0) echo "selected";?> value="<?= (int) date('Y', strtotime($first_date)-86400*7*$i) ?>.<?= (int) date('m', strtotime($first_date)-86400*7*$i) ?>.<?= (int) date('d', strtotime($first_date)-86400*7*$i) ?>" data-rol1="<?= date('m.d', strtotime($first_date)-86400*7*$i) ?>" data-rol2="<?= date('m.d', strtotime($last_date)-86400*7*$i) ?>"><?= (int) date('m', strtotime($first_date)-86400*7*$i) ?>월 <?= (int) date('d', strtotime($first_date)-86400*7*$i) ?>일 ~
                                <?= (int) date('m', strtotime($last_date)-86400*7*$i) ?>월 <?= (int) date('d', strtotime($last_date)-86400*7*$i) ?>일</option>
                        <?}?>
                    </select>
                </div>
                <button type="button" class="btn-reserve-calendar-ui btn-month-next"><span class="icon icon-calendar-next-small"></span></button>
            </div>
            <!-- 캘린더 선택 -->
            <div class="reserve-calendar-master">
                <div class="grid-layout btn-grid-group">
                    <div class="grid-layout-inner">
                        <!-- btn-toggle-button 클래스에 actived클래스 추가시 활성화 -->
                        <?php
                        foreach ((array) $data['artist'] as $key => $artist) {
                            ?>
                            <div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button <?php echo (trim($worker_id) == $artist['name'])?'actived':''; ?>" onclick="location.href='./reserve_time_sale_step1_2?ch=week&yy=<?php echo $_GET['yy'];?>&mm=<?php echo $_GET['mm'];?>&&dd=<?php echo $_GET['dd'];?>&worker=<?php echo $artist['name'];?>';"><?= $artist['nicname'] ?><?=($artist['is_out'] == '1')? ' (퇴)' : '' ?></button></div>

                        <?php } ?>
                        <!--<div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button actived">실장</button></div>
                        <div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button">윤아</button></div>
                        <div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button">마이크리</button></div>
                        <div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button">케이</button></div>
                        <div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button">수</button></div>
                        <div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button">빙빙돌아가는회전목마처럼</button></div>-->
                        <div class="grid-layout-cell flex-auto"><button type="button" class="btn-toggle-button btn-toggle-basic" onclick="location.href='set_teacher';"><span class="icon icon-plus-more-small"></span></button></div>
                    </div>
                </div>
            </div>
            <!-- //캘린더 선택 -->
            <!-- 캘린더 상세 -->
            <div>
                <div class="reserve-calendar-data">
                    <div class="reserve-calendar-inner">
                        <!--
                        // calendar-month-header-col 클래스 정의
                        //	sunday : 일요일
                        //	saturday : 토요일

                        // calendar-month-body-col 클래스 정의
                        //	sunday : 일요일
                        //	saturday : 토요일
                        //	break : 휴무 및 예약금지
                        //	holiday :공휴일
                        // today : 오늘
                        // calendar-drag-item-group : 드래그 가능한 영역
                        // calendar-drag-item : 드래그 아이템
                        -->
                        <!--
                        // calendar-week-time-item 상황별 클래스값
                        // yellow : 앱-선결제
                        // purple : 앱-매장결제
                        // green : 매장예약
                        // red : NoShow
                        // gray : 승인대기
                        -->
                        <div class="calendar-week-wrap">
                            <div class="calendar-week-header">
                                <div class="calendar-week-header-row">
                                    <div class="calendar-week-header-col time"></div>
                                    <?php foreach ($date_week_list as $key => $val) { ?>
                                        <div class="calendar-week-header-col <? if (date('Y-m-d', strtotime($key)) == date('Y-m-d')) { ?>today<? } ?>">
                                            <div class="th"><?= $daily[date('w', strtotime($key))] ?></div>
                                            <div class="day"><a href="reserve_main_day?ch=day&yy=<?= date('Y', strtotime($key)) ?>&mm=<?= date('m', strtotime($key)) ?>&dd=<?= date('d', strtotime($key)) ?>&backurl=<?= urlencode($_SERVER['PHP_SELF']) ?>" class="text_day" style=""><?= (int) date('d', strtotime($key)) ?></a>
                                            </div>
                                        </div>
                                    <?}?>
                                </div>
                            </div>
                            <!-- calendar 시작 -->
                            <div class="calendar-week-body" id="week_body_start">
                                <?php
                                $time_count = 0;
                                $curr_time = (int)(microtime(TRUE) * 1000);
                                for ($h = $time_open; $h < $time_close; $h++) {
                                    $offset_time = ((int)(microtime(TRUE) * 1000)) - $curr_time;
                                    TFunc::console("time_count: " . $time_count." offset_time: ".$offset_time);
                                    $time_count ++;
                                    ?>
                                    <?php
                                    $week_day = substr($first_date,8,2); $cnt = 0;
                                    $time_count_t30 = 0;
                                    for ($t30 = 0; $t30 < 60; $t30 += 30) {
                                        TFunc::console("time_count_t30: " . $time_count_t30);
                                        $time_count_t30 ++;

                                        $thisTime = sprintf('%02d', $h) . ":" . sprintf('%02d', $t30);
                                        $startTime = $h;
                                        $thisTimeEnd = date('H:i',strtotime($thisTime.' +30 minute'));
                                        ?>
                                        <?php if($thisTime <= date('H:i') && $thisTimeEnd > date('H:i') ){ ?>
                                            <div class="calendar-week-current-time" id="time_schedule_<?php echo $thisTime;?>" data-curTime="<?php echo $thisTime;?>" data-nowTime="<?php echo date('H:i');?>"><div class="bar"></div><div class="value"><?php echo date('h:i');?></div></div>
                                        <?php } ?>
                                        <div class="calendar-week-body-row">
                                            <div class="calendar-week-body-col time">
                                                <?php if($thisTime == sprintf('%02d',$tws[0]['working_start']).':00' && $thisTime < '12:00'){ ?>
                                                    <div class="day-division-label">오전</div>
                                                <?php } else if($thisTime == sprintf('%02d',$tws[0]['working_start']).':00' && $thisTime >= '12:00'){ ?>
                                                    <div class="day-division-label">오후</div>
                                                <?php } else if($thisTime == '12:00'){ ?>
                                                    <div class="day-division-label">오후</div>
                                                <?php } else { ?>
                                                    <div class="day-division-label"></div>
                                                <?php } ?>
                                                <div class="time-label"><div class="time-start-label"><?=date('h:i',strtotime($thisTime))?></div><div class="time-end-label"></div></div>
                                            </div>
                                            <?php

                                            $week_list_count = 0;
                                            foreach ($date_week_list as $key => $val) {
                                                TFunc::console("week_list_count: " . $week_list_count);
                                                $week_list_count ++;
                                                unset($crw);
                                                unset($div_class);
                                                //해당 일자에 tb_private_holiday 데이터가 있는지 확인다. 2020-02-24 james
                                                $nowdate = date("Y-m-d",strtotime($first_date." +".$cnt." day"));//현재 날짜
                                                $nowdatetime = strtotime($nowdate." ".$thisTime); //현재날짜시간

//                                                $crw1 = cant_reservation_week($connection, $artist_id, $worker, $nowdate); //날짜만으로 예약금지 일자 검색
                                                $crw =null; //날짜만으로 예약금지 일자 검색
                                                if (count($CantReservationWeek) < 1){
                                                    $crw = null;
                                                }else{
                                                    foreach ($CantReservationWeek as $val){
                                                        if($val['start_datetime'] <= $nowdate." ".$thisTime
                                                            && $val['end_datetime'] > $nowdate." ".$thisTime){
                                                            $crw = $val;
                                                            break;
                                                        }
                                                        $crw = null;
                                                    }
                                                }
                                                $thisTimeTo = date('H:i', date2timestamp(strtotime(date('Y-m-d H:i', strtotime($nowdate . ' ' . $time_open.':00')))));
                                                $thisTimeFrom = date('H:i', date2timestamp(strtotime(date('Y-m-d H:i', strtotime($nowdate . ' ' . $time_close.':00')))));



                                                if(strtotime($crw['start_datetime']) <= $nowdatetime && strtotime($crw['end_datetime']) > $nowdatetime){
                                                    $div_class = 'break';
                                                    $status = '예약금지';
                                                }

                                                //정기휴일 확인.
//                                                $crwn1 = cant_reservation_week_nor($connection, $artist_id);
                                                $crwn = null;
                                                if (count($CantReservationWeekNor) < 1){
                                                    $crwn = null;
                                                }else{
                                                    foreach ($CantReservationWeekNor as $val){
                                                        if(trim($val['customer_id']) == $artist_id){
                                                            $crwn = artist_reservation_chk($val);
                                                            break;
                                                        }
                                                        $crwn = null;
                                                    }
                                                }
                                                $today_disp = date('w',strtotime($nowdate));
                                                if(in_array($today_disp,$crwn)) {
                                                    $div_class = 'break';
                                                    $status = '정기휴일';
                                                }



                                                if($div_class == 'break'){
                                                    $prseq = $crw['ph_seq'];
                                                }

                                                $day_link   = "?ch=day&yy={$yy}&mm={$mm}&dd=".(int) date('d', strtotime($key))."&backurl=" . urlencode($_SERVER['PHP_SELF']);
                                                $select_day = $nowdate;


                                                //해당 일자 예약 가져오기
                                                $is_rev_true = '';

//                                                $chk_rev1 = get_reservation_chk($user_id, $worker_id, date('Y-n-j',strtotime($nowdate)),$thisTime);
                                                $chk_rev = [];
                                                if (count($GetReservationChk) < 1){
                                                    $chk_rev = null;
                                                }else{
                                                    foreach ($GetReservationChk as $val){
                                                        if(trim($val['reservation_date']) == str_replace("-","",$nowdate).str_replace(":","",$thisTime)){
                                                            $chk_rev[] = $val;
                                                            //array_splice($chk_rev, 150, 2);
                                                            break;
                                                        }
                                                        $chk_rev = null;
                                                    }
                                                }

                                                if($chk_rev){
                                                    $is_rev_true = 'go-payment';
                                                }

                                                $star_date_time = strtotime($select_day.' '.$thisTime);

                                                $cur_dt = $nowdate.' '.$thisTime;
                                                ?>
                                                <div class="calendar-week-body-col <?=$div_class?> ">

                                                    <?php if($div_class != 'break'){ ?>
                                                        <div class="calendar-drag-item-group">
                                                            <?php

                                                            if($cnt == 6) {
                                                                $week_day = substr($first_date,8,2);
                                                                $cnt = 0;
                                                            } else {
                                                                $cnt++;
                                                            }

                                                            ?>


                                                            <?php
                                                            if(!empty($chk_rev)){//예약이 있을 경우
                                                                for($a=0;$a<count($chk_rev);$a++){
                                                                    $type = explode("|",$chk_rev[$a]['product']);
                                                                    $time_start = strtotime($yy.'-'.$mm.'-'.$dd.' '.$thisTime);
                                                                    $time_end = strtotime($yy.'-'.$mm.'-'.$dd.' '.$chk_rev[$a]['to_hour'].':'.$chk_rev[$a]['to_minute']);
                                                                    if($chk_rev[$a]['is_no_show']==1){
                                                                        $style_height = 100;
                                                                    } else {
                                                                        //기본 미용 선택이 없을경우 100으로 만든다.
                                                                        $binfo = explode("|",$chk_rev[$a]['product']);

                                                                        /*if(empty($binfo[3])){
                                                                            $style_height = 100;
                                                                        } else {*/
                                                                        $style_height = make_rev_calc_height($time_start,$time_end);
                                                                        //}
                                                                    }

                                                                    ?>
                                                                    <!-- 해당 일자 일정 표시-->
                                                                    <div class="calendar-week-time-item no-reservation " data-pay_seq="<?php echo $chk_rev[$a]['payment_log_seq'];?>"  style="height:calc( <?=$style_height?>% - 1px );cursor:pointer; border:none !important;background-color:#f4f4f4;">

                                                                    </div>
                                                                    <!-- 해당 일자 일정 표시 끝-->
                                                                    <?php
                                                                }} else { //예약이 없을경우
                                                                print_r($chk_rev);
                                                                ?>

                                                                <div class="calendar-check-value">
                                                                    <label class="form-radiobox large">
                                                                        <?php if($div_class != 'no-reservation'){ ?>
                                                                            <input type="checkbox" id="check_time_sale" class="time-chk" <?php if(in_array($cur_dt,$ed)) { echo 'checked'; }?> value="<?php echo $nowdate.' '.$thisTime;?>" onclick="fn_time_sale()"><span class="form-check-icon"><em></em></span>
                                                                        <?php } ?>
                                                                    </label>
                                                                </div>
                                                                <?php
                                                                //print_r($res_time['datetime']);
                                                            } //예약이 없을경우 끝

                                                            ?>
                                                        </div>
                                                    <?php } else { ?>
                                                        <?php
                                                        if($status == '정기휴일' && $thisTime == '09:00'){
                                                            echo $status;
                                                        }

                                                        if($status == '예약금지' && substr($crw['start_datetime'],-5) == $thisTime){
                                                            echo $status;
                                                        }
                                                        if($cnt == 6) {
                                                            $cnt = 0;
                                                        } else {
                                                            $cnt++;
                                                        }
                                                        ?>

                                                    <?php } ?>
                                                </div>
                                            <?php } ?>
                                        </div>
                                    <?php } ?>
                                <?php } ?>
                                <!-- 20220211 수정 : 현재시간 추가 -->
                                <!--<div class="calendar-week-current-time" style="top:15%;"><div class="bar"></div><div class="value"><?php /*echo date('H:i');*/?></div></div>-->
                                <!-- //20220211 수정 : 현재시간 추가 -->
                            </div>
                            <!-- calendar 끝 -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- //캘린더 상세 -->
        </div>
    </div>


    <!-- 일자 클릭시 예약설정 팝업 보기 -->
    <article id="reserveCalendarPop2" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">
                <div class="pop-data alert-pop-data">
                    <div class="pop-header">
                        <h4 class="con-title">실장</h4>
                    </div>
                    <div class="pop-body type-3">
                        <div class="msg-txt"><span class="msg-txt-date">2021.09.08</span>&nbsp;&nbsp;&nbsp;&nbsp;<span  class="msg-txt-time">오후 01:30</span></div>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm btn-reserv-block" onclick="pop.close();">예약금지설정</button>
                        <button type="button" class="btn btn-confirm btn-reserv-send">예약접수</button>
                    </div>
                </div>
            </div>
        </div>
    </article>

    <!-- 일자 클릭시 예약설정금지 취소 팝업 보기 -->
    <article id="reserveCalendarPop10" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">
                <div class="pop-data alert-pop-data">
                    <div class="pop-header">
                        <h4 class="con-title">설정된 예약금지를 해제하시겠습니까?</h4>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm btn-reserv-block-cancel">예</button>
                        <button type="button" class="btn btn-confirm btn-reserv-send" onclick="$('#reserveCalendarPop10').removeClass('actived');">아니요</button>
                    </div>
                </div>
            </div>
        </div>
    </article>


    <article id="reserveCalendarPop3" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">

                <div class="pop-data alert-pop-data">
                    <div class="pop-header">
                        <h4 class="con-title">예약금지 설정</h4>
                    </div>
                    <div class="pop-body type-3">
                        <form name="form_time" id="form_time">
                            <input type="hidden" name="ph_type" value="notall">
                            <input type="hidden" name="ph_worker" value="">
                            <input type="hidden" name="ph_start_year" id="year" value="<?php echo $_GET['yy'];?>">
                            <input type="hidden" name="ph_start_month" id="month" value="<?php echo $_GET['mm'];?>">
                            <input type="hidden" name="ph_start_day" id="day" value="<?php echo $_GET['dd'];?>">



                            <div class="form-group">
                                <div class="form-group-cell">
                                    <div class="form-group-item">
                                        <div class="form-item-label">시간</div>
                                        <div class="form-item-data type-2">
                                            <div class="form-datepicker-group">
                                                <div class="form-datepicker">
                                                    <select name="ph_start_time">
                                                        <option value="">오전 11:30</option>
                                                    </select>
                                                </div>
                                                <div class="form-unit">~</div>
                                                <div class="form-datepicker">
                                                    <select name="ph_end_time">
                                                        <option value="">오후 11:30</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </form>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm btn-holiday-submit">저장</button>
                        <button type="button" class="btn btn-confirm" onclick="pop.close();">취소</button>
                    </div>
                </div>

            </div>
        </div>
    </article>

    <!-- 예약변경 -->
    <article id="reserveCalendarPop4" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">
                <div class="pop-data alert-pop-data">
                    <div class="pop-header">
                        <h4 class="con-title">실장</h4>
                    </div>
                    <div class="pop-body type-3">
                        <div class="msg-txt"><span class="msg-text-date">2021.09.08</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="msg-text-time">오후 01:30</span><br><br>선택한 예약을<br>이 곳으로 변경합니다.</div>
                        <form name="form_change" id="form_change">
                            <input type="hidden" name="log_type" value="check">
                            <input type="hidden" name="log_seq" value="">
                            <input type="hidden" name="log_worker" value="">
                            <input type="hidden" name="log_date" id="year" value="">
                            <input type="hidden" name="log_start_time" id="month" value="">
                            <input type="hidden" name="log_end_time" id="day" value="">
                        </form>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm btn-change-submit" onclick="pop.close();">확인</button>
                        <button type="button" class="btn btn-confirm btn-reserv-cancel" onclick="pop.close();">예약변경취소</button>
                    </div>
                </div>
            </div>
        </div>
    </article>
    <!-- //예약변경 -->

    <!-- 예약변경 불가 -->
    <article id="reserveCalendarPop5" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">
                <div class="pop-data alert-pop-data">
                    <div class="pop-body">
                        <div class="msg-txt">해당 스케줄에 일정이 있어 스케줄 변경이 불가합니다.</div>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm" onclick="pop.close();">확인</button>
                    </div>
                </div>
            </div>
        </div>
    </article>
    <!-- //예약변경 불가 -->
    <!-- 예약변경 불가 -->
    <article id="reserveCalendarPop99" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">
                <div class="pop-data alert-pop-data">
                    <div class="pop-body">
                        <div class="msg-txt">해당 스케줄에 일정이 있어 스케줄 변경이 불가합니다.</div>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm" onclick="popalert.close();">확인</button>
                    </div>
                </div>
            </div>
        </div>
    </article>
    <!-- //예약변경 불가 -->

    <!--예약변경-->
    <article id="reserveCalendarPop99" class="layer-pop-wrap" style="z-index: 100000;">
        <form action="./data/get_book_data_ajax" method="post" name="changeRevFrm" id="changeRevFrm">
            <input type="hidden" name="mode" value="changeRev">
            <input type="hidden" name="date" id="date" value="">
            <input type="hidden" name="time" id="time" value="">
            <input type="hidden" name="worker" id="wk" value="">
            <div class="layer-pop-parent">
                <div class="layer-pop-children">
                    <div class="pop-data alert-pop-data">
                        <div class="pop-header">
                            <h4 class="con-title"></h4>
                        </div>
                        <div class="pop-body type-3">
                            <div class="msg-txt"><span id="thisDate"></span>&nbsp;&nbsp;&nbsp;&nbsp; <span id="thisTime"></span><br><br>선택한 예약을<br>이 곳으로 변경합니다.</div>
                            <div>
                                <br>
                                예약접수알림
                                <input type="radio" name="msg_send" value="y" checked> 발송
                                <input type="radio" name="msg_send" value="n"> 미발송
                            </div>
                        </div>
                        <div class="pop-footer">
                            <button type="button" class="btn btn-confirm" onclick="reserve_change_chk('y');pop.close();">확인</button>
                            <button type="button" class="btn btn-confirm" onclick="reserve_change_chk('n');pop.close();">예약변경취소</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        </div>
    </article>
    <!-- //page-body -->
    <!-- page-bottom -->
    <div class="page-bottom">
        <!--
        //	비활성화시
        // - a태그는 disabled 클래스 추가
        // - button 태그는 disabled 속성 추가
        -->
        <a href="javascript:;" class="btn-page-bottom selected-done"><span id="time_sale_count"><?php echo $total_cnt;?></span>타임 선택완료</a>
    </div>
    <!-- //page-bottom -->
</section>
<!-- //container -->
<!-- 선택된 데이터 넘기기 위한 폼-->
<form action="./reserve_time_sale_step2_1" method="post" name="frm">
    <input type="hidden" name="worker" value="<?php echo $worker_id;?>">
    <input type="hidden" name="year" value="<?php echo $yy;?>">
    <input type="hidden" name="month" value="<?php echo $mm;?>">
    <input type="hidden" name="day" value="<?php echo $dd;?>">
    <textarea name="choose_date" id="choose_date" cols="30" rows="10" style="display: none;"></textarea>
</form>
<!-- 20220225 수정 : 페이지 전체용 커버 추가 -->
<div class="page-cover"></div>
<!-- //20220225 수정 -->

<script src="/static/pub/js/Sortable.min.js"></script>

<script>
    var EMPTY_TIME = new Array();
    $(function(){






        $(".time_payment").on('click',function(){
            var change_rev = '<?php echo (isset($_SESSION['payment_seq']))?true:false;?>';
            thisDate = $(this).attr('data-date');
            thisTime = $(this).attr('data-time');
            thisWorker = $(this).data('worker2');
            thisTimeStart   = $(this).data('time-to');
            thisTimeEnd   = $(this).attr('data-time-from');
            thisWorker2 = $(this).data('worker')




            if($(this).find(".calendar-week-time-item").length==0 && $(this).hasClass("break")===false){
                $("#reserveCalendarPop2 .con-title").text(thisWorker);
                $("#reserveCalendarPop2 .msg-txt-date").text(thisDate);
                $("#reserveCalendarPop2 .msg-txt-time").text(thisTime);


                console.log(thisTimeStart+':'+thisTimeEnd)
                $('#reserveCalendarPop2 .btn-reserv-block').data('date1',thisDate);
                $('#reserveCalendarPop2 .btn-reserv-block').data('startTime',thisTimeStart);
                $('#reserveCalendarPop2 .btn-reserv-block').data('endTime',thisTimeEnd);

                if(change_rev == false) {
                    $("#reserveCalendarPop2 .btn-reserv-send").on('click', function () {
                        location.href = './reserve_accept?worker=' + thisWorker + '&workTime=' + thisTime + '&workDate=' + thisDate ;
                    });
                    pop.open('reserveCalendarPop2');
                } else {

                    $('#date').val(thisDate);
                    $('#time').val(thisTime);
                    $('#wk').val(thisWorker);
                    $('#reserveCalendarPop99 .con-title').text(thisWorker2);
                    $('#reserveCalendarPop99 #thisDate').text(thisDate);
                    $('#reserveCalendarPop99 #thisTime').text(thisTime);
                    pop.open('reserveCalendarPop99');
                }
                return false;
            }
        });

        var now_date = new Date();
        var now_hours = now_date.getHours();
        var now_m = now_date.getMinutes();


        var line_hieght = ((now_hours-9)*60+now_m)*2.07;
        //console.log((((18-9)*100+now_m)/100));
        if(line_hieght>0 && line_hieght<1240){
            $(".calendar-day-current-time").css("top",line_hieght+"px");
        }else{
            $(".calendar-day-current-time").hide();
        }


        var obj_dialog_time_form = $("#reserveCalendarPop3");
        var obj_form_time = obj_dialog_time_form.find("#form_time");

        $(".btn-reserv-block").on('click',function(){



            var thisDate = $(this).data('date1');
            var thisTimeStart = $(this).data('startTime');
            var thisTimeEnd = $(this).data('endTime');
            var arrDate = thisDate.split('-');




            obj_form_time[0].reset();
            obj_form_time.find('input[name="ph_worker"]').val(thisWorker);
            obj_form_time.find('input#year').val(Number(arrDate[0]));
            obj_form_time.find('input#month').val(Number(arrDate[1]));
            obj_form_time.find('input#day').val(Number(arrDate[2]));



            var timeStart = new Date((thisDate + ' ' + thisTimeStart).replace(/-/g, "/")).getTime() / 1000;
            var timeEnd = new Date((thisDate + ' ' + thisTimeEnd).replace(/-/g, "/")).getTime() / 1000;

            console.log(timeStart+' : '+timeEnd)
            //console.log('예약금지설정 팝업창', 'open', thisDate, timeStart, timeEnd);
            // 시작시간
            var obj_res_time = obj_form_time.find('select[name="ph_start_time"]');
            obj_res_time.empty();
            for (var t = timeStart; t < timeEnd; t += (60 * 30)) {
                var obj_res_time_option = $('<option></option>');
                var obj_date = new Date(t * 1000);
                var val_date = '';
                val_date += (String(obj_date.getHours()).length == 1 ? '0' : '') + obj_date.getHours();
                val_date += ':';
                val_date += (String(obj_date.getMinutes()).length == 1 ? '0' : '') + obj_date.getMinutes();

                obj_res_time_option.val(val_date).text(val_date).attr('data-timestamp', t);
                if (val_date == thisTime) obj_res_time_option.prop('selected', true); // 선택된 시간을 선택한다.
                console.log(obj_res_time)
                obj_res_time_option.appendTo(obj_res_time);
            }

            // 끝시간
            var obj_res_time2 = obj_form_time.find('select[name="ph_end_time"]');
            obj_res_time2.empty();
            for (var t = timeStart + (60 * 30); t <= timeEnd; t += (60 * 30)) {
                var obj_res_time_option2 = $('<option></option>');
                var obj_date = new Date(t * 1000);
                var val_date = '';
                val_date += (String(obj_date.getHours()).length == 1 ? '0' : '') + obj_date.getHours();
                val_date += ':';
                val_date += (String(obj_date.getMinutes()).length == 1 ? '0' : '') + obj_date.getMinutes();

                obj_res_time_option2.val(val_date).text(val_date).attr('data-timestamp', t);
                obj_res_time_option2.appendTo(obj_res_time2);
            }

            // 종료시점의 시간을 선택한다.
            var data_timestamp = Number(obj_res_time.find('>option').filter(':selected').data('timestamp')) + (60 * 30 * 4); // 2시간 후 timestamp
            if (obj_res_time2.find('>option').last().data('timestamp') < data_timestamp) {
                obj_res_time2.find('>option').last().prop('selected', true);
            } else {
                obj_res_time2.find('>option').each(function() {
                    if ($(this).data('timestamp') == data_timestamp) {
                        $(this).prop('selected', true);
                    }
                });
            }

            obj_res_time2.focus();


            pop.open('reserveCalendarPop3');




        });

        var now_date = new Date();
        var now_hours = now_date.getHours();
        var now_m = now_date.getMinutes();


        var line_hieght = ((now_hours-9)*60+now_m)*2.07;
        //console.log((((18-9)*100+now_m)/100));
        if(line_hieght>0 && line_hieght<1240){
            $(".calendar-day-current-time").css("top",line_hieght+"px");
        }else{
            $(".calendar-day-current-time").hide();
        }


        var obj_dialog_time_form = $("#reserveCalendarPop3");
        var obj_form_time = obj_dialog_time_form.find("#form_time");


        //예약금지설정 저장 버튼 클릭시
        $(".btn-holiday-submit").click(function(){
            var data_form = obj_form_time.serialize();
            $.ajax({
                async: false,
                type: 'post',
                url: 'data/data_set_private_holiday',
                data: data_form,
                dataType: 'json',
                error: function(request,status,error) {
                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error)
                    document.location.reload(true);
                },
                success: function(json) {
                    console.log(json);
                    if (json !== undefined) {
                        if (json.res == true) {
                            document.location.reload(true);
                        } else {
                            console.log(json);
                            //$.MessageBox(json.error);
                        }
                    }
                    // document.location.reload(true);
                }
            });
        });

        //예약금지설정 취소
        $('.btn-reserv-block-cancel').on('click',function(){
            console.log($(this).data('worker')+':'+$(this).data('phseq'));
            var artist_id = '<?php echo $artist_id?>';
            var worker_id = $(this).data('worker');
            var phseq = $(this).data('phseq');
            if(!artist_id){
                alert('아티스트 아이디가 없습니다.');
                document.location.reload(true);
                return false;
            }
            if(!worker_id){
                alert('미용사 아이디가 없습니다.');
                document.location.reload(true);
                return false;
            }
            if(!phseq){
                alert('해당 날짜데이터가 없습니다.');
                document.location.reload(true);
                return false;
            }
            console.log('aaa')

            $.ajax({
                async: false,
                type: 'post',
                url: './data/data_set_private_holiday_cancel',
                data: {'aid':artist_id, 'wid':worker_id, 'idx':phseq},
                dataType: 'json',
                error: function(request,status,error) {

                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error)
                    document.location.reload(true);
                },
                success: function(json) {
                    console.log(json)
                    if (json !== undefined) {
                        if (json.flag == true) {
                            document.location.reload(true);
                        } else {
                            alert(json.error);
                        }
                        //obj_dialog_time_cancel.dialog("close");
                    }
                }
            });
        })


        $(".time_payment_link").on('click', function(e) {
            e.preventDefault();
            // console.log('time_payment_link');

            var obj_this = $(this);
            var dat_customer_id = obj_this.attr('data-customer-id');
            var dat_order_id = obj_this.attr('data-order-id'); // 주문아이디
            var dat_payment_log_seq = obj_this.attr('data-payment-log-seq'); // 주문아이디

            var obj_time_cell = obj_this.parent().parent();
            var obj_artist_line = obj_this.closest('td');


            // 선택가능 시작시점 조사
            var obj_time_cell_prev = obj_time_cell;

            //console.log(obj_time_cell_prev.hasClass('time_payment'));
            // console.log( 'obj_time_cell_prev.length' , obj_time_cell_prev.length );
            var val_time_blank_count = 0;

            var thisTimeStart = obj_time_cell_prev.attr('data-time-to');
            var thisTimeEnd = obj_time_cell_prev.attr('data-time-from');

            // console.log( 'thisTimeStart' , thisTimeStart );
            // 선택가능 시작시점 조사

            // 선택가능 종료시점 조사
            var obj_time_cell_next = obj_time_cell.next();
            var obj_time_cell_all = obj_artist_line.find('>div');
            var val_time_blank_count_max = obj_time_cell_all.length;

            // console.log( obj_time_cell_next.index() , val_time_blank_count_max );

            for (var i = obj_time_cell_next.index(); i < val_time_blank_count_max; i++) {
                // console.log( 'data-time' , obj_time_cell_next.attr('data-time-to') , obj_time_cell_next.attr('data-time-from') , i , obj_time_cell_next.attr('class') );
                var obj_time_cell_next = obj_artist_line.find('>div').eq(i);
                if (!obj_time_cell_next.length) break;
                var idx = i - 1;
                // obj_time_cell_next = obj_artist_line.find('>div').eq(idx);
                // console.log( 'obj_time_cell_next' , i , val_time_blank_count_max , obj_time_cell_next.attr('class') );
                if (obj_time_cell_next.hasClass('time_payment')) {
                    idx = i - 1;
                    var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i+1);
                    thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    // console.log('time_payment', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                    i = val_time_blank_count_max;
                    continue;
                } else
                    // res는 무시한다.
                    // if ( obj_time_cell_next.hasClass('res') ) {
                    //     idx = i-1;
                    //     var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    //     // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                    //     thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    //     // console.log( 'thisTimeEnd res' , thisTimeEnd , i , obj_time_cell_next.attr('class') );
                    //     i = val_time_blank_count_max;
                    //     continue;
                    // } else
                if (obj_time_cell_next.hasClass('not')) {
                    idx = i - 1;
                    var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                    thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    // console.log('not', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                    i = val_time_blank_count_max;
                    continue;
                } else
                    // if ( obj_time_cell_next.hasClass('res') ) {
                    //     idx = i-1;
                    //     var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    //     // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                    //     thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    //     // console.log( 'thisTimeEnd res' , thisTimeEnd , i , obj_time_cell_next.attr('class') );
                    //     i = val_time_blank_count_max;
                    //     continue;
                    // } else
                if (obj_time_cell_next.hasClass('ing')) {
                    idx = i - 1;
                    var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                    thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    // console.log('ing', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                    i = val_time_blank_count_max;
                    continue;
                } else
                if (obj_time_cell_next.hasClass('holiday')) {
                    idx = i - 1;
                    var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                    thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    // console.log('holiday', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                    i = val_time_blank_count_max;
                    continue;
                } else {
                    idx = i;
                    var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i);
                    thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    // console.log('thisTimeEnd normal', thisTimeEnd, i);
                }
            }
            // console.log( 'thisTimeEnd' , thisTimeEnd , val_time_blank_count_max );
            // 선택가능 종료시점 조사

            // console.log(thisTimeStart, thisTimeEnd);

            var param = '';
            if (dat_payment_log_seq !== undefined && dat_payment_log_seq) {
                param += (param ? '&' : '?') + 'payment_log_seq=' + dat_payment_log_seq;
            }
            if (thisTimeStart !== undefined && thisTimeStart) {
                param += (param ? '&' : '?') + 'thisTimeStart=' + thisTimeStart;
            }
            if (thisTimeEnd !== undefined && thisTimeEnd) {
                param += (param ? '&' : '?') + 'thisTimeEnd=' + thisTimeEnd;
            }
            param += (param ? '&' : '?') + 'backurl=' + encodeURIComponent(window.location.href);
            var link_view = (dat_customer_id !== undefined && dat_customer_id) ? 'reserve_time_sale_step1_2' + param : 'reserve_time_sale_step1_2' + param;
            console.log(link_view);

            // var

            // console.log('link_view', link_view);
            document.location.href = link_view;
            return false;
        });




        //$(".reserve-calendar-top select").val('<?= (int) date('Y', strtotime($first_date)) ?>.<?= (int) date('m', strtotime($first_date)) ?>.<?= (int) date('d', strtotime($first_date)) ?>');
        $(".reserve-calendar-top .txt").text($(".reserve-calendar-top select option:selected").attr("data-rol1")+" ~ "+$(".reserve-calendar-top select option:selected").attr("data-rol2"));
        var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
        if(idx==0){
            $(".btn-month-next").hide();
        }

        if(idx==11){
            $(".btn-month-prev").hide();
        }


        $(".reserve-calendar-top select").change(function () {

            var yymm    = $(this).val().split(".");
            var worker = '<?php echo $worker_id;?>';
            if(yymm[1]>=10){
                location.href="reserve_time_sale_step1_2?ch=week&yy="+yymm[0]+"&mm="+yymm[1]+"&dd="+yymm[2]+'&worker='+worker;
            }else if(yymm[1]<10 && yymm[2]<10){
                location.href="reserve_time_sale_step1_2?ch=week&yy="+yymm[0]+"&mm="+yymm[1].replace("0","")+"&dd="+yymm[2].replace("0","")+'&worker='+worker;
            }else if(yymm[1]>10 && yymm[2]<10){
                location.href="reserve_time_sale_step1_2?ch=week&yy="+yymm[0]+"&mm="+yymm[1]+"&dd="+yymm[2].replace("0","")+'&worker='+worker;
            }else{
                location.href="reserve_time_sale_step1_2?ch=week&yy="+yymm[0]+"&mm="+yymm[1].replace("0","")+"&dd="+yymm[2]+'&worker='+worker;
            }

        });

        $(".btn-month-prev").on('click',function (e) {
            var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
            $('.reserve-calendar-top select option:eq(' + (idx+1) + ')').prop('selected', 'selected').change();
            e.preventDefault();
        });

        $(".btn-month-next").click(function (e) {
            var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
            $('.reserve-calendar-top select option:eq(' + (idx-1) + ')').attr('selected', 'selected').change();
            e.preventDefault();

        });

        console.log($(".calendar-week-body").height());


        var now_date = new Date();
        var now_hours = now_date.getHours();
        var now_m = now_date.getMinutes();


        var line_hieght = ((now_hours-9)*60+now_m)*2.07;
        //console.log((((18-9)*100+now_m)/100));
        if(line_hieght>0 && line_hieght<1240){
            $(".calendar-week-current-time").css("top",line_hieght+"px");
        }else{
            $(".calendar-week-current-time").hide();
        }

        $(document).on('click','.go-payment',function(){
            var seq = $(this).data('pay_seq');
            location.href='./reserve_pay_management_2?payment_log_seq='+seq;
        })


    });

    function fn_time_sale() {
        var count = 0;
        var chk_date = new Array;
        var artist_id = '<?php echo $artist_id;?>';
        var worker = '<?php echo $worker;?>';
        $('.time-chk').each(function () {
            if ($(this).is(':checked') == true) {
                console.log($(this).val())
                chk_date.push($(this).val());
                count++;
            }
        });

        $.ajax({
            type : 'post',
            url : './data/get_book_data_ajax.php',
            data : {'mode':'awaitAdd','artist_id':artist_id,'worker':worker,'data':chk_date},
            dataType : 'json',
            success : function(json){
                console.log(json.sql);
                $('#time_sale_count').text(json.cnt);
            }
        });

        //$("#time_sale_count").text(count);
    }



    //금주 빈시간 전체선택
    $(document).on('click','#chkAll',function(){

        var cnt = 0;
        var date_text = '';
        if($(this).is(':checked')==true) {
            $('.time-chk').each(function () {
                if ($(this).is(':checked') == false) {
                    $(this).prop('checked', true);
                }

                $('#empty_title').text('금주 빈시간 전체해제');
                cnt++;
            });
            $('.time-chk').each(function () {
                if ($(this).is(':checked') == true) {
                    date_text += $(this).val()+'|';
                }
            });

            $('#choose_date').val(date_text);
            $('#time_sale_count').text(cnt);
        } else {
            $('.time-chk').each(function () {
                if ($(this).is(':checked') == true) {
                    $(this).prop('checked', false);
                }
                $('#empty_title').text('금주 빈시간 전체선택');
            });
            $('#time_sale_count').text('0');
        }
    });

    //선택완료
    $(document).on('click','.selected-done',function(){
        var cnt = 0;
        var date_text = '';
        $('.time-chk').each(function () {
            if ($(this).is(':checked') == true) {
                date_text += $(this).val()+'|';
                cnt++;
            }
        });
        $('#choose_date').val(date_text);
        if(!cnt){
            popalert.open('reserveCalendarPop99','최소한 한개 이상 타임을 선택해주세요.');
            return false;
        }

        if(!date_text){
            popalert.open('reserveCalendarPop99','데이터 선택에 오류가 있습니다. 새로고침 후 다시 선택해주세요.');
            return false;
        }
        document.frm.submit();
    });

    $(document).ready(function(){
        $('#empty_time_bar').css('display','block');
        $('#header_bell').css('display','none');
        $('#time_sale_count').text('<?php echo $total_cnt;?>');
        <?php /*if(isset($_SESSION['empty_reg'])){ */?>/*
        popalert.open('reserveCalendarPop5','빈시간 판매가 정상적으로 등록되었습니다.');
        */<?php /*unset($_SESSION['empty_reg']);} */?>
    });
</script>
