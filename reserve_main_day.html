<?
include($_SERVER['DOCUMENT_ROOT']."/include/global.php");
include($_SERVER['DOCUMENT_ROOT'] . "/common/TFunc.php");
include($_SERVER['DOCUMENT_ROOT'] . "/common/TSql.php");

$artist_flag = (isset($_SESSION['artist_flag'])) ? $_SESSION['artist_flag'] : "";

if ($artist_flag === true) {
    $artist_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_name = (isset($_SESSION['shop_user_nickname'])) ? $_SESSION['shop_user_nickname'] : "";
} else {
    $artist_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_name = (isset($_SESSION['gobeauty_user_nickname'])) ? $_SESSION['gobeauty_user_nickname'] : "";
}

$yy = (isset($_GET['yy']) && $_GET['yy']) ? $_GET['yy'] : date('Y');
$mm = (isset($_GET['mm']) && $_GET['mm']) ? $_GET['mm'] : date('m');
$dd = (isset($_GET['dd']) && $_GET['dd']) ? $_GET['dd'] : date('d');



$shop_title	= "예약관리";
include($_SERVER['DOCUMENT_ROOT']."/include/skin/header_shop.php");
include($_SERVER['DOCUMENT_ROOT']."/include/check_login_shop.php");

unset($_SESSION['backurl1']);
$_SESSION['backurl1'] = 'reserve_main_day?ch=day&yy='.$_GET['yy'].'&mm='.$_GET['mm'].'&&dd='.$_GET['dd'];
unset($_SESSION['backurl2']);
$_SESSION['backurl2'] = 'reserve_main_day';

$from = $_GET['from'];

$sql = array();
$data = array();
$wait_count = 0;

$ch = (isset($_GET['ch']) && $_GET['ch']) ? $_GET['ch'] : 'month';
$yy = (isset($_GET['yy']) && $_GET['yy']) ? $_GET['yy'] : date('Y');
$mm = (isset($_GET['mm']) && $_GET['mm']) ? $_GET['mm'] : date('m');
$dd = (isset($_GET['dd']) && $_GET['dd']) ? $_GET['dd'] : date('d');
$week = $_GET['week'];

$backurl = $_GET['backurl'];

$daily = array('일', '월', '화', '수', '목', '금', '토');
$selected_date = $yy . "-" . $mm . "-" . $dd;

$y_yy = date("Y", strtotime($selected_date . "-1day"));
$y_mm = date("m", strtotime($selected_date . "-1day"));
$y_dd = date("d", strtotime($selected_date . "-1day"));
$t_yy = date("Y", strtotime($selected_date . "+1day"));
$t_mm = date("m", strtotime($selected_date . "+1day"));
$t_dd = date("d", strtotime($selected_date . "+1day"));

// 오늘 날짜
$today_year = date("Y");
$today_month = date("m");
$today_day = date("d");

// var_dump($_SESSION);

$shop_sql = "select * from tb_shop where customer_id = '" . $user_id . "'";
$shop_result = mysqli_query($connection, $shop_sql);
if ($shop_datas = mysqli_fetch_object($shop_result)) {
    $front_image = $shop_datas->front_image;
    $name = $shop_datas->name;
    $working_years = $shop_datas->working_years;
    $self_introduction = $shop_datas->self_introduction;
    $professional_field = $shop_datas->professional_field;
    $career = $shop_datas->career;
    $license_indexs = $shop_datas->license_indexs;
    $region_and_cost = $shop_datas->region_and_cost;
    $enable_flag = $shop_datas->enable_flag;
    $update_time = $shop_datas->update_time;

    //----- 상담 대기 건수 조회
    $pet_sql =
        "SELECT count(tpl.payment_log_seq) AS wait_count
            FROM tb_payment_log tpl, tb_mypet tm, tb_customer tc
            WHERE tpl.approval = 0
            AND tpl.pet_seq = tm.pet_seq 
            AND tpl.customer_id = tc.id
			AND tc.enable_flag = 1
            AND timestampdiff(minute, update_time, now()) < 720
            AND tpl.artist_id = '{$user_id}'";
    $pet_result = mysqli_query($connection, $pet_sql);
    // error_log('----- $pet_sql : ' . $pet_sql);
    if ($pet_result_rows = mysqli_fetch_object($pet_result)) {
        $wait_count = $pet_result_rows->wait_count;
    }

    //크기 데이터,  상품 데이터
    $dog_static_query = "SELECT *, second_type AS product_type FROM tb_product_dog_static WHERE customer_id = '{$user_id}'";
    $dog_static_result = mysqli_query($connection, $dog_static_query);
    $dog_static_list = array();
	$dog_static_list2 = array(); // worktime
    $dog_service_list = array();
    while ($dog_static_data = mysqli_fetch_object($dog_static_result)) {
        $product_type = $dog_static_data->product_type;
        $dog_static_list[] = $product_type;

        $sanitation = $dog_static_data->sanitation_price;
        $bath = $dog_static_data->bath_price;
        $part = $dog_static_data->part_price;
        $bath_part = $dog_static_data->bath_part_price;
        $all = $dog_static_data->all_price;
        $spoting = $dog_static_data->spoting_price;
        $summercut = $dog_static_data->summercut_price;
        $scissors = $dog_static_data->scissors_price;

        if ($bath != null && $bath != "") {
            $dog_service_list[$product_type]["목욕"] = "목욕";
			$dog_static_list2[1] = "목욕";
        }

        if ($part != null && $part != "") {
            $dog_service_list[$product_type]["부분미용"] = "부분미용";
			$dog_static_list2[2] = "부분미용";
        }

        if ($bath_part != null && $bath_part != "") {
            $dog_service_list[$product_type]["부분+목욕"] = "부분+목욕";
			$dog_static_list2[3] = "부분+목욕";
        }

        if ($all != null && $all != "") {
            $dog_service_list[$product_type]["전체미용"] = "전체미용";
			$dog_static_list2[4] = "전체미용";
        }

        if ($spoting != null && $spoting != "") {
            $dog_service_list[$product_type]["스포팅"] = "스포팅";
			$dog_static_list2[5] = "스포팅";
        }

        if ($scissors != null && $scissors != "") {
            $dog_service_list[$product_type]["가위컷"] = "가위컷";
			$dog_static_list2[6] = "가위컷";
        }

		if ($sanitation != null && $sanitation != "") {
            $dog_service_list[$product_type]["위생"] = "위생";
			$dog_static_list2[7] = "위생";
        }

        if ($summercut != null && $summercut != "") {
            $dog_service_list[$product_type]["썸머컷"] = "썸머컷";
			$dog_static_list2[8] = "썸머컷";
        }

        // if (($sanitation != null && $sanitation != "") && ($summercut != null && $summercut != "")) {
        //     $dog_service_list[$product_type] = ["위생" => "위생", "목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "썸머컷" => "썸머컷", "가위컷" => "가위컷"];
        // } else if (($sanitation != null && $sanitation != "") && ($summercut == null || $summercut == "")) {
        //     $dog_service_list[$product_type] = ["위생" => "위생", "목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "가위컷" => "가위컷"];
        // } else if (($sanitation == null || $sanitation == "") && ($summercut != null && $summercut != "")) {
        //     $dog_service_list[$product_type] = ["목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "썸머컷" => "썸머컷", "가위컷" => "가위컷"];
        // } else {
        //     $dog_service_list[$product_type] = ["목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "가위컷" => "가위컷"];
        // }
    }

	$dog_worktime_query = "SELECT * FROM tb_product_dog_worktime WHERE artist_id = '".$user_id."' AND is_delete = '2' ";
	$dog_worktime_result = mysqli_query($connection, $dog_worktime_query);
	$dog_worktime_cnt = mysqli_num_rows($dog_worktime_result);
	$dog_worktime_list = array(); 
	$dog_worktime_txt = array("dog","목욕","부분미용","부분+목욕","전체미용","스포팅","가위컷","위생","썸머컷");
	// 순서대로 목욕,부분미용,부분+목욕,전체미용,스포팅,가위컷,위생,썸머컷
	if($dog_worktime_cnt > 0){
		while($dog_worktime_data = mysqli_fetch_assoc($dog_worktime_result)){
			for($_i = 1; $_i <= 8; $_i++){
				foreach($dog_static_list2 AS $key => $value){
					if($dog_worktime_txt[$_i] == $value){
						$dog_worktime_list[$value] = $dog_worktime_data["worktime".$_i];
					}
				}
			}
		}
	}else{
		$dog_worktime_list = array(
			"dog" => "dog",
			"목욕" => "120",
			"부분미용" => "120",
			"부분+목욕" => "120",
			"전체미용" => "120",
			"스포팅" => "120",
			"가위컷" => "120",
			"위생" => "120",
			"썸머컷" => "120"
		);
	}
	//print_r($dog_worktime_list);
    

    $cat_static_query = "SELECT * FROM tb_product_cat WHERE customer_id = '{$user_id}'";
    $cat_static_result = mysqli_query($connection, $cat_static_query);
    $cat_static_list = array();
    while ($cat_static_data = mysqli_fetch_object($cat_static_result)) {
        $cat_static_list[] = $cat_static_data->second_type;
        $cat_product = $cat_static_data;
    }

    //기타 상품 데이터
    $dog_etc_list = array();
    $dog_etc_query = "SELECT * FROM tb_product_dog_etc WHERE customer_id = '{$user_id}'";
    $dog_etc_result = mysqli_query($connection, $dog_etc_query);
    while ($dog_etc = mysqli_fetch_object($dog_etc_result)) {
        $dog_etc_list[] = $dog_etc;
    }

    $cat_etc_list = array();
    $cat_etc_query = "SELECT * FROM tb_product_cat_etc WHERE customer_id = '{$user_id}'";
    $cat_etc_result = mysqli_query($connection, $cat_etc_query);
    while ($cat_etc = mysqli_fetch_object($cat_etc_result)) {
        $cat_etc_list[] = $cat_etc;
    }

    //쿠폰 상품 데이터
    $coupon_list = array();
    $coupon_query = "SELECT * FROM tb_coupon WHERE customer_id = '{$user_id}' AND del_yn = 'N' ORDER BY reg_date";
    $coupon_result = mysqli_query($connection, $coupon_query);
    while ($coupon_data = mysqli_fetch_object($coupon_result)) {
        $coupon_list[] = $coupon_data;
    }
}
?>






<?php
/*
	
*/
$data = array();
$_SESSION['bjj_stop_direct_flag'] = "1";



foreach ($data['payment'] as $key => $val) ksort($data['payment'][$key]);
foreach ($rowspan['payment'] as $key => $val) ksort($rowspan['payment'][$key]);

// 일일 오픈시간과 종료시간을 가지고 온다.
$sql['schedule'] = "select * from tb_working_schedule where customer_id='{$artist_id}'";
$result = mysqli_query($connection, $sql['schedule']);
$data['schedule'] = $schedule = $rows = mysqli_fetch_assoc($result);
$order_my = isset($order_my) ? $order_my : array();
ksort($order_my);
// echo '<pre>';
// var_dump($order_my);
// echo '</pre>';
//print_r($data['schedule']);

$time_open = $data['schedule']['working_start']; // 오픈시간
$time_close = $data['schedule']['working_end']; // 종료시간


// 미용사별 근무시간
$data['private_holiday'] = array();
$week_idx = date('w', strtotime($yy . '-' . $mm . '-' . $dd));
$sql['artist'] = " SELECT * FROM `tb_artist_list` WHERE artist_id='{$artist_id}' AND is_view = '2' AND is_out = '2' GROUP BY name ORDER BY sequ_prnt asc, is_main DESC, nicname ASC";
//echo $sql['artist']."<p>";
/*
$sql['artist'] = "
	SELECT seq, artist_id, name, nicname, is_main, ".$week_idx." AS week,
		(SELECT time_start FROM tb_artist_list WHERE artist_id = a.artist_id AND nicname = a.nicname AND week = '".$week_idx."') AS time_start,
		(SELECT time_end FROM tb_artist_list WHERE artist_id = a.artist_id AND nicname = a.nicname AND week = '".$week_idx."') AS time_end
	FROM `tb_artist_list` AS a
	WHERE artist_id = '".$artist_id."' 
	GROUP BY name 
	ORDER BY is_main DESC
"; // 20200629 ulmo 해당 요일의 근무시간을 가져오도록 서브쿼리 변경처리 
*/
// error_log('----- $sql[artist] : '.$sql['artist']);
$result = mysqli_query($connection, $sql['artist']);
while ($artist_rows = mysqli_fetch_assoc($result)) {
    $data['artist'][] = $artist_rows;
}


$worker_id = $_GET['worker'];
if(empty($worker_id)){
//    print_r($data['artist']);
    $worker_id = $data['artist'][0]['artist_id'];
}


// 법정 공휴일 쉬는 여부 true가 쉰다.
$is_rest_public_holiday = false;
$working_sql = "select * from tb_working_schedule where customer_id = '" . $user_id . "';";
$working_result = mysqli_query($connection, $working_sql);
if ($working_datas = mysqli_fetch_object($working_result)) {
    $is_rest_public_holiday = ($working_datas->rest_public_holiday == 1) ? true : false;
}





// 공휴일
$is_public_holiday = false;
$sql_public_holiday = "SELECT * FROM tb_public_holiday WHERE year = $yy AND month = $mm AND day = $dd";
$sql_public_holiday_result = mysqli_query($connection, $sql_public_holiday);
while ($sql_public_holiday_row = mysqli_fetch_object($sql_public_holiday_result)) {
    if ($sql_public_holiday_row->day == $dd) {
        $is_public_holiday = true;
    }
}

foreach ($data['artist'] as $key => $artist) {
	// 20200716 ulmo 해당 요일에 대한 업무시간 재조정 
	$sql = "
		SELECT * 
		FROM `tb_artist_list`
		WHERE artist_id = '".$artist["artist_id"]."' 
			AND NAME = '".$artist["name"]."'
			AND WEEK = '".$week_idx."'
			AND is_view = '2'
	";
	$result = mysqli_query($connection, $sql);
	$row = mysqli_fetch_array($result);
	$data['artist'][$key]["time_start"] = $row["time_start"];
	$data['artist'][$key]["time_end"] = $row["time_end"];

    // 임시휴일[START]
    // echo '<div style="color:red;">'.$artist['name'].'</div>';
    $sql_private_holiday = "SELECT * FROM(
        SELECT 
            pholiday.* ,
            DATE_FORMAT( CONCAT( pholiday.start_year,'-',pholiday.start_month,'-',pholiday.start_day,' ',pholiday.start_hour,':',IFNULL(pholiday.start_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) pri_start_date ,
            DATE_FORMAT( CONCAT( pholiday.end_year,'-',pholiday.end_month,'-',pholiday.end_day,' ',IF(pholiday.end_hour = 24 AND (pholiday.end_minute IS NULL OR pholiday.end_minute = 0), '23', pholiday.end_hour),':',IF(pholiday.end_hour = 24 AND pholiday.end_minute IS NULL, '59', IFNULL(pholiday.end_minute,'00')),':00' ), '%Y-%m-%d %H:%i' ) pri_end_date ,
            DATE_FORMAT( CONCAT( pholiday.start_year,'-',pholiday.start_month,'-',pholiday.start_day,' ',pholiday.start_hour,':',IFNULL(pholiday.start_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) pri_start_time ,
            DATE_FORMAT( CONCAT( pholiday.end_year,'-',pholiday.end_month,'-',pholiday.end_day,' ',IF(pholiday.end_hour = 24 AND (pholiday.end_minute IS NULL OR pholiday.end_minute = 0), '23', pholiday.end_hour),':',IF(pholiday.end_hour = 24 AND pholiday.end_minute IS NULL, '59', IFNULL(pholiday.end_minute,'00')),':00' ), '%Y-%m-%d %H:%i' ) pri_end_time
        FROM 
            tb_private_holiday pholiday 
    ) A
    WHERE 
        A.customer_id='{$artist_id}'
        AND A.worker='{$artist['name']}'
        AND DATE_FORMAT( '{$yy}-{$mm}-{$dd} 00:00' , '%Y-%m-%d %H:%i' ) <= A.pri_end_date AND A.pri_start_date <= DATE_FORMAT( '{$yy}-{$mm}-{$dd} 23:59' , '%Y-%m-%d %H:%i' )
    ORDER BY
        A.pri_start_date ASC
    ";
    //echo $sql_private_holiday."<br>";
    $result_private_holiday = mysqli_query($connection, $sql_private_holiday);
    $private = array();
    while ($private_holiday_rows = mysqli_fetch_assoc($result_private_holiday)) {
		$tmp_start_hour = $private_holiday_rows['start_hour'];
		$tmp_end_hour = $private_holiday_rows['end_hour'];

		if($private_holiday_rows['start_hour'] == 0){
			$tmp_start_hour = $data['schedule']['working_start']; // 업무시작시간으로 설정
		}else{
			if($private_holiday_rows['start_hour'] < $data['schedule']['working_start']){
				$tmp_start_hour = $data['schedule']['working_start']; // 업무시작시간으로 설정
			}
		}
		if($private_holiday_rows['end_hour'] == 0){
			$tmp_end_hour = $data['schedule']['working_end']; // 업무마감시간으로 설정
		}else{
			if($private_holiday_rows['end_hour'] > $data['schedule']['working_end']){
				$tmp_end_hour = $data['schedule']['working_end']; // 업무마감시간으로 설정
			}
		}

		$data['private_holiday'][$artist['name']]['phseq'] = $private_holiday_rows['ph_seq'];

		//echo $private_holiday_rows['start_hour']."/".$private_holiday_rows['end_hour']."//".$tmp_start_hour."/".$tmp_end_hour;
		$tmp_start_date = DATE("Y-m-d H:i", STRTOTIME($yy."-".$mm."-".$dd." ".$tmp_start_hour.":".$private_holiday_rows['start_minute']));
		$tmp_end_date = DATE("Y-m-d H:i", STRTOTIME($yy."-".$mm."-".$dd." ".$tmp_end_hour.":".$private_holiday_rows['end_minute']));

        // $date = date('Y-m-d', strtotime($private_holiday_rows['pri_start_date']));
        $time = date('H:i', strtotime($tmp_start_date));
        $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($tmp_start_date))));
        $time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($tmp_end_date))));
        //$time = date('H:i', strtotime($private_holiday_rows['pri_start_date']));
        //$time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($private_holiday_rows['pri_start_date']))));
        //$time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($private_holiday_rows['pri_end_date']))));

        $sec = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);
        $time_block_cnt = $sec / (60 * 30); // 블럭갯수

        // 30분간격으로 시간을 저장한다.
        for ($h = $time_start; $h < $time_end; $h += (60 * 30)) {
            $private[$private_holiday_rows['worker']][] = date('H:i', $h);
        }

        $data['private_holiday'][$artist['name']]['time'] = $private[$artist['name']];
        $data['private_holiday'][$artist['name']]['count'][$time] = (int) $time_block_cnt;
        $data['private_holiday'][$artist['name']]['data'][$time] = $private_holiday_rows;
    }

    $data['private_holiday'][$artist['name']]['time']."<p>";
    //print_r($data['private_holiday'][$artist['name']]['phseq']);
}
// echo '<pre style="">';
// var_dump($data['private_holiday'][$artist['name']]['time']);
// echo '</pre>';

// 2019.01.07 developlay - 요일별 휴일여부 추출 [END]
$sql = "select * from tb_working_schedule where customer_id='{$artist_id}'";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);
ksort($order_my);

$data['week_time'] = array();
$data['week_time']['working_start'] = $rows->working_start;
$data['week_time']['working_end'] = $rows->working_end;

// 2020.03.24 시간 예약 활성화, 비활성화 관련 
$time_off_sql = "select * from tb_time_off where customer_id = '{$artist_id}' ";
$time_off_result = mysqli_query($connection, $time_off_sql);
$time_off_row = mysqli_fetch_object($time_off_result);

$data["time_off"] = array();
$data["time_off"]["res_time_off"] = $time_off_row->res_time_off;

// 2020.04.08 ulmo 예약 스케줄 운영방식 선택
$sql = "select * from tb_time_schedule where artist_id = '{$artist_id}' ";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);

$data["time_schedule"] = array();
$data["time_schedule"]["res_time_off"] = $rows->res_time_off;

$sql = "select is_time_type from tb_shop where customer_id = '{$artist_id}' ";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);

$data["time_schedule"]["is_time_type"] = $rows->is_time_type;

$ing_cnt = 0;


//타임제일경우 확인하기
if($data["time_schedule"]["is_time_type"]==2) {
    $que = " SELECT * FROM `tb_artist_list` WHERE artist_id='{$artist_id}' AND is_view = '2' AND is_out = '2' GROUP BY name ORDER BY sequ_prnt asc, is_main DESC, nicname ASC";
    //echo $que;
    $result = mysqli_query($connection, $que);
    while ($artist_rows = mysqli_fetch_assoc($result)) {
        $que = "SELECT * FROM tb_time_schedule WHERE artist_id = '{$user_id}' AND artist_name = '{$artist_rows['name']}'";
        $row = sql_fetch_array($que);
        if(!empty($row[0]['res_time_off'])) {
            $time_schedule[$artist_rows['name']] = explode(',', $row[0]['res_time_off']);
            for($i=0;$i<count($time_schedule[$artist_rows['name']]);$i++) {
                $tsc[$artist_rows['name']][] = substr($time_schedule[$artist_rows['name']][$i], 0, 5);
            }
        }
    }
}


// 예약중건 추출
$data['reservation'] = array();
$sql = "SELECT
    res.* ,
    DATE_FORMAT( CONCAT( res.year,'-',res.month,'-',res.day,' ',res.hour,':',IFNULL(res.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_start
FROM
    `tb_reservation` res
WHERE
    DATE_FORMAT( CONCAT( res.year,'-',res.month,'-',res.day ), '%Y-%m-%d' ) >= DATE_FORMAT( '{$yy}-{$mm}-{$dd}' , '%Y-%m-%d' )
    AND res.update_time > DATE_ADD(now(), INTERVAL -10 MINUTE )
";
//echo $sql;
$arr = sql_fetch_array($sql);

if(count($arr)>0){
    foreach($arr as $arr) {
        $res_time[$arr['worker']]['datetime'][] = strtotime($arr['res_time_start']);
        $res_time[$arr['worker']]['datetime_time'][] = strtotime($arr['res_time_start']);
        $res_time[$arr['worker']]['daterow'][] = $arr['rowspan'];
        $res_time_worker[] = $arr['worker'];
    }
}
for($i=0;$i<count($res_time_worker);$i++) {
    for ($k = 1; $k < $res_time[$res_time_worker[$i]]['daterow'][0]; $k++) {
        array_push($res_time[$res_time_worker[$i]]['datetime_time'], $res_time[$res_time_worker[$i]]['datetime_time'][0]+(1800*$k));
    }
}
for($i=0;$i<count($res_time_worker);$i++) {
    $rt_cnt[$res_time_worker[$i]] = count($res_time[$res_time_worker[$i]]['datetime']);
    sort($res_time[$res_time_worker[$i]]['datetime_time']);
    sort($res_time[$res_time_worker[$i]]['datetime']);
}

$que = "SELECT * FROM tb_working_schedule WHERE customer_id = '{$artist_id}'";
//echo $que;
$tws = sql_fetch_array($que);
//$time_open = $data['schedule']['working_start']; // 오픈시간
//$time_close = $data['schedule']['working_end']; // 종료시간

$combine_currdate = $yy.TFunc::strToFillZero($mm, 2).TFunc::strToFillZero($dd, 2);
$reserve_sql = new TReserveSql($connection);
$CantReservationDay = $reserve_sql->qry_cant_reservation_day($artist_id, $combine_currdate);
$CantReservationWeekNor = $reserve_sql->qry_cant_reservation_week_nor($artist_id);
$st_date_time= $combine_currdate.TFunc::strToFillZero($time_open, 2)."00";
$fi_date_time= $combine_currdate.TFunc::strToFillZero($time_close, 2)."00";
$GetReservationChkDay = $reserve_sql->qry_get_reservation_chk_day($artist_id, $st_date_time, $fi_date_time);
if(TFunc::checkPC() == "PC") {
    $memo_count = 0;
    foreach ($GetReservationChkDay as $val){
        $tmp_memo = $reserve_sql->qry_get_reservation_chk_memo($val['cellphone'], $val['reservation_date']);
        $GetReservationChkDay[$memo_count]['etc_memo'] = $tmp_memo[0]['before_memo'];
        $memo_count ++;
    }
}

function data_dash($tmp){
    if ($tmp == ""){
        $tmp = "내용 없음";
        return $tmp;
    }
    $tmp = substr_replace($tmp, '-', 4, 0);
    $tmp = substr_replace($tmp, '-', 7, 0);
    $tmp = substr_replace($tmp, ' ', 10, 0);
    $tmp = substr_replace($tmp, ':', 13, 0);
    return $tmp;
}

function data_etc_memo($tmp){
    if ($tmp == ""){
        $tmp = "내용 없음";
        return $tmp;
    }
    return $tmp;
}

?>
<!-- container -->
<section id="container"> 
	<!-- page-body -->    
	<div class="page-body">
        <div class="common-bottom-ui left" style="position:fixed;bottom:74px;">
            <a href="customer_inquiry"><img src="https://image.banjjakpet.com/images/icon-circle-float_search.png" alt="" style="width:64px;"></a>
        </div>
		<div class="reserve-calendar-wrap">
			<!--<button type="button" onclick="location.href='reserve_time_sale_step1_3'" class="btn btn-outline-purple btn-middle-size btn-round">빈시간 판매하기</button>-->
			<!-- 캘린더 정렬 -->
			<div class="reserve-calendar-sort">
				<div class="sort-left">
                    <!-- actived클래스 추가시 활성화 -->
                    <button type="button" onclick="location.href='reserve_main_month?ch=month&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                            class="btn-reserve-calendar-sort ">월</button>
                    <button type="button" onclick="location.href='reserve_main_week?ch=week&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                            class="btn-reserve-calendar-sort">주</button>
                    <button type="button" onclick="location.href='reserve_main_day?ch=day&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                            class="btn-reserve-calendar-sort actived" >일</button>
                    <button type="button" onclick="location.href='reserve_main_list?ch=list&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                        class="btn-reserve-calendar-sort"><span class="icon icon-type-list-gray off"></span><span
                            class="icon icon-type-list-white on"></span></button>
                </div>
				<div class="sort-right">
                    <select name="choose_type" id="choose_type" onchange="show_alert(this.value);">
                        <option value="beauty" selected>미용</option>
                        <option value="hotel">호텔</option>
                        <option value="playroom">유치원</option>
                    </select>
				</div>
			</div>
			<!-- //캘린더 정렬 -->
			<!-- 캘린더 상단 -->
			<div class="reserve-calendar-top">
				<button type="button" class="btn-reserve-calendar-ui btn-month-prev"><span class="icon icon-calendar-prev-small"></span></button>
				<div class="reserve-calendar-title">
					<div class="txt">09.08 (수)</div>
					<!--
					//	select태그는 투명을로 위로 띄웟고 , change 시 txt클래스내 문구 변경으로 디자인 처리
					-->
					<select>
                        <?for($i=-15;$i<0;$i++){?>
						<option value="<?= (int) date('Y', strtotime($selected_date)-86400*$i) ?>.<?= (int) date('m', strtotime($selected_date)-86400*$i) ?>.<?= (int) date('d', strtotime($selected_date)-86400*$i) ?>" data-rol1="<?=date('m.d', strtotime($selected_date)-86400*$i)?>" data-rol2="<?= $daily[date('w', strtotime($yy . '-' . $mm . '-' . $dd))] ?>"><?= (int) date('m', strtotime($selected_date)-86400*$i) ?>월 <?= (int) date('d', strtotime($selected_date)-86400*$i) ?>일</option>
						<?}?>
                        <?for($i=0;$i<15;$i++){?>
						<option value="<?= (int) date('Y', strtotime($selected_date)-86400*$i) ?>.<?= (int) date('m', strtotime($selected_date)-86400*$i) ?>.<?= (int) date('d', strtotime($selected_date)-86400*$i) ?>" <?if($i==0) echo "selected";?> data-rol1="<?=date('m.d', strtotime($selected_date)-86400*$i)?>" data-rol2="<?= $daily[date('w', strtotime($yy . '-' . $mm . '-' . $dd))] ?>"><?= (int) date('m', strtotime($selected_date)-86400*$i) ?>월 <?= (int) date('d', strtotime($selected_date)-86400*$i) ?>일</option>
						<?}?>
					</select>
				</div>
				<button type="button" class="btn-reserve-calendar-ui btn-month-next"><span class="icon icon-calendar-next-small"></span></button>
			</div>
			<!-- //캘린더 상단 -->
			<!-- 캘린더 라벨 -->
			<div class="reserve-calendar-label">
				<div class="reserve-calendar-label-info">* 접수는 빈칸 클릭!</div>
				<div class="grid-layout reserve-calendar-label-group">
					<div class="grid-layout-inner">
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state yellow"></div>앱-선결제</div></div>
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state purple"></div>앱-매장결제</div></div>
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state green"></div>매장예약</div></div>
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state red"></div>NoShow</div></div>
					</div>
				</div>	
			</div>
			<!-- //캘린더 라벨 -->
			<!-- 캘린더 상세 -->
			<div>
				<div class="reserve-calendar-data">
					<div class="reserve-calendar-inner">
						<!--
						// calendar-month-header-col 클래스 정의
						// calendar-month-body-col 클래스 정의
						//	break : 휴무 및 예약금지
						// calendar-drag-item-group : 드래그 가능한 영역
						// calendar-drag-item : 드래그 아이템
						-->
						<!--
						// calendar-week-time-item 상황별 클래스값
						// yellow : 앱-선결제
						// purple : 앱-매장결제
						// green : 매장예약
						// red : NoShow
						// gray : 승인대기
						-->
						<div class="calendar-day-wrap">
							<div class="calendar-day-header">
								<div class="calendar-day-header-row">
									<div class="calendar-day-header-col time"></div>
                                    <?php foreach ((array) $data['artist'] as $key => $artist) { ?>
                                        <div class="calendar-day-header-col"><?= $artist['nicname'] ?><?=($artist['is_out'] == '1')? ' (퇴)' : '' ?></div>
                                    <?php } ?>
								</div>
							</div>



							<div class="calendar-day-body">

                            <?php for ($t = $data['schedule']['working_start']; $t < $data['schedule']['working_end']; $t++) { ?>
                                <?php 
									for ($t30 = 0; $t30 < 60; $t30 += 30) {
										$css_line = $t30 == 30 ? "line_solid" : ''; 
                                        $thisTime = sprintf('%02d', $t) . ":" . sprintf('%02d', $t30); // 현재 시간
								?>
								<div class="calendar-day-body-row" data-time-to="<?=$thisTime?>" data-time-from="<?= date('H:i', strtotime($thisTime . ' +30 minutes')) ?>">
                                    <div class="calendar-week-body-col time">
                                        <?php if($thisTime == sprintf('%02d',$tws[0]['working_start']).':00' && $thisTime < '12:00'){ ?>
                                            <div class="day-division-label">오전</div>
                                        <?php } else if($thisTime == sprintf('%02d',$tws[0]['working_start']).':00' && $thisTime >= '12:00'){ ?>
                                            <div class="day-division-label">오후</div>
                                        <?php } else if($thisTime == '12:00'){ ?>
                                            <div class="day-division-label">오후</div>
                                        <?php } else { ?>
                                            <div class="day-division-label"></div>
                                        <?php } ?>
                                        <div class="time-label"><div class="time-start-label"><?=date('h:i',strtotime($thisTime))?></div><div class="time-end-label"></div></div>
                                    </div>
                                    <?php

                                        foreach ((array) $data['artist'] as $artist_key => $artist) {
                                            unset($crw);
                                            unset($div_class);
                                            $cur_time = $thisTime;
                                            //해당 일자에 tb_private_holiday 데이터가 있는지 확인다. 2020-02-24 james


                                            $nowdate = date('Y-m-d',strtotime($selected_date));//현재 날짜
                                            $nowdatetime = strtotime($nowdate." ".$thisTime); //현재날짜시간

//                                            $crw = cant_reservation_day($connection, $artist_id, $artist['name'], $nowdate); //날짜만으로 예약금지 일자 검색
                                            $crw =null; //날짜만으로 예약금지 일자 검색
                                            if (count($CantReservationDay) < 1){
                                                $crw = null;
                                            }else{
                                                foreach ($CantReservationDay as $val){
                                                    if(trim($val['worker']) == $artist['name']
                                                        && strtotime($val['start_datetime']) <= $nowdatetime
                                                        && strtotime($val['end_datetime']) > $nowdatetime
                                                    ){
                                                        $crw = $val;
                                                        break;
                                                    }
                                                    $crw = null;
                                                }
                                            }
                                            $thisTimeTo = date('H:i', date2timestamp(strtotime(date('Y-m-d H:i', strtotime($nowdate . ' ' . $time_open.':00')))));
                                            $thisTimeFrom = date('H:i', date2timestamp(strtotime(date('Y-m-d H:i', strtotime($nowdate . ' ' . $time_close.':00')))));


                                            if(strtotime($crw['start_datetime']) <= $nowdatetime && strtotime($crw['end_datetime']) > $nowdatetime){
                                                $div_class = 'break';
                                                $status = '예약금지';
                                            }

                                            //정기휴일 확인.
//                                            $crwn = cant_reservation_week_nor($connection, $artist_id);
                                            $crwn = null;
                                            if (count($CantReservationWeekNor) < 1){
                                                $crwn = null;
                                            }else{
                                                foreach ($CantReservationWeekNor as $val){
                                                    if(trim($val['customer_id']) == $artist_id){
                                                        $crwn = TFunc::artist_reservation_chk($val);
                                                        break;
                                                    }
                                                    $crwn = null;
                                                }
                                            }
                                            $today_disp = date('w',strtotime($nowdate));
                                            if(in_array($today_disp,$crwn)) {
                                                $div_class = 'break';
                                                $status = '정기휴일';
                                            }

                                            //해당 일자 예약 가져오기
                                            $is_rev_true = '';
//                                            $chk_rev = get_reservation_chk($user_id, $artist['name'], date('Y-n-j',strtotime($nowdate)),$thisTime);
                                            $chk_rev = [];
                                            if (count($GetReservationChkDay) < 1){
                                                $chk_rev = null;
                                            }else{
                                                foreach ($GetReservationChkDay as $val){
                                                    if(trim($val['reservation_date']) == str_replace("-","",$nowdate).str_replace(":","",$thisTime)
                                                         && trim($val['worker']) == $artist['name']){
                                                        $chk_rev[] = $val;
                                                        //array_splice($chk_rev, 150, 2);
                                                        break;
                                                    }
                                                    $chk_rev = null;
                                                }
                                            }
                                            if($chk_rev){
                                                $is_rev_true = 'go-payment';
                                            }


                                            //해당 일자에
                                            //앱예약중 다시 처리하기
                                            /*$chk_rev_ing = get_reservation_ing_chk($user_id, $artist['name'], date('Y-n-j',strtotime($nowdate)),$thisTime);
                                            $now_ing = strtotime($nowdate.' '.$thisTime);*/
                                            //echo "<br>";
                                            /*$ing_updt = strtotime($chk_rev_ing[0]['update_time']);
                                            echo $ing_cnt1.'-'.$chk_rev_ing[0]['rowspan'];
                                            if($now_ing >= $ing_updt && $ing_cnt1 >= $chk_rev_ing[0]['rowspan']){
                                                $div_class = 'break';
                                                $status = '앱예약중';
                                                $ing_cnt1++;
                                            }

                                            if($ing_cnt1 == $chk_rev_ing[0]['rowspan']){
                                                $ing_cnt1 = 0;
                                            }*/
                                            $star_date_time = strtotime($nowdate.' '.$thisTime);
                                    ?>

									<div class="calendar-day-body-col <?=$div_class?> time_payment "
                                         data-worker2="<?= $artist['nicname'] ?>"
                                         data-worker="<?= $artist['name'] ?>"
                                         data-date="<?= $nowdate ?>"
                                         data-time="<?= $thisTime ?>"
                                         data-time-to="<?= $thisTimeTo ?>"
                                         data-time-from="<?= $thisTimeFrom ?>"
                                         data-hour="<?= sprintf('%02d', $t) ?>"
                                         data-minute="<?= sprintf('%02d', $t30) ?>"
                                         data-rowspan="" data-time="<?= $thisTime ?>"
                                         date-session-id="<?= $session_id[$firstTime] ?>"
                                         data-pay_seq="<?=$payment_log_seq?>"
                                         data-phseq="<?=$data['private_holiday'][$artist['name']]['phseq']?>"
                                         data-status="<?php echo $status;?>"
                                         data-pay="<?php echo $chk_rev[0]['payment_log_seq'];?>"
                                    >

                                         <?php if($div_class != 'break'){ ?>
                                            <div class="calendar-drag-item-group">
                                                <?php
                                                if(!empty($chk_rev)){
                                                    for($a=0;$a<count($chk_rev);$a++){
                                                        //상태표시
                                                        if (!$chk_rev[$a]['is_no_show']) {
                                                            if($chk_rev[$a]['is_await']=='0') {
                                                                $css_pay_type   = "gray";
                                                            } else if ($chk_rev[$a]['pay_type'] == 'card' || $chk_rev[$a]['pay_type'] == 'bank') {
                                                                $css_pay_type   = "yellow";
                                                            }else if($chk_rev[$a]['pay_type'] == 'offline-card' || $chk_rev[$a]['pay_type'] == 'offline-cash' || $chk_rev[$a]['pay_type'] == 'offline') {
                                                                $css_pay_type   = "purple";
                                                            }else if($chk_rev[$a]['pay_type'] == 'pos-card' || $chk_rev[$a]['pay_type'] == 'pos-cash') {
                                                                $css_pay_type   = "green";
                                                            }
                                                        }else{
                                                            $css_pay_type   = "red";
                                                        }
                                                        $type = explode("|",$chk_rev[$a]['product']);
                                                        $time_start = strtotime($yy.'-'.$mm.'-'.$dd.' '.$thisTime);
                                                        $time_end = strtotime($yy.'-'.$mm.'-'.$dd.' '.$chk_rev[$a]['to_hour'].':'.$chk_rev[$a]['to_minute']);

                                                        $que = "SELECT * FROM tb_payment_log WHERE payment_log_seq = {$chk_rev[$a]['payment_log_seq']}";
                                                        //echo $que;
                                                        $paq = sql_fetch_array($que);


                                                        if($chk_rev[$a]['is_no_show']==1){
                                                            $style_height = 100;
                                                        } else {
                                                            //기본 미용 선택이 없을경우 100으로 만든다.
                                                            $binfo = explode("|",$chk_rev[$a]['product']);
                                                            /*if(empty($binfo[3])){
                                                                $style_height = 100;
                                                            } else {*/
                                                                $style_height = make_rev_calc_height($time_start,$time_end);
                                                            //}
                                                            //$style_height = make_rev_calc_height($time_start,$time_end);
                                                        }


                                                        ?>
                                                    <div class="calendar-week-time-item <?=$css_pay_type?> time_payment_link <?php echo $is_rev_true;?>"  style="height:calc( <?=$style_height?>% - 1px );cursor:pointer;" data-approve_chk="<?php echo $chk_rev[$a]['is_await'];?>" data-approve_seq="<?php echo $chk_rev[$a]['approve_seq'];?>" data-customer-id="<?= $customer_id ?>" data-order-id="<?= $order_id ?>" data-payment-log-seq="<?= $chk_rev[$a]['payment_log_seq'] ?>"  data-etc_memo="<?php echo $chk_rev[$a]['etc_memo']?>"
                                                    >
                                                        <div class="item-name"><?php echo ($chk_rev[$a]['is_await']=='0')?'승인대기':$chk_rev[$a]['pet_name']; ?></div>
                                                        <div class="item-cate"><?php echo $chk_rev[$a]['pet_type']; ?></div>
                                                         <?php
                                                                            if($chk_rev[$a]['status'] == 'R1'){
                                                                                $pay_price = number_format($chk_rev[$a]['total_price']);
                                                                            }else{
                                                                                $pay_price = number_format($chk_rev[$a]['local_price']+$chk_rev[$a]['local_price_cash']);
                                                                            }
                                                                            ?>
                                                        <div class="item-price"><?php echo $pay_price; ?></div>
                                                        <?php if($style_height != 0){ ?>
                                                        <!--<div class="item-option">"--><?php //echo $type[4]; ?><!--"</div>-->
                                                            <div class="item-option">"<?php echo ($type[1]=="고양이")? explode(':',$type[4])[0] : $type[4]; ?>"</div>
                                                        <?php if(!empty($binfo[3]) && $binfo[3]!='all:0'){ ?>
                                                        <div class="item-cash">
                                                            <?php

                                                                if($paq[0]['is_confirm']==1){//결제완료시
                                                                    if($paq[0]['local_price']>0){//카드결제
                                                                        echo '<div class="icon icon-reservation-card-on"></div>';
                                                                    }
                                                                    if($paq[0]['local_price_cash']>0){//현금결제
                                                                        echo '<div class="icon icon-reservation-cash-on"></div>';
                                                                    }
                                                                } else if($paq[0]['is_confirm']!=1){//결제완료전
                                                                    if($paq[0]['local_price']>0) {//카드결제
                                                                        echo '<div class="icon icon-reservation-card-off"></div>';
                                                                    }
                                                                    if($paq[0]['local_price_cash']>0){//현금결제
                                                                        echo '<div class="icon icon-reservation-cash-off"></div>';
                                                                    }
                                                                }
                                                            ?>
                                                            <!--<div class="icon icon-reservation-cash-off"></div>
                                                            <div class="icon icon-reservation-cash-on"></div>
                                                            <div class="icon icon-reservation-card-off"></div>
                                                            <div class="icon icon-reservation-card-on"></div>-->
                                                        </div>
                                                        <?php
                                                                } else if($paq[0]['is_confirm']==1) {
                                                                    if($paq[0]['local_price']>0){//카드결제
                                                                        echo '<div class="item-cash"><div class="icon icon-reservation-card-on"></div></div>';
                                                                    }
                                                                    if($paq[0]['local_price_cash']>0){//현금결제
                                                                        echo '<div class="item-cash"><div class="icon icon-reservation-cash-on"></div></div>';
                                                                    }
                                                        ?>
                                                            <?php } else { ?>
                                                                <div class="item-master"><div class="icon icon-reservation-selfadd"></div></div>
                                                        <?php }} ?>
                                                    </div>
                                                <?php }} else {
                                                    //타임제 선택되었을경우에
                                                    if($data["time_schedule"]["is_time_type"]==2){
                                                        $time_schedule_color = '';
                                                        if(in_array($thisTime,$tsc[$artist['name']])) {
                                                            $time_schedule_color = 'border-top:#828282 solid 4px;';
                                                        }

                                                ?>
                                                    <div class="time_payment_link" style="height:calc( 100% - 1px );<?php echo $time_schedule_color;?>"></div>
                                                        <?php
                                                    }////타임제 선택되었을경우에 끝
                                                    
                                                    //예약중 표시

                                                    if(in_array($star_date_time,$res_time[$artist['name']]['datetime_time'])){
                                                        echo '<div class="time_payment_link1 rev-ing" style="height:calc( 100% - 1px );background-color: #f4f4f4;">';
                                                        for($x=0;$x<$rt_cnt[$artist['name']];$x++){
                                                            if ($res_time[$artist['name']]['datetime'][$x] == $star_date_time) {
                                                                echo '<span class="rev-ing-' . $star_date_time . '" style="font-size:11px;">견주앱<br>예약중</span>';
                                                                echo $idx_ing = array_search($res_time['datetime'], $res_time['datetime'][$x]);
                                                                break;
                                                            }
                                                        }
                                                        echo '</div>';
                                                    }
                                                    //print_r($res_time['datetime']);
                                                } //예약이 없을경우 끝

                                                ?>
                                            </div>
                                         <?php } else { ?>
                                             <?php
                                             if($status == '정기휴일' && $thisTime == '09:00'){
                                                 echo $status;
                                             }

                                             if($status == '예약금지' && substr($crw['start_datetime'],-5) == $thisTime){
                                                 echo $status;
                                             }
                                             ?>
                                         <?php } ?>
                                    </div>
                                            <?php //echo $thisTimeTo;?>
                                            <div class="calendar-day-current-time" style="top:15%; display: none;">
                                                <div class="bar"></div>
                                                <div class="value"><?php echo date('h:i');?></div>
                                            </div>
                                    <?php } ?>
									
								</div>
								<?php $ing_cnt++; }}?>


							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- //캘린더 상세 -->
		</div>
        <?php include($_SERVER['DOCUMENT_ROOT']."/bottom_msg_list.php"); ?>
	</div>
	<!-- //page-body -->	
    <div class="page-cover"></div>
</section>


<article id="reserveCalendarPop2" class="layer-pop-wrap">
    <div class="layer-pop-parent">
        <div class="layer-pop-children">
            <div class="pop-data alert-pop-data">
                <div class="pop-header">
                    <h4 class="con-title">실장</h4>
                </div>
                <div class="pop-body type-3">
                    <div class="msg-txt"><span class="msg-txt-date">2021.09.08</span>&nbsp;&nbsp;&nbsp;&nbsp;<span  class="msg-txt-time">오후 01:30</span></div>
                </div>
                <div class="pop-footer">
                    <button type="button" class="btn btn-confirm btn-reserv-block" onclick="pop.close();">예약금지설정</button>
                    <button type="button" class="btn btn-confirm btn-reserv-send">예약접수</button>
                </div>
            </div>
        </div>
    </div>
</article>


<article id="reserveCalendarPop3" class="layer-pop-wrap">
    <div class="layer-pop-parent">
        <div class="layer-pop-children">

            <div class="pop-data alert-pop-data">
                <div class="pop-header">
                    <h4 class="con-title">예약금지 설정</h4>
                </div>
                <div class="pop-body type-3">
                    <form name="form_time" id="form_time">
                        <input type="hidden" name="ph_type" value="notall">
                        <input type="hidden" name="ph_worker" value="">
                        <input type="hidden" name="ph_start_year" id="year" value="<?php echo $_GET['yy'];?>">
                        <input type="hidden" name="ph_start_month" id="month" value="<?php echo $_GET['mm'];?>">
                        <input type="hidden" name="ph_start_day" id="day" value="<?php echo $_GET['dd'];?>">
                        

                        
                        <div class="form-group">
                            <div class="form-group-cell">
                                <div class="form-group-item">
                                    <div class="form-item-label">시간</div>
                                    <div class="form-item-data type-2">
                                        <div class="form-datepicker-group">
                                            <div class="form-datepicker">
                                                <select name="ph_start_time">
                                                    <option value="">오전 11:30</option>
                                                </select>
                                            </div>
                                            <div class="form-unit">~</div>
                                            <div class="form-datepicker">
                                                <select name="ph_end_time">
                                                    <option value="">오후 11:30</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="pop-footer">
                    <button type="button" class="btn btn-confirm btn-holiday-submit">저장</button>
                    <button type="button" class="btn btn-confirm" onclick="pop.close();">취소</button>
                </div>
            </div>

        </div>
    </div>
</article>

<!-- 예약변경 -->
<article id="reserveCalendarPop4" class="layer-pop-wrap">
    <div class="layer-pop-parent">
        <div class="layer-pop-children">
            <div class="pop-data alert-pop-data">
                <div class="pop-header">
                    <h4 class="con-title">실장</h4>
                </div>
                <div class="pop-body type-3">
                    <div class="msg-txt"><span class="msg-text-date">2021.09.08</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="msg-text-time">오후 01:30</span><br><br>선택한 예약을<br>이 곳으로 변경합니다.</div>
                    <form name="form_change" id="form_change">
                        <input type="hidden" name="log_type" value="check">
                        <input type="hidden" name="log_seq" value="">
                        <input type="hidden" name="log_worker" value="">
                        <input type="hidden" name="log_date" id="year" value="">
                        <input type="hidden" name="log_start_time" id="month" value="">
                        <input type="hidden" name="log_end_time" id="day" value="">
                    </form>
                </div>
                <div class="pop-footer">
                    <button type="button" class="btn btn-confirm btn-change-submit" onclick="pop.close();">확인</button>
                    <button type="button" class="btn btn-confirm btn-reserv-cancel" onclick="pop.close();">예약변경취소</button>
                </div>
            </div>
        </div>
    </div>
</article>
<!-- //예약변경 -->

<!-- 예약변경 불가 -->
<article id="reserveCalendarPop5" class="layer-pop-wrap">
    <div class="layer-pop-parent">
        <div class="layer-pop-children">
            <div class="pop-data alert-pop-data">
                <div class="pop-body">
                    <div class="msg-txt">해당 스케줄에 일정이 있어 스케줄 변경이 불가합니다.</div>
                </div>
                <div class="pop-footer">
                    <button type="button" class="btn btn-confirm" onclick="location.reload();">확인</button>
                </div>
            </div>
        </div>
    </div>
</article>
<!-- //예약변경 불가 -->


<!-- 일자 클릭시 예약설정금지 취소 팝업 보기 -->
<article id="reserveCalendarPop10" class="layer-pop-wrap">
    <div class="layer-pop-parent">
        <div class="layer-pop-children">
            <div class="pop-data alert-pop-data">
                <div class="pop-header">
                    <h4 class="con-title">설정된 예약금지를 해제하시겠습니까?</h4>
                </div>
                <div class="pop-footer">
                    <button type="button" class="btn btn-confirm btn-reserv-block-cancel">예</button>
                    <button type="button" class="btn btn-confirm btn-reserv-send" onclick="$('#reserveCalendarPop10').removeClass('actived');">아니요</button>
                </div>
            </div>
        </div>
    </div>
</article>
        <article id="reserveCalendarPop1" class="layer-pop-wrap" style="z-index: 100002;">
            <div class="layer-pop-parent">
                <div class="layer-pop-children">

                    <div class="pop-data alert-pop-data">
                        <div class="pop-body">
                            <div class="msg-txt">준비 중입니다..</div>
                        </div>
                        <div class="pop-footer">
                            <button type="button" class="btn btn-confirm" onclick="popalert.close();">확인</button>
                        </div>
                    </div>

                </div>
            </div>
        </article>

            <!-- 드래그 예약변경 -->
    <article id="reserveCalendarPop11" class="layer-pop-wrap">
        <div class="layer-pop-parent">
            <div class="layer-pop-children">
                <div class="pop-data alert-pop-data">
                    <div class="pop-header">
                        <h4 class="con-title">실장</h4>
                    </div>
                    <div class="pop-body type-3">
                        <div class="msg-txt"><span class="msg-text-date">2021.09.08</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="msg-text-time">오후 01:30</span><br><br>선택한 예약을<br>이 곳으로 변경합니다.</div>
                        <form name="form_change" id="form_change1">
                            <input type="hidden" name="log_type" value="day">
                            <input type="hidden" name="log_seq" id="log_seq" value="">
                            <input type="hidden" name="log_worker" value="">
                            <input type="hidden" name="log_date" id="year" value="">
                            <input type="hidden" name="log_start_time" id="month" value="">
                            <input type="hidden" name="log_end_time" id="day" value="">
                            <input type="hidden" name="log_move_start_time" value="">

                            <div>
                                <br>
                                예약변경알림발송
                                <input type="radio" name="log_msg_send" value="Y" checked> 발송
                                <input type="radio" name="log_msg_send" value="N"> 미발송
                            </div>
                        </form>
                    </div>
                    <div class="pop-footer">
                        <button type="button" class="btn btn-confirm btn-change-submit drag-move-data" onclick="pop.close();">확인</button>
                        <button type="button" class="btn btn-confirm btn-reserv-cancel" onclick="location.reload();">예약변경취소</button>
                    </div>
                </div>
            </div>
        </div>
    </article>
    <!-- //예약변경 -->
    <div class="reserve-calendar-tooltip">
        <div class="tooltip-inner">
            <div class="tooltip-date" id="tooltip-date-text"></div>
            <div class="tooltip-desc" id="tooltip-desc-text"></div>
        </div>
    </div>

<!-- //container -->
<script src="/static/pub/js/Sortable.min.js"></script>
<script>
        $(document).on('mouseenter mouseleave mousemove' , '.calendar-week-time-item' , function(e){
            if($(window).width() > 1024){
                var x = e.pageX;
                var y = e.pageY;
                var $tooltip = $('.reserve-calendar-tooltip');
                if(e.type == 'mouseenter'){
                    if($(this).data('etc_memo').trim() === "")
                        return;
                    $tooltip.addClass('actived');
                    document.getElementById("tooltip-date-text").innerHTML = "특이 사항";
                    document.getElementById("tooltip-desc-text").innerHTML = $(this).data('etc_memo');
                 }else if(e.type == 'mouseleave'){
                    $tooltip.removeClass('actived');
                }else if(e.type == 'mousemove'){
                    $tooltip.css({'top' : y , 'left' : x});
                };
            };
        });

$(function(){
	/*
	$( "#sortable" ).sortable({
		placeholder: "ui-state-highlight",
		cancel:''
    });
	$( "#sortable" ).disableSelection();
	*/

	//https://github.com/SortableJS/Sortable

    var thisDate = "";
    var thisTime = "";
    var thisWorker = "";
    var thisTimeStart   = "";
    var thisTimeEnd   = "";
    var thisLogSeq  = "";

    var _thisDate = "";
    var _thisTime = "";
    var _thisWorker = "";
    var _thisTimeStart   = "";
    var _thisTimeEnd   = "";

    
	$('.calendar-day-body-col').each(function(){
		if(!$(this).hasClass('break') && !$(this).hasClass('time')){
			//휴무가 아닐 경우 드래그앤 드롭 가능 처리
			var sortable = Sortable.create($(this).find('.calendar-drag-item-group')[0] , {
				group : 'shared',
				delay : 500,
				delayOnTouchOnly : true,
				ghostClass: 'guide',
				draggable : '.calendar-week-time-item',
				onStart : function(evt){
					//드래그 시작 
					
                    
				},
				onEnd : function(evt){
					//드래그 끝
					console.log('drag end');
					//evt.to;    // 현재 아이템
					//evt.from;  // 이전 아이템
					//evt.oldIndex;  // 이전 인덱스값
					//evt.newIndex;  // 새로운 인덱스값

                    
                    if(evt.from != evt.to){
                        _thisWorker = $(evt.from).parent().attr("data-worker");
                                _thisDate = $(evt.from).parent().attr("data-date");
                                _thisTime = $(evt.from).parent().attr("data-time");
                                _thisTimeStart   = $(evt.from).parent().attr("data-time-to");
                                _thisTimeEnd   = $(evt.from).parent().attr("data-time-from");
                                thisLogSeq = $(evt.from).parent().attr("data-pay");


                                thisWorker2 = $(evt.to).parent().attr("data-worker2");
                                thisWorker = $(evt.to).parent().attr("data-worker");
                                thisDate = $(evt.to).parent().attr("data-date");
                                thisTime = $(evt.to).parent().attr("data-time");
                                thisTimeStart   = $(evt.to).parent().attr("data-time-to");
                                thisTimeEnd   = $(evt.to).parent().attr("data-time-from");

                                $("#reserveCalendarPop11 .con-title").text(thisWorker2);
                                $("#reserveCalendarPop11 .msg-text-date").text(thisDate);
                                $("#reserveCalendarPop11 .msg-text-time").text(thisTime);

                                $("#reserveCalendarPop11 input[name='log_type']").val("day");
                                $("#reserveCalendarPop11 input[name='log_seq']").val(thisLogSeq);
                                $("#reserveCalendarPop11 input[name='log_worker']").val(thisWorker);
                                $("#reserveCalendarPop11 input[name='log_date']").val(thisDate);
                                $("#reserveCalendarPop11 input[name='log_start_time']").val(thisTimeStart);
                                $("#reserveCalendarPop11 input[name='log_end_time']").val(thisTimeEnd);
                                $("#reserveCalendarPop11 input[name='log_move_start_time']").val(thisTime);

                                pop.open('reserveCalendarPop11');
                    }
                    
				},
				onUpdate : function(evt){
					console.log('update');
				},
				onUpdate : function(evt){
					console.log('onChange');
				},
				onRemove: function (evt) {
					console.log('remove');
				}
				
			});
		}
	});
    

     //드래그로 이동한 데이터를 저장한다.
            $(document).on('click','.drag-move-data',function(){
                var data_form = $("#form_change1").serialize();
                $.ajax({
                    async: false,
                    type: 'post',
                    url: 'data/data_set_change_work.php',
                    data: data_form,
                    dataType: 'json',
                    error: function(xhr,error) {
                        // console.log(xhr+ '' +error)
                    },
                    success: function(json) {
                        // console.log(json);
                        if (json !== undefined) {
                            if (json.flag == true) {

                                popalert.open('reserveCalendarPop5','예약변경이 완료되었습니다.');
                                //setTimeout(function(){
                                    //location.reload();
                                    //console.log(json.result);
                                //},2000)
                            } else {
                                popalert.open('reserveCalendarPop5',json.result);
                                //setTimeout(function(){
                                    //location.reload();
                                    //console.log(json.result);
                                //},2000)
                            }
                        }
                        // document.location.reload(true);
                    }
                });
            });

	$('.btn-reserv-block-cancel').on('click',function(){
        console.log($(this).data('worker')+':'+$(this).data('phseq'));
        var artist_id = '<?php echo $artist_id?>';
        var worker_id = $(this).data('worker');
        var phseq = $(this).data('phseq');
        if(!artist_id){
            alert('아티스트 아이디가 없습니다.');
            document.location.reload(true);
            return false;
        }
        if(!worker_id){
            alert('미용사 아이디가 없습니다.');
            document.location.reload(true);
            return false;
        }
        if(!phseq){
            alert('해당 날짜데이터가 없습니다.');
            document.location.reload(true);
            return false;
        }


        $.ajax({
            async: false,
            type: 'post',
            url: './data/data_set_private_holiday_cancel',
            data: {'aid':artist_id, 'wid':worker_id, 'idx':phseq},
            dataType: 'json',
            error: function() {},
            success: function(json) {
                console.log(json)
                if (json !== undefined) {
                    if (json.flag == true) {
                        alert(json.error);
                        document.location.reload(true);
                    } else {
                        alert(json.error);
                    }
                    //obj_dialog_time_cancel.dialog("close");
                }
            }
        });
    })

    
    $(".time_payment").click(function(){

        thisDate = $(this).attr('data-date');
        thisTime = $(this).attr('data-time');
        thisWorker = $(this).attr('data-worker');
        thisWorker2 = $(this).attr('data-worker2');
        thisTimeStart   = $(this).attr('data-time-to');
        thisTimeEnd   = $(this).attr('data-time-from');


        if($(this).find(".calendar-week-time-item").length==0 && $(this).hasClass("break")===false){
            $("#reserveCalendarPop2 .con-title").text(thisWorker2);
            $("#reserveCalendarPop2 .msg-txt-date").text(thisDate);
            $("#reserveCalendarPop2 .msg-txt-time").text(thisTime);

            $('#ph_worker').val(thisWorker);


            $('#reserveCalendarPop2 .btn-reserv-block').data('date1',thisDate);
            $('#reserveCalendarPop2 .btn-reserv-block').data('startTime',thisTimeStart);
            $('#reserveCalendarPop2 .btn-reserv-block').data('endTime',thisTimeEnd);

            $("#reserveCalendarPop2 .btn-reserv-send").click(function(){
                location.href='reserve_accept?worker='+thisWorker+'&workTime='+thisTime+'&workDate='+thisDate;
            });
            pop.open('reserveCalendarPop2');
            return false;
        }
        
        
    });

	//예약금지 버튼 클릭시
    $(".btn-reserv-block").click(function(){

        var arrDate = thisDate ? thisDate.split('-') : {};
        var arrTime = thisTime ? thisTime.split(':') : {};
        var thisDate = $(this).data('date1');
        var thisTimeStart = $(this).data('startTime');
        var thisTimeEnd = $(this).data('endTime');



        obj_form_time[0].reset();
        obj_form_time.find('input[name="ph_worker"]').val(thisWorker);


        /*thisTimeStart   = $(".calendar-day-body-row:eq(0)").attr("data-time-to");
        thisTimeEnd   = $(".calendar-day-body-row:eq("+($(".calendar-day-body-row").length-1)+")").attr("data-time-from");*/



        var timeStart = new Date((thisDate + ' ' + thisTimeStart).replace(/-/g, "/")).getTime() / 1000;
        var timeEnd = new Date((thisDate + ' ' + thisTimeEnd).replace(/-/g, "/")).getTime() / 1000;


        //console.log('예약금지설정 팝업창', 'open', thisDate, timeStart, timeEnd);
        // 시작시간
        var obj_res_time = obj_form_time.find('select[name="ph_start_time"]');
        obj_res_time.empty();
        for (var t = timeStart; t < timeEnd; t += (60 * 30)) {
            var obj_res_time_option = $('<option></option>');
            var obj_date = new Date(t * 1000);
            var val_date = '';
            val_date += (String(obj_date.getHours()).length == 1 ? '0' : '') + obj_date.getHours();
            val_date += ':';
            val_date += (String(obj_date.getMinutes()).length == 1 ? '0' : '') + obj_date.getMinutes();

            obj_res_time_option.val(val_date).text(val_date).attr('data-timestamp', t);
            if (val_date == thisTime) obj_res_time_option.prop('selected', true); // 선택된 시간을 선택한다.
            obj_res_time_option.appendTo(obj_res_time);
        }

        // 끝시간
        var obj_res_time2 = obj_form_time.find('select[name="ph_end_time"]');
        obj_res_time2.empty();
        for (var t = timeStart + (60 * 30); t <= timeEnd; t += (60 * 30)) {
            var obj_res_time_option2 = $('<option></option>');
            var obj_date = new Date(t * 1000);
            var val_date = '';
            val_date += (String(obj_date.getHours()).length == 1 ? '0' : '') + obj_date.getHours();
            val_date += ':';
            val_date += (String(obj_date.getMinutes()).length == 1 ? '0' : '') + obj_date.getMinutes();

            obj_res_time_option2.val(val_date).text(val_date).attr('data-timestamp', t);
            obj_res_time_option2.appendTo(obj_res_time2);
        }

        // 종료시점의 시간을 선택한다.
        var data_timestamp = Number(obj_res_time.find('>option').filter(':selected').data('timestamp')) + (60 * 30 * 4); // 2시간 후 timestamp
        if (obj_res_time2.find('>option').last().data('timestamp') < data_timestamp) {
            obj_res_time2.find('>option').last().prop('selected', true);
        } else {
            obj_res_time2.find('>option').each(function() {
                if ($(this).data('timestamp') == data_timestamp) {
                    $(this).prop('selected', true);
                }
            });
        }

        obj_res_time2.focus();


        pop.open('reserveCalendarPop3');




    });

    $(".btn-holiday-submit").click(function(){
        var data_form = obj_form_time.serialize();
        $.ajax({
            async: false,
            type: 'post',
            url: '/data/data_set_private_holiday.php',
            data: data_form,
            dataType: 'json',
            error: function() {},
            success: function(json) {
                // console.log(json);
                if (json !== undefined) {
                    if (json.res == true) {
                        console.log(json);
                        document.location.reload(true);
                    } else {
                        console.log(json);
                        alert(json.error);
                    }
                }
                 document.location.reload(true);
            }
        });
    });


    $(".btn-reserv-cancel").click(function(){
        location.reload();
    });


    $('.break').on('click',function(){
       if($(this).data('status')!='정기휴일') {
           $('#reserveCalendarPop10').addClass('actived');
           $('.btn-reserv-block-cancel').data('worker', $(this).data('worker')).data('phseq', $(this).data('phseq'));
       }
    });

    $(".go-payment").on('click', function(e) {
        e.preventDefault();
        // console.log('time_payment_link');

        console.log('예약내역')
        var obj_this = $(this);
        var dat_customer_id = obj_this.attr('data-customer-id');
        var dat_order_id = obj_this.attr('data-order-id'); // 주문아이디
        var dat_payment_log_seq = obj_this.attr('data-payment-log-seq'); // 주문아이디

        var obj_time_cell = obj_this.parent().parent();
        var obj_artist_line = obj_this.closest('td');
        
        
        // 선택가능 시작시점 조사
        var obj_time_cell_prev = obj_time_cell;

        //console.log(obj_time_cell_prev.hasClass('time_payment'));
        // console.log( 'obj_time_cell_prev.length' , obj_time_cell_prev.length );
        var val_time_blank_count = 0;

        var thisTimeStart = obj_time_cell_prev.attr('data-time-to');
        var thisTimeEnd = obj_time_cell_prev.attr('data-time-from');

        // console.log( 'thisTimeStart' , thisTimeStart );
        // 선택가능 시작시점 조사

        // 선택가능 종료시점 조사
        var obj_time_cell_next = obj_time_cell.next();
        var obj_time_cell_all = obj_artist_line.find('>div');
        var val_time_blank_count_max = obj_time_cell_all.length;

        // console.log( obj_time_cell_next.index() , val_time_blank_count_max );

        for (var i = obj_time_cell_next.index(); i < val_time_blank_count_max; i++) {
            // console.log( 'data-time' , obj_time_cell_next.attr('data-time-to') , obj_time_cell_next.attr('data-time-from') , i , obj_time_cell_next.attr('class') );
            var obj_time_cell_next = obj_artist_line.find('>div').eq(i);
            if (!obj_time_cell_next.length) break;
            var idx = i - 1;
            // obj_time_cell_next = obj_artist_line.find('>div').eq(idx);
            // console.log( 'obj_time_cell_next' , i , val_time_blank_count_max , obj_time_cell_next.attr('class') );
            if (obj_time_cell_next.hasClass('time_payment')) {
                idx = i - 1;
                var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i+1);
                thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                // console.log('time_payment', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                i = val_time_blank_count_max;
                continue;
            } else
                // res는 무시한다.
                // if ( obj_time_cell_next.hasClass('res') ) {
                //     idx = i-1;
                //     var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                //     // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                //     thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                //     // console.log( 'thisTimeEnd res' , thisTimeEnd , i , obj_time_cell_next.attr('class') );
                //     i = val_time_blank_count_max;
                //     continue;
                // } else
                if (obj_time_cell_next.hasClass('not')) {
                    idx = i - 1;
                    var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                    thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    // console.log('not', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                    i = val_time_blank_count_max;
                    continue;
                } else
                    // if ( obj_time_cell_next.hasClass('res') ) {
                    //     idx = i-1;
                    //     var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                    //     // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                    //     thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                    //     // console.log( 'thisTimeEnd res' , thisTimeEnd , i , obj_time_cell_next.attr('class') );
                    //     i = val_time_blank_count_max;
                    //     continue;
                    // } else
                    if (obj_time_cell_next.hasClass('ing')) {
                        idx = i - 1;
                        var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                        // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                        thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                        // console.log('ing', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                        i = val_time_blank_count_max;
                        continue;
                    } else
            if (obj_time_cell_next.hasClass('holiday')) {
                idx = i - 1;
                var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i-2);
                thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                // console.log('holiday', thisTimeEnd, i, obj_time_cell_next.attr('class'));
                i = val_time_blank_count_max;
                continue;
            } else {
                idx = i;
                var obj_time_cell_2 = obj_artist_line.find('>div').eq(idx);
                // obj_time_cell_next = obj_artist_line.find('.artist_time_line.on').find('>div').eq(i);
                thisTimeEnd = obj_time_cell_2.attr('data-time-from');
                // console.log('thisTimeEnd normal', thisTimeEnd, i);
            }
        }
        // console.log( 'thisTimeEnd' , thisTimeEnd , val_time_blank_count_max );
        // 선택가능 종료시점 조사

        // console.log(thisTimeStart, thisTimeEnd);

        var param = '';
        if (dat_payment_log_seq !== undefined && dat_payment_log_seq) {
            param += (param ? '&' : '?') + 'payment_log_seq=' + dat_payment_log_seq;
        }
        if (thisTimeStart !== undefined && thisTimeStart) {
            param += (param ? '&' : '?') + 'thisTimeStart=' + thisTimeStart;
        }
        if (thisTimeEnd !== undefined && thisTimeEnd) {
            param += (param ? '&' : '?') + 'thisTimeEnd=' + thisTimeEnd;
        }
        //param += (param ? '&' : '?') + 'backurl=' + encodeURIComponent(window.location.href);
        var link_view = (dat_customer_id !== undefined && dat_customer_id) ? 'reserve_pay_management_2' + param : 'reserve_pay_management_2' + param;
        // var 

        // console.log('link_view', link_view);
        var aseq = $(this).data('approve_seq');
        if($(this).data('approve_chk')=='0'){
            location.href='./reserve_pay_management_1?reserve_approval_idx='+aseq;
        } else {
            document.location.href = link_view;
        }

    });
    

    
    //$(".reserve-calendar-top select").val('<?= (int) date('Y', strtotime($first_date)) ?>.<?= (int) date('m', strtotime($first_date)) ?>.<?= (int) date('d', strtotime($first_date)) ?>');
    //console.log($(".reserve-calendar-top select").val());
    $(".reserve-calendar-top .txt").text($(".reserve-calendar-top select option:selected").attr("data-rol1")+" ("+$(".reserve-calendar-top select option:selected").attr("data-rol2")+")");
    
    var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
    if(idx==0){
        $(".btn-month-next").hide();
    }

    if(idx==11){
        $(".btn-month-prev").hide();
    }
    

    $(".reserve-calendar-top select").change(function () { 
        
        var yymm    = $(this).val().split(".");
        if(yymm[1]>=10){
            location.href="reserve_main_day?ch=week&yy="+yymm[0]+"&mm="+yymm[1]+"&dd="+yymm[2];
        }else if(yymm[1]<10 && yymm[2]<10){
            location.href="reserve_main_day?ch=week&yy="+yymm[0]+"&mm="+yymm[1].replace("0","")+"&dd="+yymm[2].replace("0","");
        }else if(yymm[1]>10 && yymm[2]<10){
            location.href="reserve_main_day?ch=week&yy="+yymm[0]+"&mm="+yymm[1]+"&dd="+yymm[2].replace("0","");
        }else{
            location.href="reserve_main_day?ch=week&yy="+yymm[0]+"&mm="+yymm[1].replace("0","")+"&dd="+yymm[2];
        }
        
    });



    $(".btn-month-prev").click(function (e) { 
        var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
        $('.reserve-calendar-top select option:eq(' + (idx+1) + ')').prop('selected', 'selected').change();
        e.preventDefault();
        
    });

    $(".btn-month-next").click(function (e) { 
        var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
        $('.reserve-calendar-top select option:eq(' + (idx-1) + ')').prop('selected', 'selected').change();
        e.preventDefault();
        
    });

    console.log($(".calendar-day-body").height());

    var now_date = new Date();
    var now_hours = now_date.getHours();
    var now_m = now_date.getMinutes();
    var workTimeStart = '<?php echo $tws[0]['working_start'];?>';
    var workTimeEnd = '<?php echo $tws[0]['working_end'];?>';

    var line_hieght = ((now_hours-workTimeStart)*60+now_m)*1.35;
    var end_time = ((workTimeEnd-workTimeStart)*60)*1.35;
    console.log(line_hieght, end_time);
    if(line_hieght>0 && line_hieght<end_time){
        $(".calendar-day-current-time").css("top",line_hieght+"px");
    }else{
        $(".calendar-day-current-time").hide();
    }


    var obj_dialog_time_form = $("#reserveCalendarPop3");
    var obj_form_time = obj_dialog_time_form.find("#form_time");


    $(".btn-change-submit").click(function (e) { 
        $("#reserveCalendarPop4 input[name='log_type']").val("change");
        
        var data_form = $("#form_change").serialize();
        $.ajax({
            async: false,
            type: 'post',
            url: 'data/data_set_change_work',
            data: data_form,
            dataType: 'json',
            error: function() {},
            success: function(json) {
                // console.log(json);
                if (json !== undefined) {
                    if (json.res == true) {
                        console.log(json);
                        //document.location.reload(true);
                    } else {
                        console.log(json);
                        //$.MessageBox(json.error);
                    }
                }
                // document.location.reload(true);
            }
        });
        e.preventDefault();
        
    });

    
    
});
function show_alert(obj){
    if(obj == 'hotel' || obj == 'playroom'){
        popalert.open('reserveCalendarPop1','준비중입니다.');
    }
}
$(document).ready(function(){
    $('#header_bell').css('display','none');
    $('#btn_page_prev').prop('href','home_main')
})
</script>



<?
include($_SERVER['DOCUMENT_ROOT']."/include/skin/footer_shop.php");
?>
