<?
include($_SERVER['DOCUMENT_ROOT']."/include/global.php");
include($_SERVER['DOCUMENT_ROOT']."/include/skin/header_shop.php");

$obj = new module();
$chk_mobile = $obj->mobileConcertCheck();

$backurl = isset($_GET['backurl']) ? $_GET['backurl']: "";
$user_id = $_SESSION['gobeauty_user_id'];
$user_name = $_SESSION['gobeauty_user_nickname'];

$order_num = "I".STRTOTIME(DATE("Y-m-d H:i:s")).str_pad(rand(0,99),"2","0",STR_PAD_LEFT); // 결제용

$partner_sql = "
    SELECT * FROM tb_item_partner WHERE is_delete = '1' and not ip_seq = '3'
";
$partner_array = sql_fetch_array($partner_sql);
// price_calculator 함수에서 배송비 초기화할때 사용
$company_cnt = ["",0,0,0,];
foreach($partner_array as $rs){
    array_push($company_cnt, 0);
}



?>

    <!-- header -->
    <header id="header">
        <div class="header-left">
            <a href="javascript:history.back();" class="btn-page-ui btn-page-prev"><div class="icon icon-size-24 icon-page-prev">페이지 뒤로가기</div></a>
        </div>
        <div class="page-title">장바구니</div>
    </header>
    <!-- //header -->

    <!-- container -->
    <section id="container">
        <!-- page-body -->
        <div class="page-body">
            <div class="shop-cart-wrap">
                <div class="shop-cart-all"><label class="form-checkbox"><input type="checkbox" name="allchk" checked><span class="form-check-icon"><em>전체선택</em></span></label></div>
                <!-- 직배송 -->
                <div class="basic-data-group in_product">
                    <h3 class="delivery-title purple">직배송</h3>
                    <div class="shop-cart-list">
                        <!-- 품절시 soldout 클래스 추가 -->
                        <!-- <div class="shop-cart-list-cell soldout">
                            <div class="shop-cart-items">
                                <div class="shop-cart-header">
                                    <div>
                                        <label class="form-checkbox"><input type="checkbox" name="all"><span class="form-check-icon"><em>선택</em></span></label>
                                    </div>
                                    <div>
                                        <div class="shop-cart-ui">
                                            <div class="shop-cart-ui-cell"><button type="button" class="btn-shop-cart-ui-item">주문내용 수정</button></div>
                                            <div class="shop-cart-ui-cell"><button type="button" class="btn-shop-cart-ui-item">수정</button></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="shop-cart-body">
                                    <div class="item-info-wrap">
                                        <div class="item-thumb"><img src="/static/pub/images/user_thumb.png" alt=""></div>
                                        <div class="item-data">
                                            <div class="item-data-inner">
                                                <div class="item-name">[도기프렌드] 수제 간식세트</div>
                                                <div class="item-option">
                                                    <div>올리브</div>
                                                    <div class="item-option-division">/</div>
                                                    <div>1개</div>
                                                </div>
                                                <div class="item-price">7,500원</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="item-total-price">상품 7,500원 + 배송비 2,500원 = 10,000원</div>
                                </div>
                            </div>
                        </div> -->
                    </div>
                    <!-- 일단 무배 뺀다 -->
                    <!--<div class="item-total-price">상품 7,500원 + 배송비 2,500원 = 10,000원</div>-->
                    <!--<div class="basic-data-group middle">
                        <div class="delivery-process">
                            <div class="delivery-process-info">
                                <em>3만원 이상 무료배송</em>
                                <p>10,000원 추가하면 무료배송</p>
                            </div>
                            <div class="delivery-process-bar"><div class="bar" style="width:50%"></div></div>
                        </div>
                    </div>-->
                    <div class="basic-data-group middle">
                        <div class="price-data-wrap">
                            <div class="price-data-group">
                                <div class="price-data-title">직배송 주문요약</div>
                                <div class="price-data-list">
                                    <div class="price-data-list-cell">
                                        <div class="price-data-list-title">상품소계</div>
                                        <div class="price-data-list-value goods">15,000원</div>
                                    </div>
                                    <div class="price-data-list-cell">
                                        <div class="price-data-list-title">배송비</div>
                                        <div class="price-data-list-value shipping">5,000원</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- //직배송 -->
                <!-- 업체배송(직배송) -->
                <div class="basic-data-group special_product">
                    <!--<h3 class="delivery-title apricot">위탁배송</h3>
                    <div class="shop-cart-list_1"></div>
                    <div class="shop-cart-list_2"></div>
                    <div class="shop-cart-list_3"></div>
                    <div class="shop-cart-list_4"></div>
                    <div class="shop-cart-list">
                        <div class="shop-cart-list-cell">
                            <div class="shop-cart-items">
                                <div class="shop-cart-header">
                                    <div>
                                        <label class="form-checkbox"><input type="checkbox" name="all"><span class="form-check-icon"><em>선택</em></span></label>
                                    </div>
                                    <div>
                                        <div class="shop-cart-ui">
                                            <div class="shop-cart-ui-cell"><button type="button" class="btn-shop-cart-ui-item">주문내용 수정</button></div>
                                            <div class="shop-cart-ui-cell"><button type="button" class="btn-shop-cart-ui-item">수정</button></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="shop-cart-body">
                                    <div class="item-info-wrap">
                                        <div class="item-thumb"><img src="/static/pub/images/user_thumb.png" alt=""></div>
                                        <div class="item-data">
                                            <div class="item-data-inner">
                                                <div class="item-name">[도기프렌드] 수제 간식세트</div>
                                                <div class="item-option">
                                                    <div>올리브</div>
                                                    <div class="item-option-division">/</div>
                                                    <div>1개</div>
                                                </div>
                                                <div class="item-price">7,500원</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="item-total-price">상품 7,500원 + 배송비 2,500원 = 10,000원</div>
                                </div>
                            </div>
                        </div>
                    </div>-->
<!--                    <div class="item-total-price">상품 7,500원 + 배송비 2,500원 = 10,000원</div>-->
<!--                    <div class="basic-data-group middle">-->
<!--                        <div class="delivery-process">-->
<!--                            <div class="delivery-process-info">-->
<!--                                <em>5만원이상 무료배송</em>-->
<!--                                <p>10,000원 추가하면 무료배송</p>-->
<!--                            </div>-->
<!--                            <div class="delivery-process-bar"><div class="bar" style="width:50%"></div></div>-->
<!--                        </div>-->
<!--                    </div>-->
                    <div class="basic-data-group middle">
                        <div class="price-data-wrap">
                            <div class="price-data-group">
                                <div class="price-data-title">위탁배송 주문요약</div>
                                <div class="price-data-list">
                                    <div class="price-data-list-cell">
                                        <div class="price-data-list-title">상품소계</div>
                                        <div class="price-data-list-value goods">15,000원</div>
                                    </div>
                                    <div class="price-data-list-cell">
                                        <div class="price-data-list-title">배송비</div>
                                        <div class="price-data-list-value shipping">5,000원</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- //업체배송 -->
                <!-- 업체배송 -->
                <div class="basic-data-group out_product">
                    <h3 class="delivery-title black">업체배송</h3>
                    <div class="shop-cart-list">
                        <!-- <div class="shop-cart-list-cell">
                            <div class="shop-cart-items">
                                <div class="shop-cart-header">
                                    <div>
                                        <label class="form-checkbox"><input type="checkbox" name="all"><span class="form-check-icon"><em>선택</em></span></label>
                                    </div>
                                    <div>
                                        <div class="shop-cart-ui">
                                            <div class="shop-cart-ui-cell"><button type="button" class="btn-shop-cart-ui-item">주문내용 수정</button></div>
                                            <div class="shop-cart-ui-cell"><button type="button" class="btn-shop-cart-ui-item">수정</button></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="shop-cart-body">
                                    <div class="item-info-wrap">
                                        <div class="item-thumb"><img src="/static/pub/images/user_thumb.png" alt=""></div>
                                        <div class="item-data">
                                            <div class="item-data-inner">
                                                <div class="item-name">[도기프렌드] 수제 간식세트</div>
                                                <div class="item-option">
                                                    <div>올리브</div>
                                                    <div class="item-option-division">/</div>
                                                    <div>1개</div>
                                                </div>
                                                <div class="item-price">7,500원</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="item-total-price">상품 7,500원 + 배송비 2,500원 = 10,000원</div>
                                </div>
                            </div>
                        </div> -->
                    </div>
                    <!--<div class="item-total-price">상품 7,500원 + 배송비 2,500원 = 10,000원</div>-->
                    <div class="basic-data-group middle">
                        <div class="delivery-process">
                            <div class="delivery-process-info">
                                <em>10만원이상 무료배송</em>
                                <p>10,000원 추가하면 무료배송</p>
                            </div>
                            <div class="delivery-process-bar"><div class="bar" style="width:50%"></div></div>
                        </div>
                    </div>
                    <div class="basic-data-group middle">
                        <div class="price-data-wrap">
                            <div class="price-data-group">
                                <div class="price-data-title">업체배송 주문요약</div>
                                <div class="price-data-list">
                                    <div class="price-data-list-cell">
                                        <div class="price-data-list-title">상품소계</div>
                                        <div class="price-data-list-value goods">15,000원</div>
                                    </div>
                                    <div class="price-data-list-cell">
                                        <div class="price-data-list-title">배송비</div>
                                        <div class="price-data-list-value shipping">5,000원</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- //위탁배송 -->
                <!-- 총 결제 금액 -->
                <div class="basic-data-group vmiddle line">
                    <a href="shop_mall" class="btn btn-gray btn-middle-size btn-round"><em class="font-color-purple">더 채울 상품 둘러보기</em><div class="icon icon-btn-more-purple"></div></a>
                </div>
                <div class="basic-data-group middle">
                    <div class="price-data-wrap">
                        <div class="price-data-group">
                            <div class="price-data-list">
                                <div class="price-data-list-cell middle">
                                    <div class="price-data-list-title">총 상품가격</div>
                                    <div class="price-data-list-value total_goods_price">22,500원</div>
                                </div>
                                <div class="price-data-list-cell middle">
                                    <div class="price-data-list-title">총 배송비</div>
                                    <div class="price-data-list-value total_shipping_price">10,000원</div>
                                </div>
                                <div class="price-data-list-cell total">
                                    <div class="price-data-list-title">총 결제금액</div>
                                    <div class="price-data-list-value total_pay_price">32,500원</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- //총 결제 금액 -->
            </div>

        </div>
        <!-- //page-body -->
        <!-- page-bottom -->
        <div class="page-bottom">
            <!--
            //	비활성화시
            // - a태그는 disabled 클래스 추가
            // - button 태그는 disabled 속성 추가
            -->

            <!-- 이벤트로 선택값만 넘어가도록 수정 필 -->
            <a href="javascript:set_item_payment();" class="btn-page-bottom">구매하기</a>
        </div>
        <!-- //page-bottom -->

        <!-- 주문내역 수정 -->
        <article id="cartModifyPop" class="layer-pop-wrap"></article>
        <!-- //주문내역 수정 -->

        <!--  삭제하기 -->
        <article id="cartDelPop" class="layer-pop-wrap">
        </article>
        <!-- //삭제하기 -->
    </section>
    <!-- //container -->

    <style>

        .out_product { display: none; }
        .out_product.actived { display: block; }

        .in_product { display: none; }
        .in_product.actived { display: block; }

        .special_product { display: none; }
        .special_product.actived { display: block; }


    </style>

    <script>
        var $item_cart = $("#container");
        var $item_cart_popup = $("#item_cart_popup");
        var customer_id = "<?=$user_id ?>";
        var company_cnt = <?php echo count($company_cnt) ?>; // 업체배송, 직배송 포함 업체 수
        var shipping_price = ["",3500, 4000, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 배송비
        var is_free_shipping_limit = ["", 100000, 3000000, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송 시작 금액
        var is_free_shipping_total = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송인 상품
        var is_free_shipping_cnt = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 상품 개수
        var is_free_shipping_price = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기  ==> 최종 구매가격
        var is_free_shipping_do = ["", 1, 1, 0] // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송정책 사용여부 0:미사용, 1:사용
        var new_order_num = "<?=$order_num ?>";
        var soldout_flag = 0;
        var item_update_flag = 0;
        var item_cart_cnt = 0;
        var cart = [];
        var _height = 220; // 팝업창 높이 default 220
        var sofa = 0; // 소파 가격
        var chk_mobile = "<?=$chk_mobile ?>"; // 모바일 체크
        $(function(){
            get_partner_list()
            .then(get_item_cart);
        });

        // 위탁업체 칸 만들기
        function get_partner_list(){
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: 'data/item_ajax.php',
                    data: {
                        mode: "get_partner_list"
                    },
                    type: 'POST',
                    dataType: 'JSON',
                    success: function(data) {
                        if(data.code == "000000"){

                            console.log(data.data[0]);
                            var html = '<h3 class="delivery-title apricot">위탁배송</h3><br>';
                            $.each(data.data[0], function(i, v){
                                html += '<div class="shop-cart-list cart_list_'+v.ip_seq+'" style="display: none;">['+v.company_name+']</div>';
                                html += '<div class="item-total-price item_total_price_'+v.ip_seq+'" style="display: none;"></div>';
                                html += '<div class="basic-data-group middle free_shipping_'+v.ip_seq+'" style="display: none;">';
                                if(v.is_free_shipping != '0') {
                                    html += '    <div class="delivery-process">';
                                    html += '        <div class="delivery-process-info">';
                                    html += '            <em>1억원이상 무료배송</em>';
                                    html += '            <p>9천9백만원 남음</p>';
                                    html += '        </div>';
                                    html += '        <div class="delivery-process-bar"><div class="bar" style="width:50%"></div></div>';
                                    html += '    </div>';
                                }
                                html += '</div>';
                                is_free_shipping_limit.push(parseInt(v.free_shipping_price)); // 무료배송 시작 금액
                                shipping_price.push(v.shipping_price); // 배송비
                                is_free_shipping_total.push(0); // 무료배송인 상품 개수
                                is_free_shipping_cnt.push(0) // 총 상품 개수
                                is_free_shipping_price.push(0) // 최종 구매 가격
                                is_free_shipping_do.push(parseInt(v.is_free_shipping)); // 무배정책 사용 여부 0: 미사용 1: 가격으로 사용 2: 개수로 사용(우선 가격만 적용)
                            });
                            $item_cart.find('.special_product').prepend(html);
                            // $item_cart.find('.special_product').addClass('actived');
                            console.log(is_free_shipping_limit);
                            console.log(is_free_shipping_total);
                            console.log(is_free_shipping_cnt);
                            console.log(is_free_shipping_price);
                            console.log(is_free_shipping_do);
                        }else{
                            alert(data.data+"("+data.code+")");
                            console.log(data.code);
                        }
                        resolve();
                    },
                    error: function(xhr, status, error) {
                        //alert(error + "네트워크에러");
                        if(xhr.status != 0){
                            alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                        }
                    }
                });
            });
        }

        // 장바구니에 담긴 제품 가져오기
        function get_item_cart(){
            console.log("get_item_cart" );
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: 'data/item_ajax.php',
                    data: {
                        mode: "get_cart",
                        direct_chk: "0",
                        customer_id: customer_id
                    },
                    type: 'POST',
                    dataType: 'JSON',
                    success: function(data) {
                        if(data.code == "000000"){
                            console.log(data.data);

                            if(data.data[0] && data.data[0].length > 0){
                                item_cart_cnt = data.data[0].length;

                                $.each(data.data[0], function(i, v){
                                    get_item_list(v)
                                        .then(price_calculator);
                                });
                            }else{
                                var cart_html = '';
                                cart_html += '<div style="margin-top:100px;">';
                                cart_html += '<img src="https://image.banjjakpet.com/images/ico_cart.png" alt="" style="width:130px;margin-bottom:20px;display:block;margin:20px auto;">'
                                cart_html += '</div>';
                                cart_html += '<div style="font-size:16px;text-align:center;color: rgba(0,0,0,0.5);">';
                                cart_html += '앗, 아직 담긴 상품이 없네요..<br>쇼핑을 시작해보세요.'
                                cart_html += '</div>';

                                $('.shop-cart-wrap').html(cart_html);
                                $('.btn-page-bottom').addClass('disabled')
                            }

                            resolve();
                        }else{
                            alert(data.data+"("+data.code+")");
                            console.log(data.code);
                        }
                    },
                    error: function(xhr, status, error) {
                        //alert(error + "네트워크에러");
                        if(xhr.status != 0){
                            alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                        }
                    }
                });
            });
        }

        // 장바구니에 담긴 제품 뿌려주기
        function get_item_list(cart_data){
            return new Promise(function(resolve, reject) {
                console.log("get_item_list");
                console.log(cart_data);
                //var cart_data = JSON.parse(cart_data);
                $.ajax({
                    url: 'data/item_ajax.php',
                    data: {
                        mode : "get_item",
                        product_no: cart_data.product_no
                    },
                    type: 'POST',
                    dataType: 'JSON',
                    success: function(data) {
                        if(data.code == "000000"){
                            console.log(data.data['item']);
                            var html = '';
                            var sum_price = 0;

                            if(data.data['item'] && data.data['item'].length > 0){
                                $.each(data.data['item'], function(i, v){
                                    var is_free = 0; // 무료배송상품인지 확인 - 체크시 사용
                                    var parse_cart_data = JSON.parse(cart_data.cart_data);
                                    var is_checked = "";
                                    if(v.is_soldout == 2){
                                        html += '<div class="shop-cart-list-cell soldout" data-seq="'+cart_data.ic_seq+'">';
                                    }else{
                                        is_checked = "checked";
                                        html += '<div class="shop-cart-list-cell" data-seq="'+cart_data.ic_seq+'">';
                                    }
                                    html += '<div class="shop-cart-items" data-seq="'+cart_data.ic_seq+'">';
                                    html +=     '<div class="shop-cart-header">'
                                    html +=         '<div>'
                                    html +=             '<label class="form-checkbox"><input type="checkbox" class="company_num" id="chk_'+cart_data.ic_seq+'" name="chk[]" value="'+cart_data.ic_seq+'" checked ><span class="form-check-icon"><em>선택</em></span></label>'
                                    html +=         '</div>'
                                    html +=         '<div>'
                                    html +=             '<div class="shop-cart-ui">'
                                    html +=                 '<div class="shop-cart-ui-cell renew"><button type="button" onclick="modify_item(\''+cart_data.ic_seq+'\');" class="btn-shop-cart-ui-item">주문내용 수정</button></div>'
                                    html +=                 '<div class="shop-cart-ui-cell" style="z-index:20;"><button type="button" onclick="delete_item(\''+cart_data.ic_seq+'\');" class="btn-shop-cart-ui-item">삭제</button></div>'
                                    html +=             '</div>'
                                    html +=         '</div>'
                                    html +=     '</div>'
                                    html +=     '<div class="shop-cart-body">'
                                    html +=         '<div class="item-info-wrap">'
                                    html +=             '<div class="item-thumb"><img src="'+data.data['photo'][i]+'" alt=""></div>'
                                    html +=             '<div class="item-data">'
                                    html +=                 '<div class="item-data-inner">'
                                    html +=                     '<div class="item-name">'+v.product_name+'</div>'

                                    $.each(parse_cart_data, function(i2, v2){

                                        html +=                     '<div class="item-option">'
                                        html +=                         '<div>'+v2.txt+'</div>'
                                        html +=                         '<div class="item-option-division">/</div>'
                                        html +=                         '<div>'+(v2.value).format()+'원</div>'
                                        html +=                         '<div class="item-option-division">/</div>'
                                        html +=                         '<div>'+v2.amount+'개</div>'
                                        html +=                     '</div>'

                                        // 무료배송인 상품 개수 구하기

                                        if(v2.is_free_shipping == 1){
                                            is_free = 1;
                                            if(v.ip_seq > 0){
                                                is_free_shipping_total[v.ip_seq]++;
                                            }else{
                                                is_free_shipping_total[v.is_supply]++;
                                            }
                                        }

                                        //총 상품 개수 구하기
                                        if(v.ip_seq > 0){
                                            is_free_shipping_cnt[v.ip_seq]++;
                                        }else{
                                            is_free_shipping_cnt[v.is_supply]++;
                                        }

                                        // 소파 무배에서 제외
                                        if(cart_data.product_no == "CN-BANJJAK-A01"){
                                            sofa += parseInt(v2.value*v2.amount);
                                            //shipping_price[2] += 4000*(v2.amount);
                                        }

                                        sum_price += parseInt(v2.value * v2.amount);

                                        if(v.is_supply == "1" && v.supplier == "정글북"){ // 외주업체(정글북)
                                            console.log("goods", v.goodsNo, v2.amount, cart_data.ic_seq);
                                            get_jbook_list2("goods", v.goodsNo, v2.amount, cart_data.ic_seq);
                                        }
                                    });



                                    // 해당 상품의 최종 구매 가격 구하기 && 순서 구하기
                                    var company_num = 0;
                                    if(v.ip_seq > 0){
                                        is_free_shipping_price[v.ip_seq] += sum_price;
                                        company_num = v.ip_seq;
                                    }else{
                                        is_free_shipping_price[v.is_supply] += sum_price;
                                        company_num = v.is_supply;
                                    }

                                    html +=                     '<div class="item-price" data-free="'+is_free+'" data-num="'+company_num+'" data-price="'+sum_price+'">'+sum_price.format()+'원</div>'
                                    html +=                 '</div>'
                                    html +=             '</div>'
                                    html +=         '</div>'
                                    // if(is_free_shipping == 1){
                                    //     html +=         '<div class="item-total-price">상품 '+sum_price+'원(배송비무료) = '+sum_price+'원</div>'
                                    // }else{
                                    //     const sum = sum_price + shipping_price;
                                    //     html +=         '<div class="item-total-price">상품 '+sum_price+'원 + 배송비 '+shipping_price+'원 = '+sum+'원</div>'
                                    // }
                                    html +=     '</div>'
                                    html += '</div>'; //shop-cart-items
                                    html += '</div>'; //shop-cart-list-cell


                                    if(v.is_supply == "2"){ // 직배송
                                        $item_cart.find('.in_product .shop-cart-list').append(html);
                                        $item_cart.find('.in_product').addClass('actived');
                                        $item_cart.find('.in_product .shop-cart-list .company_num').addClass('num'); // 순서 지정 업체배송, 직배송, 비워두기, 위탁업체
                                    }else if(v.is_supply == "1" && v.ip_seq > 0){ // 위탁 판매
                                        $item_cart.find('.special_product .cart_list_'+v.ip_seq).append(html).css("display","block");
                                        $item_cart.find('.special_product .item_total_price_'+v.ip_seq).css("display","block");
                                        $item_cart.find('.special_product .free_shipping_'+v.ip_seq).css("display","block");
                                        $item_cart.find('.special_product').addClass('actived');
                                        $item_cart.find('.special_product .shop-cart-list .company_num').data('num',v.ip_seq); // 순서 지정 업체배송, 직배송, 비워두기, 위탁업체
                                    }else{ // 업체배송
                                        $item_cart.find('.out_product .shop-cart-list').append(html);
                                        $item_cart.find('.out_product').addClass('actived');
                                        $item_cart.find('.out_product .shop-cart-list .company_num').data('num',1); // 순서 지정 업체배송, 직배송, 비워두기, 위탁업체
                                    }
                                    // if(v.is_supply == "1"){ // 업체배송
                                    //     $item_cart.find('.out_product .shop-cart-list').append(html);
                                    //     $item_cart.find('.out_product').addClass('actived');
                                    // }else if(v.is_supply == "2"){ // 직배송
                                    //     if(v.ip_seq == '7'){ // 하이포닉 상품일 때
                                    //         $item_cart.find('.special_product .shop-cart-list').append(html);
                                    //         $item_cart.find('.special_product').addClass('actived');
                                    //     }else{
                                    //         $item_cart.find('.in_product .shop-cart-list').append(html);
                                    //         $item_cart.find('.in_product').addClass('actived');
                                    //     }
                                    // }else{
                                    // }


                                    item_update_flag++;
                                    resolve();
                                });
                            }
                        }else{
                            alert(data.data+"("+data.code+")");
                            console.log(data.code);
                        }
                    },
                    error: function(xhr, status, error) {
                        //alert(error + "네트워크에러");
                        if(xhr.status != 0){
                            alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                        }
                    }
                });
            });
        }

        // 총 주문금액 계산하기
        function price_calculator(){
            return new Promise(function(resolve, reject) {
                if(item_update_flag == item_cart_cnt){ // each end flag
                    var total_shipping_price = 0; // 최종 배송비 합
                    var _shipping_price = <?php echo json_encode($company_cnt) ?>; // 배송비 배열
                    // var _total_price = is_free_shipping_price[1] + is_free_shipping_price[2] + is_free_shipping_price[3];
                    var _total_price = 0;
                    var special_total_price = 0; // 위탁업체 상품 총 가격
                    var special_shipping_price = 0; // 위탁업체 배송비 총 가격
                    for(var j=1;j<company_cnt;j++){
                        // 모든상품 최종 결제 금액
                         console.log(is_free_shipping_price[j]);
                        _total_price += parseInt(is_free_shipping_price[j]);
                    }
                    console.log(_total_price);
                    console.log("무배 스타트");

                    // 소파만 있을때 배송비 기본 직배송 배송비 3000 제외
                    if(is_free_shipping_cnt[2] == 1 && sofa > 0){
                        //shipping_price[2] -= 3000;
                    }

                    for(var i=1;i<company_cnt;i++){
                        // 아무 상품도 선택 안됐을때(사실상 뜨지않음)
                        if(is_free_shipping_price[i] == 0){
                            console.log(is_free_shipping_limit[i]);
                            if(i == 1){ // 업체배송일때
                                $item_cart.find('.out_product .delivery-process-info p').html((is_free_shipping_limit[i]).format()+'원 추가하면 무료배송');
                                $item_cart.find('.out_product .delivery-process-bar .bar').animate({width: '0%'}, 100);
                            }else if(i == 2){ // 직배송일때
                                $item_cart.find('.in_product .delivery-process-info p').html((is_free_shipping_limit[i]).format()+'원 추가하면 무료배송');
                                $item_cart.find('.in_product .delivery-process-bar .bar').animate({width: '0%'}, 100);
                            }else {
                                if(is_free_shipping_do[i] > 0) {
                                    $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-info em').html((is_free_shipping_limit[i]).toString().slice(0, -4) + '만원 이상 무료배송');
                                    $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-info p').html((is_free_shipping_limit[i]).format() + '원 추가하면 무료배송무');
                                    $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-bar .bar').animate({width: '0%'}, 100);
                                }
                            }
                        // 선택한 상품이 있을때
                        }else{
                            // 선택 가격이 무료배송시작금액보다 클 경우
                            if(is_free_shipping_price[i]>= is_free_shipping_limit[i]){
                                _shipping_price[i] = 0;
                                if(i == 1){ // 업체배송일때
                                    $item_cart.find('.out_product .delivery-process-info p').html('무료배송');
                                    $item_cart.find('.out_product .delivery-process-bar .bar').animate({width: '100%'}, 100);
                                }else if(i == 2){ // 직배송일때
                                    $item_cart.find('.in_product .delivery-process-info p').html('무료배송');
                                    $item_cart.find('.in_product .delivery-process-bar .bar').animate({width: '100%'}, 100);
                                }else {
                                    $item_cart.find('.special_product .item_total_price_'+i).text('상품 '+is_free_shipping_price[i].format()+'원(배송비무료) = '+is_free_shipping_price[i].format()+'원');
                                    if(is_free_shipping_do[i] > 0) {
                                        $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-info em').html((is_free_shipping_limit[i]).toString().slice(0, -4) + '만원 이상 무료배송');
                                        $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-info p').html('무료배송');
                                        $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-bar .bar').animate({width: '100%'}, 100);
                                    }
                                }
                            // 선택 가격이 무료배송시작금액보다 작을 경우
                            }else{
                                // 무료배송 상품이 있을 경우
                                if(is_free_shipping_total[i] > 0){
                                    _shipping_price[i] = 0;
                                    if(i == 1){ // 업체배송일때
                                        $item_cart.find('.out_product .delivery-process-info em').html('무료배송 상품 포함');
                                        $item_cart.find('.out_product .delivery-process-info p').html('무료배송');
                                        $item_cart.find('.out_product .delivery-process-bar .bar').animate({width: '0%'}, 100);
                                    }else if(i == 2){ // 직배송일때
                                        $item_cart.find('.in_product .delivery-process-info em').html('무료배송 상품 포함');
                                        $item_cart.find('.in_product .delivery-process-info p').html('무료배송');
                                        $item_cart.find('.in_product .delivery-process-bar .bar').animate({width: '0%'}, 100);
                                    }else {
                                        $item_cart.find('.special_product .item_total_price_'+i).text('상품 '+is_free_shipping_price[i].format()+'원(배송비무료) = '+is_free_shipping_price[i].format()+'원');
                                        if(is_free_shipping_do[i] > 0) {
                                            $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-info em').html('무료배송 상품 포함');
                                            $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-info p').html('무료배송');
                                            $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-bar .bar').animate({width: '0%'}, 100);
                                        }
                                    }
                                // 무료배송 상품 없을경우
                                }else{
                                    _shipping_price[i] = parseInt(shipping_price[i]);
                                    if(i == 1){ // 업체배송일때
                                        $item_cart.find('.out_product .delivery-process-info p').html((is_free_shipping_limit[i] - is_free_shipping_price[i]).format()+'원 추가하면 무료배송');
                                        $item_cart.find('.out_product .delivery-process-bar .bar').animate({width: Math.round(is_free_shipping_price[i] / is_free_shipping_limit[i] * 100)+'%'}, 100);
                                    }else if(i == 2){ // 직배송일때
                                        $item_cart.find('.in_product .delivery-process-info p').html((is_free_shipping_limit[i] - is_free_shipping_price[i] + sofa).format()+'원 추가하면 무료배송');
                                        $item_cart.find('.in_product .delivery-process-bar .bar').animate({width: Math.round((is_free_shipping_price[i] - sofa) / is_free_shipping_limit[i] * 100)+'%'}, 100);
                                    }else {
                                        $item_cart.find('.special_product .item_total_price_'+i).text('상품 '+is_free_shipping_price[i].format()+'원 + '+shipping_price[i].format()+'원 = '+is_free_shipping_price[i].format()+'원');
                                        if(is_free_shipping_do[i] > 0) {
                                            console.log(is_free_shipping_limit[i] , is_free_shipping_price[i]);
                                            $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-info em').html((is_free_shipping_limit[i]).toString().slice(0, -4) + '만원 이상 무료배송');
                                            $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-info p').html((is_free_shipping_limit[i] - is_free_shipping_price[i]).format() + '원 추가하면 무료배송');
                                            $item_cart.find('.special_product .free_shipping_' + i + ' .delivery-process-bar .bar').animate({width: Math.round(is_free_shipping_price[i] / is_free_shipping_limit[i] * 100) + '%'}, 100);
                                        }
                                    }
                                }
                            }

                            if(_shipping_price[i] < 0){
                                _shipping_price[i] = 0;
                            }

                            if(is_free_shipping_cnt[i] == 0){
                                _shipping_price[i] = 0;
                            }

                        }
                        if(i == 1){ // 업체배송일때
                            $item_cart.find('.out_product .price-data-list-cell .goods').html((is_free_shipping_price[i]).format()+"원");
                            $item_cart.find('.out_product .price-data-list-cell .shipping').html((_shipping_price[i]).format()+"원");
                        }else if(i == 2){ // 직배송일때
                            $item_cart.find('.in_product .price-data-list-cell .goods').html((is_free_shipping_price[i]).format()+"원");
                            $item_cart.find('.in_product .price-data-list-cell .shipping').html((_shipping_price[i]).format()+"원");
                        }else {
                            special_total_price += is_free_shipping_price[i];
                            special_shipping_price += _shipping_price[i];
                            $item_cart.find('.special_product .price-data-list-cell .goods').html((special_total_price).format()+"원");
                            $item_cart.find('.special_product .price-data-list-cell .shipping').html((special_shipping_price).format()+"원");
                        }

                        total_shipping_price += parseInt(_shipping_price[i]);

                        // if((parseInt(_shipping_price[1]) + parseInt(_shipping_price[2]) + parseInt(_shipping_price[3])) == 0){
                        //     $item_cart.find('.vmiddle').hide();
                        // }else{
                        //     $item_cart.find('.vmiddle').show();
                        // }

                    }
                    $item_cart.find('.total_goods_price').text(_total_price.format()+"원");
                    $item_cart.find('.total_shipping_price').text(total_shipping_price.format()+"원");
                    $item_cart.find('.total_pay_price').text((_total_price + total_shipping_price).format()+"원");
                    $item_cart.find('.btn-page-bottom').text((_total_price + total_shipping_price).format()+"원 구매하기");

                }

                resolve();
            });
        }

        // 상품 삭제 알림창
        function delete_item(ic_seq) {
            var html = '';
            html += '<div class="layer-pop-parent">';
            html += '    <div class="layer-pop-children">';
            html += '        <div class="pop-data alert-pop-data">';
            html += '            <div class="pop-body">';
            html += '                <div class="msg-txt">삭제하시겠습니까?</div>';
            html += '            </div>';
            html += '            <div class="pop-footer">';
            html += '                <button type="button" class="btn btn-confirm" onclick="delete_cart('+ic_seq+');">확인</button>';
            html += '                <button type="button" class="btn btn-confirm" onclick="pop.close();">취소</button>';
            html += '            </div>';
            html += '        </div>';
            html += '    </div>';
            html += '</div>';
            $("#cartDelPop").html(html);
            pop.open('cartDelPop');
        }

        // 장바구니에서 상품 삭제하기
        function delete_cart(ic_seq){
            $.ajax({
               url: 'data/item_ajax.php',
               data: {
                 mode: "set_delete_item_cart",
                 ic_seq: ic_seq,
                 user_id: "<?=$user_id?>",
                 delete_txt: "장바구니에서삭제"
               },
               type: 'POST',
               dataType: 'JSON',
               success: function (data) {
                   location.reload();
               },
               error: function(xhr, status, error) {
                    //alert(error + "네트워크에러");
                    if(xhr.status != 0){
                        alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                    }
               }
            });
        }

        // 정글북 상품 품절 확인
        function get_jbook_list2(menu, option, amount, ic_seq){
            console.log(menu, option);
            $.ajax({
                url: './data/jbook_item_ajax.php',
                data: {
                    mode : "get_item_list",
                    menu : menu,
                    option : option
                },
                type: 'POST',
                dataType: 'JSON',
                success: function(data) {
                    if(data.code == "000000"){
                        console.log("jbookdata");
                        console.log(data.data);
                        var result_txt = '0';
                        if(data.data && parseInt(data.data.total) > 0){
                            $.each(data.data.data, function(i, v){
                                result_txt = (v.runout == "1")? '품절' : v.goodsStock;
                                if(v.runout == "1"){
                                    is_jbook_runout = 1;
                                    $("#container .shop-cart-list-cell[data-seq='"+ic_seq+"']").addClass('soldout');
                                    // 품절

                                    $('#firstRequestMsg1').find('.msg-txt').text('품절된 상품이 있습니다.');
                                    pop.open("firstRequestMsg1");
                                }else{
                                    // orderItem.push({goodsNo: option, ea: amount}); // 정글북 데이터 입력
                                    // $("#item_order_sheet .order_data_wrap tr.out_product td .item[data-id='"+ic_seq+"']").attr('data-amount', result_txt);
                                }
                            });
                        }

                    }else{
                        alert(data.data+"("+data.code+")");
                        console.log(data.code);
                    }
                },
                error: function(xhr, status, error) {
                    //alert(error + "네트워크에러");
                    if(xhr.status != 0){
                        alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                    }
                }
            });
        }

/////////////////////////////// 주문내용 수정하기 //////////////////////////////////////////////////
        // 주문 내용 수정하기
        function modify_item(ic_seq){
            console.log(ic_seq);
            cart = [];
            $.ajax({
                url: 'data/item_ajax.php',
                data: {
                    mode: "get_modify_list",
                    ic_seq: ic_seq
                },
                type: 'POST',
                dataType: 'JSON',
                success: function (data) {
                    console.log(data);
                    var parse_cart_data = JSON.parse(data.data.cart_data);
                    var html = '';
                    html += '<div class="layer-pop-parent">';
                    html += '    <div class="layer-pop-children">';
                    html += '        <div class="pop-data alert-pop-data">';
                    html += '            <div class="pop-header">';
                    html += '                <h4 class="con-title">주문내역 수정</h4>';
                    html += '            </div>';
                    html += '            <div class="pop-body type-2">';
                    html += '                <div class="product-option-wrap">';
                    // 일반옵션 상품일때 상품 추가할 수 있도록(그룹옵션은 따로 선택해야 하기 때문에 제외)
                    if(data.data.is_use_option == '1') {
                        html += '                    <!-- 타이틀과 선택 있을 경우 안의 태그 노출 -->';
                        html += '                    <div class="product-option-title">옵션선택</div>';
                        html += '                    <div class="product-option-select">';
                        html += '                        <select id="item_option">';
                        // html += '                            <option value="">올리브</option>';
                        // html += '                            <option value="">올리브</option>';
                        // html += '                            <option value="">올리브</option>';
                        html += '                        </select>';
                        html += '                    </div>';
                        html += '                    <!-- //타이틀과 선택 있을 경우 안의 태그 노출 -->';
                    }
                    html += '                    <div class="product-option-list">';
                    $.each(parse_cart_data, function(i, v){
                        console.log(parse_cart_data);
                        html += '                       <div class="product-option-items" data-no="'+(i+1)+'">';
                        html += '                            <div class="product-option-items-name">'+v.txt+' '+(v.value).format()+'원</div>';
                        html += '                           <div class="product-option-amount">';
                        html += '                               <button type="button" class="btn-product-option-minus" onclick="cnt_change(\'m\','+(i+1)+')">감소</button>';
                        html += '                               <input type="number" value="'+v.amount+'" id="item_cnt_'+(i+1)+'" readonly/>';
                        html += '                               <button type="button" class="btn-product-option-plus" onclick="cnt_change(\'p\','+(i+1)+')">증가</button>';
                        html += '                           </div>';
                        if(parse_cart_data.length > 1) {
                            html += '                           <button type="button" onclick="delete_btn('+(i+1)+')" class="btn-product-option-del"><span class="icon icon-size-16 icon-close-small-gray"></span></button>';
                        }
                        html += '                        </div>';
                        cart.push({"seq" : v.seq, "value" : v.value, "amount" : v.amount, "is_free_shipping" : v.is_free_shipping, "txt" : v.txt, "il_seq" : v.il_seq, "is_supply" : v.is_supply, "supplier" : v.supplier, "goodsNo" : v.goodsNo});
                    });
                    html += '                    </div>';
                    html += '                </div>';
                    html += '                <div class="price-data-wrap">';
                    html += '                    <div class="price-data-group">';
                    html += '                        <div class="price-data-list">';
                    html += '                            <div class="price-data-list-cell total small">';
                    html += '                                <div class="price-data-list-title">총 합계</div>';
                    html += '                                <input type="hidden" id="total_price" value="'+data.data.cart_price+'">';
                    html += '                                <div class="price-data-list-value" id="result_price">'+(data.data.cart_price).format()+'원</div>';
                    html += '                            </div>';
                    html += '                        </div>';
                    html += '                    </div>';
                    html += '                </div>';
                    html += '                <div class="basic-data-group vmiddle">';
                    html += '                    <button type="button" onclick="update_cart('+ic_seq+');" class="btn btn-outline-purple btn-middle-size btn-round">주문내역 수정하기</button>';
                    html += '                </div>';
                    html += '            </div>';
                    html += '            <button type="button" class="btn-pop-close" onclick="pop.close();">닫기</button>';
                    html += '        </div>';
                    html += '    </div>';
                    html += '</div>';

                    $("#cartModifyPop").html(html);

                    // 옵션 상품 리스트 넣기
                    if(data.data.is_use_option == '1'){
                        $.ajax({
                            url: 'data/item_ajax.php',
                            data: {
                                mode: "get_item_option",
                                il_seq: data.data.il_seq
                            },
                            type: 'POST',
                            dataType: 'JSON',
                            success: function (data) {
                                if(data.code == "000000"){
                                    console.log(data.data);
                                    var html = '<option value="">선택</option>';
                                    $.each(data.data[0], function(i, v){
                                        var price_val = (v.is_soldout == "2")? "soldout" : v.sale_price;
                                        var price_txt = (v.is_soldout == "2")? "품절" : v.sale_price.format()+"원";
                                        var free_shippping_txt = (v.is_free_shipping == "1")? "[무료배송]" : "";

                                        html += '<option value="'+price_val+'" data-option_seq="'+v.io_seq+'" data-option_txt="'+v.option_name+'" data-free_shipping="'+v.is_free_shipping+'" data-is_supply="'+data.data.is_supply+'" data-supplier="'+data.data.supplier+'" data-goodsNo="'+data.data.goodsNo+'">'+free_shippping_txt+''+v.option_name+' '+price_txt+'</option>';
                                    });
                                    $("#item_option").html(html);
                                }else{
                                    alert(data.data+"("+data.code+")");
                                    console.log(data.code);
                                }
                            },
                            error: function(xhr, status, error) {
                                //alert(error + "네트워크에러");
                                if(xhr.status != 0){
                                    alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                                }
                            }
                        });
                    }
                    pop.open('cartModifyPop');
                },
                error: function(xhr, status, error) {
                    //alert(error + "네트워크에러");
                    if(xhr.status != 0){
                        alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                    }
                }
            });
        }

        // 일반옵션 선택시
        $(document).on("change", "#item_option", function(){
            var value = $(this).children("option:selected").val();
            var seq = $(this).children("option:selected").data("option_seq");
            var txt = $(this).children("option:selected").data("option_txt");
            var is_free_shipping = $(this).children("option:selected").data("free_shipping");
            var is_use_option = $(this).children("option:selected").data("is_use_option");
            var is_supply = $(this).children("option:selected").data("is_supply");
            var supplier = $(this).children("option:selected").data("supplier");
            var goodsNo = $(this).children("option:selected").data("goodsNo");
            var html = '';

            var keepgoing = "0"; // 중복선택 방지
            $.each(cart, function(i, v){
                if(seq == v.seq){
                    alert("이미 선택하신 옵션입니다.");
                    keepgoing = "1";
                }
            });

            if(value == "soldout" || value == ""){ // 품절 선택시
                alert("품절 상품입니다. 다른 상품을 선택해주세요.");
                $(this).val('');
            }else if(keepgoing == "1"){ // 중복 선택시
                $(this).val('');
            }else{

                cart.push({"seq" : seq, "value" : value, "amount" : 1, "is_free_shipping" : is_free_shipping, "txt" : txt, "il_seq" : "", "is_supply" : is_supply, "supplier" : supplier, "goodsNo" : goodsNo});
                console.log(cart);

                html += '<div class="product-option-items" data-no="'+cart.length+'">';
                html += '    <div class="product-option-items-name">'+txt+' '+value+'원</div>';
                html += '    <div class="product-option-amount">';
                html += '        <button type="button" class="btn-product-option-minus" onclick="cnt_change(\'m\','+cart.length+')">감소</button>';
                html += '        <input type="number" value="1" id="item_cnt_'+cart.length+'" readonly/>';
                html += '        <button type="button" class="btn-product-option-plus" onclick="cnt_change(\'p\','+cart.length+')">증가</button>';
                html += '    </div>';
                html += '    <button type="button" onclick="delete_btn('+cart.length+')" class="btn-product-option-del"><span class="icon icon-size-16 icon-close-small-gray"></span></button>';
                html += '</div>';

                $(".product-option-list").append(html);
                $(this).val('');

                $('#result_price').text((parseInt($("#total_price").val()) + parseInt(value)).format()+"원");
                $("#total_price").val(parseInt($("#total_price").val()) + parseInt(value));
            }

        });

        // 상품 개수 변경
        function cnt_change(type,data_no){

            var cart_no = parseInt(data_no);
            var amount = parseInt($("#item_cnt_"+data_no).val());

            if(type == 'm'){ // 감소
                amount -= 1;
                if(amount <= 0){
                    amount = 1;
                }
            } else { // 증가
                amount += 1;
                if(amount > 99){
                    amount = 99;
                }
            }
            $("#item_cnt_"+data_no).val(amount);
            console.log(amount);
            cart[cart_no - 1].amount = amount;

            var total_price = 0;
            $.each(cart, function(i, v){
                total_price += parseInt(v.value * v.amount);
            });

            $('#result_price').text(total_price.format()+"원");
            $("#total_price").val(parseInt(total_price));
        }

        // 주무내용 수정에서 상품 삭제
        function delete_btn(no){
            console.log("click");
            var cart_no = no;
            var html = '';
            $.each(cart, function(i, v){
                if(i == (cart_no - 1)){
                    cart.splice(i, 1);
                }
            });
            console.log(cart_no);
            console.log(cart);

            var total_price = 0;

            $.each(cart, function(i, v){
                html += '<div class="product-option-items" data-no="'+(i+1)+'">';
                html += '    <div class="product-option-items-name">'+v.txt+' '+v.value+'원</div>';
                html += '    <div class="product-option-amount">';
                html += '        <button type="button" class="btn-product-option-minus" onclick="cnt_change(\'m\','+(i+1)+')">감소</button>';
                html += '        <input type="number" value="'+v.amount+'" id="item_cnt_'+(i+1)+'" readonly/>';
                html += '        <button type="button" class="btn-product-option-plus" onclick="cnt_change(\'p\','+(i+1)+')">증가</button>';
                html += '    </div>';
                html += '    <button type="button" onclick="delete_btn('+(i+1)+')" class="btn-product-option-del"><span class="icon icon-size-16 icon-close-small-gray"></span></button>';
                html += '</div>';

                total_price += parseInt(v.value * v.amount);
            });
            $(".product-option-list").html(html);

            $('#result_price').text(total_price.format()+"원");
            $("#total_price").val(parseInt(total_price));
        }

        // 수정한 상품 적용
        function update_cart(ic_seq){
            var total_price = $("#total_price").val();
            $.ajax({
                url: './data/item_ajax.php',
                data: {
                    mode : "set_update_cart",
                    customer_id : customer_id,
                    ic_seq : ic_seq,
                    cart_price : total_price,
                    cart_data : JSON.stringify(cart)
                },
                type: 'POST',
                dataType: 'JSON',
                success: function(data) {
                    if(data.code == "000000"){
                        console.log(data.data);
                        location.reload();
                    }else{
                        alert(data.data+"("+data.code+")");
                        console.log(data.data);
                    }
                },
                error: function(xhr, status, error) {
                    //alert(error + "네트워크에러");
                    if(xhr.status != 0){
                        alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                    }
                }
            });
        }

/////////////////////////////// 주문내용 수정하기 끝//////////////////////////////////////////////////
        // 모든 상품 선택하기
        $item_cart.on("click", "input[name='allchk']", function(){
            if($(this).is(":checked") == true){
                // 배열 초기화
                var flag = 0;
                is_free_shipping_limit = ["", 100000, 30000, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송 시작 금액
                is_free_shipping_total = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송인 상품
                is_free_shipping_cnt = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 상품 개수
                is_free_shipping_price = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기  ==> 최종 구매가격
                is_free_shipping_do = ["", 1, 1, 0] // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송정책 사용여부 0:미사용, 1:사용

                // 상품 배열 초기화
                $.ajax({
                    url: 'data/item_ajax.php',
                    data: {
                        mode: "get_partner_list"
                    },
                    type: 'POST',
                    dataType: 'JSON',
                    success: function(data) {
                        if(data.code == "000000"){
                            $.each(data.data[0], function(i, v){

                                is_free_shipping_limit.push(parseInt(v.free_shipping_price)); // 무료배송 시작 금액
                                is_free_shipping_total.push(0); // 무료배송인 상품 개수
                                is_free_shipping_cnt.push(0) // 총 상품 개수
                                is_free_shipping_price.push(0) // 최종 구매 가격
                                is_free_shipping_do.push(parseInt(v.is_free_shipping)); // 무배정책 사용 여부 0: 미사용 1: 가격으로 사용 2: 개수로 사용(우선 가격만 적용)
                            });
                            // 배열 초기화 후 선택된 것들에 대한 값 다시 담기
                            $item_cart.find("input[name='chk[]']").each(function(i, v){
                                $(this).prop("checked", true);
                                var price = parseInt($(this).parents('.shop-cart-header').siblings('.shop-cart-body').find('.item-price').data('price')); // 상품 가격
                                var seq = parseInt($(this).parents('.shop-cart-header').siblings('.shop-cart-body').find('.item-price').data('num')); // 업체 번호
                                var free = parseInt($(this).parents('.shop-cart-header').siblings('.shop-cart-body').find('.item-price').data('free')); // 무료배송상품인지 확인 1:무료, 0:유료
                                console.log(price, seq, free);
                                is_free_shipping_price[seq] += price;
                                is_free_shipping_cnt[seq]++;
                                is_free_shipping_total[seq] += free;
                            });
                            console.log(is_free_shipping_price);
                            price_calculator();

                            if(flag == 0){
                                $item_cart.find("input[name='allchk']").prop("checked", true);
                            }else{
                                $item_cart.find("input[name='allchk']").prop("checked", false);
                            }

                        }else{
                            alert(data.data+"("+data.code+")");
                            console.log(data.code);
                        }
                    },
                    error: function(xhr, status, error) {
                        //alert(error + "네트워크에러");
                        if(xhr.status != 0){
                            alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                        }
                    }
                });

            }else{
                // 배열 초기화
                var flag = 0;
                is_free_shipping_limit = ["", 100000, 3000000, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송 시작 금액
                is_free_shipping_total = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송인 상품
                is_free_shipping_cnt = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 상품 개수
                is_free_shipping_price = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기  ==> 최종 구매가격
                is_free_shipping_do = ["", 1, 1, 0] // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송정책 사용여부 0:미사용, 1:사용

                // 상품 배열 초기화
                $.ajax({
                    url: 'data/item_ajax.php',
                    data: {
                        mode: "get_partner_list"
                    },
                    type: 'POST',
                    dataType: 'JSON',
                    success: function(data) {
                        if(data.code == "000000"){
                            $.each(data.data[0], function(i, v){

                                is_free_shipping_limit.push(parseInt(v.free_shipping_price)); // 무료배송 시작 금액
                                is_free_shipping_total.push(0); // 무료배송인 상품 개수
                                is_free_shipping_cnt.push(0) // 총 상품 개수
                                is_free_shipping_price.push(0) // 최종 구매 가격
                                is_free_shipping_do.push(parseInt(v.is_free_shipping)); // 무배정책 사용 여부 0: 미사용 1: 가격으로 사용 2: 개수로 사용(우선 가격만 적용)
                            });
                            // 선택값 false
                            $item_cart.find("input[name='chk[]']").each(function(i, v){
                                $(this).prop("checked", false);
                            });
                            price_calculator();

                        }else{
                            alert(data.data+"("+data.code+")");
                            console.log(data.code);
                        }
                    },
                    error: function(xhr, status, error) {
                        //alert(error + "네트워크에러");
                        if(xhr.status != 0){
                            alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                        }
                    }
                });
            }
        });

        // 상품 선택하기
        $item_cart.on("click", "input[name='chk[]']", function(){
            // 배열 초기화
            var flag = 0;
            is_free_shipping_limit = ["", 100000, 3000000, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송 시작 금액
            is_free_shipping_total = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송인 상품
            is_free_shipping_cnt = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기 ==> 상품 개수
            is_free_shipping_price = ["", 0, 0, 0]; // '', 업체배송, 직배송, 건너뛰기  ==> 최종 구매가격
            is_free_shipping_do = ["", 1, 1, 0] // '', 업체배송, 직배송, 건너뛰기 ==> 무료배송정책 사용여부 0:미사용, 1:사용

            // 상품 배열 초기화
            $.ajax({
                url: 'data/item_ajax.php',
                data: {
                    mode: "get_partner_list"
                },
                type: 'POST',
                dataType: 'JSON',
                success: function(data) {
                    if(data.code == "000000"){
                        $.each(data.data[0], function(i, v){

                            is_free_shipping_limit.push(parseInt(v.free_shipping_price)); // 무료배송 시작 금액
                            is_free_shipping_total.push(0); // 무료배송인 상품 개수
                            is_free_shipping_cnt.push(0) // 총 상품 개수
                            is_free_shipping_price.push(0) // 최종 구매 가격
                            is_free_shipping_do.push(parseInt(v.is_free_shipping)); // 무배정책 사용 여부 0: 미사용 1: 가격으로 사용 2: 개수로 사용(우선 가격만 적용)
                        });
                        // 배열 초기화 후 선택된 것들에 대한 값 다시 담기
                        $item_cart.find("input[name='chk[]']").each(function(i, v){
                            if($(this).is(":checked") == false){
                                flag = 1;
                            }else{
                                var price = parseInt($(this).parents('.shop-cart-header').siblings('.shop-cart-body').find('.item-price').data('price')); // 상품 가격
                                var seq = parseInt($(this).parents('.shop-cart-header').siblings('.shop-cart-body').find('.item-price').data('num')); // 업체 번호
                                var free = parseInt($(this).parents('.shop-cart-header').siblings('.shop-cart-body').find('.item-price').data('free')); // 무료배송상품인지 확인 1:무료, 0:유료
                                console.log(price, seq, free);
                                is_free_shipping_price[seq] += price;
                                is_free_shipping_cnt[seq]++;
                                is_free_shipping_total[seq] += free;

                            }
                        });
                        console.log(is_free_shipping_price);
                        price_calculator();

                        if(flag == 0){
                            $item_cart.find("input[name='allchk']").prop("checked", true);
                        }else{
                            $item_cart.find("input[name='allchk']").prop("checked", false);
                        }

                    }else{
                        alert(data.data+"("+data.code+")");
                        console.log(data.code);
                    }
                },
                error: function(xhr, status, error) {
                    //alert(error + "네트워크에러");
                    if(xhr.status != 0){
                        alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                    }
                }
            });

        });

        // 따닥 방지
        var double_chk = true;
        // 결제하기
        function set_item_payment(){
            if(chk_mobile == 'mobile'){
                if(double_chk == true){
                    double_chk = false;
                    // 선택한 상품들에게 같은 결제번호 부여(update) 후 결제페이지로 이동
                    var cart_list = [];
                    var cnt = 0;
                    $item_cart.find("input[name='chk[]']").each(function(i, v){
                        if($(this).is(":checked") == true && $(this).val() != ""){
                            cart_list.push($(this).val());
                        }
                    });
                    console.log(cart_list);
                    if(cart_list.length > 0){
                        $.each(cart_list, function(i, v){
                            $.ajax({
                                url: 'data/item_ajax.php',
                                data: {
                                    mode: "set_update_cart",
                                    customer_id: customer_id,
                                    ic_seq: v,
                                    order_num: new_order_num
                                },
                                type: 'POST',
                                dataType: 'JSON',
                                success: function(data) {
                                    if(data.code == "000000"){
                                        console.log(data.data);
                                        // 쿠키값 변경??, IOS 예외처리??
                                        //setCookie("order_num", data.data, 1);
                                        //setCookie("order_step", "1", 1); // 1 - 구매, 2 - 조회
                                        cnt++;

                                        if(cnt == cart_list.length){
                                            if(customer_id != ""){
                                                location.href = "shop_pay_input?no="+new_order_num;
                                            }else{
                                                location.href = "login_1?no="+new_order_num;
                                            }
                                        }
                                    }else{
                                        alert(data.data+"("+data.code+")");
                                        console.log(data.data);
                                    }
                                },
                                error: function(xhr, status, error) {
                                    //alert(error + "네트워크에러");
                                    if(xhr.status != 0){
                                        alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                                    }
                                }
                            });
                        });
                    }
                }
            }else{
                popalert.open('firstRequestMsg1','모바일에서 주문가능합니다.');
                double_chk = true;
            }

        }

        // 세자리 숫자 콤마
        Number.prototype.format = function() {
            if (this == 0) return 0;

            var reg = /(^[+-]?\d+)(\d{3})/;
            var n = (this + '');

            while (reg.test(n)) n = n.replace(reg, '$1' + ',' + '$2');

            return n;
        };

        // 문자열 타입에서 쓸 수 있도록 format() 함수 추가
        String.prototype.format = function() {
            var num = parseFloat(this);
            if (isNaN(num)) return "0";

            return num.format();
        };
    </script>

<?
//include($_SERVER['DOCUMENT_ROOT']."/include/skin/footer.php");
?>
