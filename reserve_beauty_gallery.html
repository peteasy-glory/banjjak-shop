<?php
include($_SERVER['DOCUMENT_ROOT']."/include/global.php");

$artist_flag = (isset($_SESSION['artist_flag'])) ? $_SESSION['artist_flag'] : "";

if ($artist_flag === true) {
    $artist_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_name = (isset($_SESSION['shop_user_nickname'])) ? $_SESSION['shop_user_nickname'] : "";
} else {
    $artist_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_name = (isset($_SESSION['gobeauty_user_nickname'])) ? $_SESSION['gobeauty_user_nickname'] : "";
}

$yy = (isset($_REQUEST['yy']) && $_REQUEST['yy']) ? $_REQUEST['yy'] : date('Y');
$mm = (isset($_REQUEST['mm']) && $_REQUEST['mm']) ? $_REQUEST['mm'] : date('m');
$dd = (isset($_REQUEST['dd']) && $_REQUEST['dd']) ? $_REQUEST['dd'] : date('d');



$shop_title	= "미용 갤러리";
$header_right	= '
	
';
include($_SERVER['DOCUMENT_ROOT']."/include/skin/header_shop.php");
include($_SERVER['DOCUMENT_ROOT']."/include/check_login_shop.php");

$app = new App();
$is_app = $app->is_app();


$user_id = ($_SESSION['artist_flag'] === true) ? $_SESSION['shop_user_id'] : $_SESSION['gobeauty_user_id'];
$customer_user_id = $user_id;	// 사진 변경용 정회원번호
$customer_tmp_seq = "";			// 사진 변경용 가회원번호

$que = "SELECT * FROM tb_shop WHERE customer_id = '{$user_id}'";
$ts = sql_fetch_array($que);
?>
<style>

</style>
<!-- container -->
<section id="container">
	<!-- page-body -->
	<div class="page-body">
		<div class="reserve-beauty-gallery">
			<div class="shop-gate-picture-select">
				<div class="list-inner">
					<div class="list-cell"><a href="javascript:;" onclick="file_view();" class="btn-gate-picture-register"><span><em>이미지 추가</em></span></a></div>
                    <?php
                        $que = "SELECT * FROM tb_mypet_beauty_photo WHERE pet_seq = '{$_GET['pet']}'";
                        //echo $que;
                        $arr = sql_fetch_array($que);
                        if(count($arr)>0){
                            foreach($arr as $rs){
                    ?>
					<div class="list-cell">
						<div class="picture-thumb-view">
							<div class="picture-obj"><img src="<?php echo 'https://image.banjjakpet.com'.img_link_change($rs['file_path']);?>" alt=""></div>
							<div class="picture-date"><?php echo date('Y.m.d',strtotime($rs['upload_dt']));?></div>
                            <?php
                                if($is_app > 0) {
                                    echo '<div class="picture-share" ><button type = "button" class="share-button" onclick = "SET_SNSShare(\''.$ts[0]['name'].'\', \''.$rs['file_path'].'\')" ><span class="icon icon-share-white-gallery" ></span ></button ></div >';
                                }
                                ?>
                            <div class="picture-ui-eaden">
                                <button type="button" class="btn-picture-ui"></button>
                            </div>
                            <div class="picture-ui-list">
                                <div class="picture-ui-list-inner">
                                    <a href="javascript:deleteImage(<?=$rs['idx']?>, '<?=$rs['file_path']?>');" class="btn-picture-ui-nav">삭제</a>
                                </div>
                            </div>
						</div>
					</div>
                    <?php }} ?>
				</div>
			</div>
			<div class="picture-add-info">이미지는 최대 25개까지 등록할 수 있습니다.<br>gif, png, jpg, jpeg 형식의 절차 이미지만 등록됩니다.</div>
		</div>
	</div>
	<!-- //page-body -->

        <input type="file" name="imgupfile"            id="addimgfile"     value="" style="display:none">


</section>
<!-- //container -->

<script>
    function deleteImage(idx, path) {
        var formData = new FormData();
        formData.append("idx", String(idx));
        formData.append("path", path);
        $.ajax({
            url: 'data/delete_gallery_image.php',
            data: formData,
            type: 'POST',
            processData: false,
            contentType: false,
            success: function(data) {
                location.reload();
            },
            error: function(xhr, status, error) {
                popalert.open('firstRequestMsg1', '적용실패');
            }
        });
    }
</script>

<script>
    var _payment_log_seq = "<?=$_GET['seq']?>";	//
    var _artist_id = "<?=$user_id?>";	//
    var _pet_seq = "<?=$_GET['pet']?>";
    ////////////////
    // android
    function galleryup() {
        window.Android.openGallery();
    }

    function cameraup() {
        window.Android.openCamera();
    }

    //안드에서 업로드가 끝나면 무조건 호출..
    function uploadEnd(fileName) {
        var newfilename = GetPhotoFilename('pet_gallery', '<?= ($customer_user_id != null && $customer_user_id != "") ? $customer_user_id : "tmp_$customer_tmp_seq" ?>', fileName);
        var formData = new FormData();
        formData.append("myfile", fileName);
        formData.append("filepath", newfilename);
        formData.append("pet_seq", _pet_seq);
        formData.append("payment_log_seq", _payment_log_seq);
        formData.append("artist_id", _artist_id);
        $.ajax({
            url: './data/upload_user_photo_pet_gallery.php',	// 미용사진 갤러리 전용 업로드
            data: formData,
            processData: false,
            contentType: false,
            cache: false,
            type: 'POST',
            success: function(data) {

                if(data != "Fail") { // 성공
                    location.reload();

                } else {
                    alert('미용사진 업로드에 실패하였습니다.');
                    //rv = false;
                }

            },
            error: function(xhr, status, error) {
                alert(error + "네트워크에러");
                if(xhr.status != 0){
                    alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
                }
            }
        });
    }
    ////////////////

    // 펫 갤러리 추가
    function MemofocusNcursor() {
        //pet_seq = seq;

        html = "<div id='upimgarea'></div>";
        var sel, range;
        if (window.getSelection) {
            sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                range = sel.getRangeAt(0);
                range.deleteContents();

                var el = document.createElement("div");
                el.innerHTML = html;
                var frag = document.createDocumentFragment(),
                    node, lastNode;
                while ((node = el.firstChild)) {
                    lastNode = frag.appendChild(node);
                }
                range.insertNode(frag);

                if (lastNode) {
                    range = range.cloneRange();
                    range.setStartAfter(lastNode);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
        } else if (document.selection && document.selection.type != "Control") {
            // IE < 9
            document.selection.createRange().pasteHTML(html);
        }
        $("#addimgfile").trigger("click");	//
    }



    function file_view(){
        var is_android = checkMobile();
        if(is_android == true){
            galleryup();
        } else {
            $("#addimgfile").click();

        }
    }


    function checkMobile(){

        var varUA = navigator.userAgent.toLowerCase(); //userAgent 값 얻기

        if ( varUA.indexOf('android') > -1) {
            //안드로이드
            return true;
        } else if ( varUA.indexOf("iphone") > -1||varUA.indexOf("ipad") > -1||varUA.indexOf("ipod") > -1 ) {
            //IOS
            return 'ios';
        } else {
            //아이폰, 안드로이드 외
            return 'other';
        }

    }

    $(document).on("change", "#addimgfile", function(e){
//$('#addimgfile').bind('change', function(e) {

        console.log('start')
        $(".pet-img div.normal").hide();
        var ext = $('#addimgfile').val().split('.').pop().toLowerCase();

        if ($.inArray(ext, ['gif', 'png', 'jpg', 'jpeg']) == -1) {
            alert('gif,png,jpg,jpeg 파일만 업로드 할수 있습니다.');
            $(".pet-img div.normal").show();
            return;
        }

        // 용량 체크
        if( $("input[name=imgupfile]")[0].files[0].size > 10000000) { // 20mb 제한
            alert('이미지는 최대 10mb까지 허용 중입니다.');
            return;
        }

        var filename = $("input[name=imgupfile]")[0].files[0].name;
        var newfilename = GetPhotoFilename('pet_gallery', '<?= ($customer_user_id != null && $customer_user_id != "") ? $customer_user_id : "tmp_$customer_tmp_seq" ?>', filename);

        console.log(newfilename)
        //
        //var _prnt_titl = $.trim( $("#dialog_pet_gallery_form #pet_data_form .prnt_title").val() );
        //
        var formData = new FormData();
        formData.append("myfile", $("input[name=imgupfile]")[0].files[0]);
        formData.append("filepath", newfilename);
        formData.append("pet_seq", _pet_seq);
        formData.append("payment_log_seq", _payment_log_seq);
        formData.append("artist_id", _artist_id);
        //formData.append("prnt_title", _prnt_titl);
        console.log($("input[name=imgupfile]")[0].files[0])
        $.ajax({
            url: '/data/upload_user_photo_pet_gallery.php',	// 미용사진 갤러리 전용 업로드
            data: formData,
            processData: false,
            contentType: false,
            cache: false,
            type: 'POST',
            success: function(data) {


                if(data != "Fail") { // 성공
                    location.reload();

                } else {
                    alert('미용사진 업로드에 실패하였습니다.');
                    //rv = false;
                }

            },
            error: function(xhr, status, error) {
                 alert(error+"에러발생");
                //rv = false;
            }
        });


        //return rv;
    });

    function SET_SNSShare(shopName, imgPath){
        var is_android = checkMobile();
        alert(is_android+':'+shopName+':'+imgPath)
        if(is_android == true){
            Banjjak_Android.SET_SNSShare(shopName, imgPath);
        } else if(is_android == 'ios'){
            let messages = {
                'shop_name': shopName,
                'img_path': imgPath
            };

            webkit.messageHandlers.SET_SNSShare.postMessage(message);
        } else {

        }
    }

    $(document).ready(function(){
        $('#header_bell').css('display','none');
        $('#btn_page_prev').attr('href','<?php echo $_SESSION['backurl2'];?>');
    });
</script>
</body>
</html>