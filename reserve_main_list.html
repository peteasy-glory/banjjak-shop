<?
include($_SERVER['DOCUMENT_ROOT']."/include/global.php");

$artist_flag = (isset($_SESSION['artist_flag'])) ? $_SESSION['artist_flag'] : "";

if ($artist_flag === true) {
    $artist_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_id = (isset($_SESSION['shop_user_id'])) ? $_SESSION['shop_user_id'] : "";
    $user_name = (isset($_SESSION['shop_user_nickname'])) ? $_SESSION['shop_user_nickname'] : "";
} else {
    $artist_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_id = (isset($_SESSION['gobeauty_user_id'])) ? $_SESSION['gobeauty_user_id'] : "";
    $user_name = (isset($_SESSION['gobeauty_user_nickname'])) ? $_SESSION['gobeauty_user_nickname'] : "";
}

$yy = (isset($_GET['yy']) && $_GET['yy']) ? $_GET['yy'] : date('Y');
$mm = (isset($_GET['mm']) && $_GET['mm']) ? $_GET['mm'] : date('m');
$dd = (isset($_GET['dd']) && $_GET['dd']) ? $_GET['dd'] : date('d');

$header_right ='';
$header_notice = true;


$shop_title	= "예약관리";

include($_SERVER['DOCUMENT_ROOT']."/include/skin/header_shop.php");
include($_SERVER['DOCUMENT_ROOT']."/include/check_login_shop.php");



?>

<?

$from = $_GET['from'];

$sql = array();
$data = array();
$wait_count = 0;

$ch = (isset($_GET['ch']) && $_GET['ch']) ? $_GET['ch'] : 'month';
$yy = (isset($_GET['yy']) && $_GET['yy']) ? $_GET['yy'] : date('Y');
$mm = (isset($_GET['mm']) && $_GET['mm']) ? $_GET['mm'] : date('m');
$dd = (isset($_GET['dd']) && $_GET['dd']) ? $_GET['dd'] : date('d');
$week = $_GET['week'];



$backurl = $_GET['backurl'];

unset($_SESSION['backurl1']);
$_SESSION['backurl1'] = 'reserve_main_list?ch=day&yy='.$_GET['yy'].'&mm='.$_GET['mm'].'&&dd='.$_GET['dd'];
unset($_SESSION['backurl_notice']);
$_SESSION['backurl_notice'] = 'reserve_main_list?ch=day&yy='.$_GET['yy'].'&mm='.$_GET['mm'].'&&dd='.$_GET['dd'];



$daily = array('일', '월', '화', '수', '목', '금', '토');
$selected_date = $yy . "-" . $mm . "-" . $dd;

$y_yy = date("Y", strtotime($selected_date . "-1day"));
$y_mm = date("m", strtotime($selected_date . "-1day"));
$y_dd = date("d", strtotime($selected_date . "-1day"));
$t_yy = date("Y", strtotime($selected_date . "+1day"));
$t_mm = date("m", strtotime($selected_date . "+1day"));
$t_dd = date("d", strtotime($selected_date . "+1day"));

// 오늘 날짜
$today_year = date("Y");
$today_month = date("m");
$today_day = date("d");

// var_dump($_SESSION);

$shop_sql = "select * from tb_shop where customer_id = '" . $user_id . "'";
$shop_result = mysqli_query($connection, $shop_sql);
if ($shop_datas = mysqli_fetch_object($shop_result)) {
    $front_image = $shop_datas->front_image;
    $name = $shop_datas->name;
    $working_years = $shop_datas->working_years;
    $self_introduction = $shop_datas->self_introduction;
    $professional_field = $shop_datas->professional_field;
    $career = $shop_datas->career;
    $license_indexs = $shop_datas->license_indexs;
    $region_and_cost = $shop_datas->region_and_cost;
    $enable_flag = $shop_datas->enable_flag;
    $update_time = $shop_datas->update_time;

    //----- 상담 대기 건수 조회
    $pet_sql =
        "SELECT count(tpl.payment_log_seq) AS wait_count
            FROM tb_payment_log tpl, tb_mypet tm, tb_customer tc
            WHERE tpl.approval = 0
            AND tpl.pet_seq = tm.pet_seq 
            AND tpl.customer_id = tc.id
			AND tc.enable_flag = 1
            AND timestampdiff(minute, update_time, now()) < 720
            AND tpl.artist_id = '{$user_id}'";
    $pet_result = mysqli_query($connection, $pet_sql);
    // error_log('----- $pet_sql : ' . $pet_sql);
    if ($pet_result_rows = mysqli_fetch_object($pet_result)) {
        $wait_count = $pet_result_rows->wait_count;
    }

    //크기 데이터,  상품 데이터
    $dog_static_query = "SELECT *, second_type AS product_type FROM tb_product_dog_static WHERE customer_id = '{$user_id}'";
    $dog_static_result = mysqli_query($connection, $dog_static_query);
    $dog_static_list = array();
	$dog_static_list2 = array(); // worktime
    $dog_service_list = array();
    while ($dog_static_data = mysqli_fetch_object($dog_static_result)) {
        $product_type = $dog_static_data->product_type;
        $dog_static_list[] = $product_type;

        $sanitation = $dog_static_data->sanitation_price;
        $bath = $dog_static_data->bath_price;
        $part = $dog_static_data->part_price;
        $bath_part = $dog_static_data->bath_part_price;
        $all = $dog_static_data->all_price;
        $spoting = $dog_static_data->spoting_price;
        $summercut = $dog_static_data->summercut_price;
        $scissors = $dog_static_data->scissors_price;

        if ($bath != null && $bath != "") {
            $dog_service_list[$product_type]["목욕"] = "목욕";
			$dog_static_list2[1] = "목욕";
        }

        if ($part != null && $part != "") {
            $dog_service_list[$product_type]["부분미용"] = "부분미용";
			$dog_static_list2[2] = "부분미용";
        }

        if ($bath_part != null && $bath_part != "") {
            $dog_service_list[$product_type]["부분+목욕"] = "부분+목욕";
			$dog_static_list2[3] = "부분+목욕";
        }

        if ($all != null && $all != "") {
            $dog_service_list[$product_type]["전체미용"] = "전체미용";
			$dog_static_list2[4] = "전체미용";
        }

        if ($spoting != null && $spoting != "") {
            $dog_service_list[$product_type]["스포팅"] = "스포팅";
			$dog_static_list2[5] = "스포팅";
        }

        if ($scissors != null && $scissors != "") {
            $dog_service_list[$product_type]["가위컷"] = "가위컷";
			$dog_static_list2[6] = "가위컷";
        }

		if ($sanitation != null && $sanitation != "") {
            $dog_service_list[$product_type]["위생"] = "위생";
			$dog_static_list2[7] = "위생";
        }

        if ($summercut != null && $summercut != "") {
            $dog_service_list[$product_type]["썸머컷"] = "썸머컷";
			$dog_static_list2[8] = "썸머컷";
        }

        // if (($sanitation != null && $sanitation != "") && ($summercut != null && $summercut != "")) {
        //     $dog_service_list[$product_type] = ["위생" => "위생", "목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "썸머컷" => "썸머컷", "가위컷" => "가위컷"];
        // } else if (($sanitation != null && $sanitation != "") && ($summercut == null || $summercut == "")) {
        //     $dog_service_list[$product_type] = ["위생" => "위생", "목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "가위컷" => "가위컷"];
        // } else if (($sanitation == null || $sanitation == "") && ($summercut != null && $summercut != "")) {
        //     $dog_service_list[$product_type] = ["목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "썸머컷" => "썸머컷", "가위컷" => "가위컷"];
        // } else {
        //     $dog_service_list[$product_type] = ["목욕" => "목욕", "부분미용" => "부분미용", "부분+목욕" => "부분+목욕", "전체미용" => "전체미용", "스포팅" => "스포팅", "가위컷" => "가위컷"];
        // }
    }

	$dog_worktime_query = "SELECT * FROM tb_product_dog_worktime WHERE artist_id = '".$user_id."' AND is_delete = '2' ";
	$dog_worktime_result = mysqli_query($connection, $dog_worktime_query);
	$dog_worktime_cnt = mysqli_num_rows($dog_worktime_result);
	$dog_worktime_list = array(); 
	$dog_worktime_txt = array("dog","목욕","부분미용","부분+목욕","전체미용","스포팅","가위컷","위생","썸머컷");
	// 순서대로 목욕,부분미용,부분+목욕,전체미용,스포팅,가위컷,위생,썸머컷
	if($dog_worktime_cnt > 0){
		while($dog_worktime_data = mysqli_fetch_assoc($dog_worktime_result)){
			for($_i = 1; $_i <= 8; $_i++){
				foreach($dog_static_list2 AS $key => $value){
					if($dog_worktime_txt[$_i] == $value){
						$dog_worktime_list[$value] = $dog_worktime_data["worktime".$_i];
					}
				}
			}
		}
	}else{
		$dog_worktime_list = array(
			"dog" => "dog",
			"목욕" => "120",
			"부분미용" => "120",
			"부분+목욕" => "120",
			"전체미용" => "120",
			"스포팅" => "120",
			"가위컷" => "120",
			"위생" => "120",
			"썸머컷" => "120"
		);
	}
	//print_r($dog_worktime_list);
    

    $cat_static_query = "SELECT * FROM tb_product_cat WHERE customer_id = '{$user_id}'";
    $cat_static_result = mysqli_query($connection, $cat_static_query);
    $cat_static_list = array();
    while ($cat_static_data = mysqli_fetch_object($cat_static_result)) {
        $cat_static_list[] = $cat_static_data->second_type;
        $cat_product = $cat_static_data;
    }

    //기타 상품 데이터
    $dog_etc_list = array();
    $dog_etc_query = "SELECT * FROM tb_product_dog_etc WHERE customer_id = '{$user_id}'";
    $dog_etc_result = mysqli_query($connection, $dog_etc_query);
    while ($dog_etc = mysqli_fetch_object($dog_etc_result)) {
        $dog_etc_list[] = $dog_etc;
    }

    $cat_etc_list = array();
    $cat_etc_query = "SELECT * FROM tb_product_cat_etc WHERE customer_id = '{$user_id}'";
    $cat_etc_result = mysqli_query($connection, $cat_etc_query);
    while ($cat_etc = mysqli_fetch_object($cat_etc_result)) {
        $cat_etc_list[] = $cat_etc;
    }

    //쿠폰 상품 데이터
    $coupon_list = array();
    $coupon_query = "SELECT * FROM tb_coupon WHERE customer_id = '{$user_id}' AND del_yn = 'N' ORDER BY reg_date";
    $coupon_result = mysqli_query($connection, $coupon_query);
    while ($coupon_data = mysqli_fetch_object($coupon_result)) {
        $coupon_list[] = $coupon_data;
    }
}
?>






<?php
/*
	
*/
$data = array();
$_SESSION['bjj_stop_direct_flag'] = "1";
$block_height = 40; // 블럭 높이
// 예약중건 추출
$data['reservation'] = array();
$sql['reservation'] = "SELECT
    res.* ,
    DATE_FORMAT( CONCAT( res.year,'-',res.month,'-',res.day,' ',res.hour,':',IFNULL(res.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_start
FROM
    `tb_reservation` res
WHERE
    DATE_FORMAT( CONCAT( res.year,'-',res.month,'-',res.day ), '%Y-%m-%d' ) = DATE_FORMAT( '{$yy}-{$mm}-{$dd}' , '%Y-%m-%d' )
    AND res.update_time > DATE_ADD(now(), INTERVAL -10 MINUTE )
";

$result = mysqli_query($connection, $sql['reservation']);
while ($rows = mysqli_fetch_assoc($result)) {
    if ($worker = $rows['worker']) {
        $date =  $rows['year'] . '-' . $rows['month'] . '-' . $rows['day'] . ' ' . $rows['hour'] . ":" . $rows['minute'] . ":00";
        // echo '<Br/>';
        $now = date_create($date);
        $time = date_format($now, "H:i");

        $data['reservation'][$worker][$time]['data'] = $reservation[$worker][$time]['data'] = $rows; // 예약중인 건에 대한 정보

        $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($rows['res_time_start']))));
        $time_end =  $time_start + (int) ($rows['rowspan'] * (60 * 30));
        $time_full = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);

        $time_block_cnt = $time_full / (60 * 30); // 블럭갯수

        $rowspan['reservation'][$worker][$time] = $time_block_cnt;

        for ($h = $time_start; $h < $time_end; $h += (60 * 30)) {
            $rowspan['reservation'][$worker][$time]['time'][] = $thisTime;
            $data['reservation'][$worker][$time]['time'][] = $reservation[$worker][$time]['time'][] = date('H:i', $h); // 각 시간대 저장
        }
    }
}
// 결제완료건 추출
$data['payment'] = array();
$sql['payment'] = "SELECT
    pay.* ,
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_date ,
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.hour,':',IFNULL(pay.minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_start ,
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day,' ',pay.to_hour,':',IFNULL(pay.to_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) res_time_end
FROM
    `tb_payment_log` AS pay
WHERE
    DATE_FORMAT( CONCAT( pay.year,'-',pay.month,'-',pay.day ), '%Y-%m-%d' ) = DATE_FORMAT( '{$yy}-{$mm}-{$dd}' , '%Y-%m-%d' ) AND
    pay.artist_id = '{$artist_id}' AND
    pay.is_cancel = 0 AND
	pay.data_delete = '0'
";
//echo $sql['payment'];
$result = mysqli_query($connection, $sql['payment']);
while ($rows = mysqli_fetch_assoc($result)) {
    // echo '<pre>';
    // var_dump($rows->res_time_start);
    // var_dump($rows->res_time_end);
    // echo '</pre>';
    $worker = $rows['worker'];
    if ($worker) {
        $datetime1 = new DateTime($rows['res_time_start']);
        $datetime2 = new DateTime($rows['res_time_end']);
        $interval = $datetime2->diff($datetime1);
        // echo ( $interval->format('%h') * 60 ) / 30 ;
        // echo $rows['res_time_start'];
        $resTime = date('H:i', strtotime($rows['res_time_start']));
        // echo $resTime = date('H:i',strtotime($rows['res_time_start']));
        $rowspan_count = ($interval->format('%h') * 60) / 30;


        $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($rows['res_time_start']))));
        $time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($rows['res_time_end']))));
        $time = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);
        // echo '<br/>';
        $time_block_cnt = $time / (60 * 30); // 블럭갯수

        $rowspan['payment'][$worker][$resTime] = $time_block_cnt;
        $data['payment'][$worker][$resTime]['data'] = $rows;
        for ($t = 0; $t < $time_block_cnt; $t++) {
            $thisTime = date('H:i', strtotime($rows['res_time_start'] . ' +' . ($t * 30) . ' minute'));
            $data['payment'][$worker][$resTime]['time'][] = $thisTime;
        }
    }

    // $data['payment'][] = $payment;

}
// $payment_time = array_keys($payment);
// echo '<pre>';
// var_dump($payment);
// var_dump($payment_time);
// var_dump($rowspan);
// echo '</pre>';
// 결제완료건 추출


foreach ($data['payment'] as $key => $val) ksort($data['payment'][$key]);
foreach ($rowspan['payment'] as $key => $val) ksort($rowspan['payment'][$key]);

// 일일 오픈시간과 종료시간을 가지고 온다.
$sql['schedule'] = "select * from tb_working_schedule where customer_id='{$artist_id}'";
$result = mysqli_query($connection, $sql['schedule']);
$data['schedule'] = $schedule = $rows = mysqli_fetch_assoc($result);
$order_my = isset($order_my) ? $order_my : array();
ksort($order_my);
// echo '<pre>';
// var_dump($order_my);
// echo '</pre>';

// 미용사별 근무시간
$data['private_holiday'] = array();
$week_idx = date('w', strtotime($yy . '-' . $mm . '-' . $dd));
$sql['artist'] = " SELECT * FROM `tb_artist_list` WHERE artist_id='{$artist_id}' AND is_view = '2' GROUP BY name ORDER BY sequ_prnt asc, is_main DESC, nicname ASC";

/*
$sql['artist'] = "
	SELECT seq, artist_id, name, nicname, is_main, ".$week_idx." AS week,
		(SELECT time_start FROM tb_artist_list WHERE artist_id = a.artist_id AND nicname = a.nicname AND week = '".$week_idx."') AS time_start,
		(SELECT time_end FROM tb_artist_list WHERE artist_id = a.artist_id AND nicname = a.nicname AND week = '".$week_idx."') AS time_end
	FROM `tb_artist_list` AS a
	WHERE artist_id = '".$artist_id."' 
	GROUP BY name 
	ORDER BY is_main DESC
"; // 20200629 ulmo 해당 요일의 근무시간을 가져오도록 서브쿼리 변경처리 
*/
// error_log('----- $sql[artist] : '.$sql['artist']);
$result = mysqli_query($connection, $sql['artist']);
while ($artist_rows = mysqli_fetch_assoc($result)) {
    $data['artist'][] = $artist_rows;
}

// 법정 공휴일 쉬는 여부 true가 쉰다.
$is_rest_public_holiday = false;
$working_sql = "select * from tb_working_schedule where customer_id = '" . $user_id . "';";
$working_result = mysqli_query($connection, $working_sql);
if ($working_datas = mysqli_fetch_object($working_result)) {
    $is_rest_public_holiday = ($working_datas->rest_public_holiday == 1) ? true : false;
}

// 공휴일
$is_public_holiday = false;
$sql_public_holiday = "SELECT * FROM tb_public_holiday WHERE year = $yy AND month = $mm AND day = $dd";
$sql_public_holiday_result = mysqli_query($connection, $sql_public_holiday);
while ($sql_public_holiday_row = mysqli_fetch_object($sql_public_holiday_result)) {
    if ($sql_public_holiday_row->day == $dd) {
        $is_public_holiday = true;
    }
}

foreach ($data['artist'] as $key => $artist) {
	// 20200716 ulmo 해당 요일에 대한 업무시간 재조정 
	$sql = "
		SELECT * 
		FROM `tb_artist_list`
		WHERE artist_id = '".$artist["artist_id"]."' 
			AND NAME = '".$artist["name"]."'
			AND WEEK = '".$week_idx."'
			AND is_view = '2'
	";
	$result = mysqli_query($connection, $sql);
	$row = mysqli_fetch_array($result);
	$data['artist'][$key]["time_start"] = $row["time_start"];
	$data['artist'][$key]["time_end"] = $row["time_end"];

    // 임시휴일[START]
    // echo '<div style="color:red;">'.$artist['name'].'</div>';
    $sql_private_holiday = "SELECT * FROM(
        SELECT 
            pholiday.* ,
            DATE_FORMAT( CONCAT( pholiday.start_year,'-',pholiday.start_month,'-',pholiday.start_day,' ',pholiday.start_hour,':',IFNULL(pholiday.start_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) pri_start_date ,
            DATE_FORMAT( CONCAT( pholiday.end_year,'-',pholiday.end_month,'-',pholiday.end_day,' ',IF(pholiday.end_hour = 24 AND (pholiday.end_minute IS NULL OR pholiday.end_minute = 0), '23', pholiday.end_hour),':',IF(pholiday.end_hour = 24 AND pholiday.end_minute IS NULL, '59', IFNULL(pholiday.end_minute,'00')),':00' ), '%Y-%m-%d %H:%i' ) pri_end_date ,
            DATE_FORMAT( CONCAT( pholiday.start_year,'-',pholiday.start_month,'-',pholiday.start_day,' ',pholiday.start_hour,':',IFNULL(pholiday.start_minute,'00'),':00' ), '%Y-%m-%d %H:%i' ) pri_start_time ,
            DATE_FORMAT( CONCAT( pholiday.end_year,'-',pholiday.end_month,'-',pholiday.end_day,' ',IF(pholiday.end_hour = 24 AND (pholiday.end_minute IS NULL OR pholiday.end_minute = 0), '23', pholiday.end_hour),':',IF(pholiday.end_hour = 24 AND pholiday.end_minute IS NULL, '59', IFNULL(pholiday.end_minute,'00')),':00' ), '%Y-%m-%d %H:%i' ) pri_end_time
        FROM 
            tb_private_holiday pholiday 
    ) A
    WHERE 
        A.customer_id='{$artist_id}'
        AND A.worker='{$artist['name']}'
        AND DATE_FORMAT( '{$yy}-{$mm}-{$dd} 00:00' , '%Y-%m-%d %H:%i' ) <= A.pri_end_date AND A.pri_start_date <= DATE_FORMAT( '{$yy}-{$mm}-{$dd} 23:59' , '%Y-%m-%d %H:%i' )
    ORDER BY
        A.pri_start_date ASC
    ";
    $result_private_holiday = mysqli_query($connection, $sql_private_holiday);
    $private = array();
    while ($private_holiday_rows = mysqli_fetch_assoc($result_private_holiday)) {
		$tmp_start_hour = $private_holiday_rows['start_hour'];
		$tmp_end_hour = $private_holiday_rows['end_hour'];

		if($private_holiday_rows['start_hour'] == 0){
			$tmp_start_hour = $data['schedule']['working_start']; // 업무시작시간으로 설정
		}else{
			if($private_holiday_rows['start_hour'] < $data['schedule']['working_start']){
				$tmp_start_hour = $data['schedule']['working_start']; // 업무시작시간으로 설정
			}
		}
		if($private_holiday_rows['end_hour'] == 0){
			$tmp_end_hour = $data['schedule']['working_end']; // 업무마감시간으로 설정
		}else{
			if($private_holiday_rows['end_hour'] > $data['schedule']['working_end']){
				$tmp_end_hour = $data['schedule']['working_end']; // 업무마감시간으로 설정
			}
		}

		//echo $private_holiday_rows['start_hour']."/".$private_holiday_rows['end_hour']."//".$tmp_start_hour."/".$tmp_end_hour;
		$tmp_start_date = DATE("Y-m-d H:i", STRTOTIME($yy."-".$mm."-".$dd." ".$tmp_start_hour.":".$private_holiday_rows['start_minute']));
		$tmp_end_date = DATE("Y-m-d H:i", STRTOTIME($yy."-".$mm."-".$dd." ".$tmp_end_hour.":".$private_holiday_rows['end_minute']));

        // $date = date('Y-m-d', strtotime($private_holiday_rows['pri_start_date']));
        $time = date('H:i', strtotime($tmp_start_date));
        $time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($tmp_start_date))));
        $time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($tmp_end_date))));
        //$time = date('H:i', strtotime($private_holiday_rows['pri_start_date']));
        //$time_start = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($private_holiday_rows['pri_start_date']))));
        //$time_end = date2timestamp(strtotime(date('Y-m-d H:i', strtotime($private_holiday_rows['pri_end_date']))));

        $sec = ($time_end - $time_start) ? ($time_end - $time_start) : (60 * 30);
        $time_block_cnt = $sec / (60 * 30); // 블럭갯수

        // 30분간격으로 시간을 저장한다.
        for ($h = $time_start; $h < $time_end; $h += (60 * 30)) {
            $private[$private_holiday_rows['worker']][] = date('H:i', $h);
        }

        $data['private_holiday'][$artist['name']]['time'] = $private[$artist['name']];
        $data['private_holiday'][$artist['name']]['count'][$time] = (int) $time_block_cnt;
        $data['private_holiday'][$artist['name']]['data'][$time] = $private_holiday_rows;
    }
}
// echo '<pre style="">';
// var_dump($data['private_holiday'][$artist['name']]['time']);
// echo '</pre>';

// 2019.01.07 developlay - 요일별 휴일여부 추출 [END]
$sql = "select * from tb_working_schedule where customer_id='{$artist_id}'";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);
ksort($order_my);

$data['week_time'] = array();
$data['week_time']['working_start'] = $rows->working_start;
$data['week_time']['working_end'] = $rows->working_end;

// 2020.03.24 시간 예약 활성화, 비활성화 관련 
$time_off_sql = "select * from tb_time_off where customer_id = '{$artist_id}' ";
$time_off_result = mysqli_query($connection, $time_off_sql);
$time_off_row = mysqli_fetch_object($time_off_result);

$data["time_off"] = array();
$data["time_off"]["res_time_off"] = $time_off_row->res_time_off;

// 2020.04.08 ulmo 예약 스케줄 운영방식 선택
$sql = "select * from tb_time_schedule where artist_id = '{$artist_id}' ";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);

$data["time_schedule"] = array();
$data["time_schedule"]["res_time_off"] = $rows->res_time_off;

$sql = "select is_time_type from tb_shop where customer_id = '{$artist_id}' ";
$result = mysqli_query($connection, $sql);
$rows = mysqli_fetch_object($result);

$data["time_schedule"]["is_time_type"] = $rows->is_time_type;

//예약승인대기 건수
$que = "SELECT count(*) cnt FROM tb_grade_reserve_approval_mgr a
        INNER JOIN tb_payment_log b ON a.payment_log_seq = b.payment_log_seq
        WHERE b.artist_id = '{$artist_id}'
        AND a.is_approve = 0";
$gram = sql_fetch_array($que);
$await_cnt = $gram[0]['cnt'];
?>



<!-- container -->
<section id="container"> 
	<!-- page-body -->    
	<div class="page-body">
        <div class="common-bottom-ui left" style="position:fixed;bottom:74px;">
            <a href="customer_inquiry"><img src="https://image.banjjakpet.com/images/icon-circle-float_search.png" alt="" style="width:64px;"></a>
        </div>
		<div class="reserve-calendar-wrap">
			<!--<button type="button" onclick="location.href='reserve_time_sale_step1_3'" class="btn btn-outline-purple btn-middle-size btn-round">빈시간 판매하기</button>-->
			<!-- 캘린더 정렬 -->
			<div class="reserve-calendar-sort">
				<div class="sort-left">
                    <!-- actived클래스 추가시 활성화 -->
                    <button type="button" onclick="location.href='reserve_main_month?ch=month&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                        class="btn-reserve-calendar-sort">월</button>
                    <button type="button" onclick="location.href='reserve_main_week?ch=week&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                        class="btn-reserve-calendar-sort">주</button>
                    <button type="button" onclick="location.href='reserve_main_day?ch=day&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                        class="btn-reserve-calendar-sort">일</button>
                    <button type="button" onclick="location.href='reserve_main_list?ch=list&yy=<?=$yy?>&mm=<?=$mm?>&dd=<?=$dd?>';"
                        class="btn-reserve-calendar-sort actived"><span class="icon icon-type-list-gray off"></span><span
                            class="icon icon-type-list-white on"></span></button>
                </div>
				<div class="sort-right">
					<select>
						<option value="">미용</option>
					</select>
				</div>
			</div>
			<!-- //캘린더 정렬 -->
			<!-- 캘린더 상단 -->
			<div class="reserve-calendar-top">
				<button type="button" class="btn-reserve-calendar-ui btn-month-prev"><span class="icon icon-calendar-prev-small"></span></button>
				<div class="reserve-calendar-title">
					<div class="txt">09.08 (수)</div>
					<!--
					//	select태그는 투명을로 위로 띄웟고 , change 시 txt클래스내 문구 변경으로 디자인 처리
					-->
					<select>
                        <?for($i=-15;$i<0;$i++){?>
						<option value="<?= (int) date('Y', strtotime($selected_date)-86400*$i) ?>.<?= (int) date('m', strtotime($selected_date)-86400*$i) ?>.<?= (int) date('d', strtotime($selected_date)-86400*$i) ?>" data-rol1="<?=date('m.d', strtotime($selected_date)-86400*$i)?>" data-rol2="<?= $daily[date('w', strtotime($yy . '-' . $mm . '-' . $dd))] ?>"><?= (int) date('m', strtotime($selected_date)-86400*$i) ?>월 <?= (int) date('d', strtotime($selected_date)-86400*$i) ?>일</option>
						<?}?>
                        <?for($i=0;$i<15;$i++){?>
						<option value="<?= (int) date('Y', strtotime($selected_date)-86400*$i) ?>.<?= (int) date('m', strtotime($selected_date)-86400*$i) ?>.<?= (int) date('d', strtotime($selected_date)-86400*$i) ?>" <?if($i==0) echo "selected";?> data-rol1="<?=date('m.d', strtotime($selected_date)-86400*$i)?>" data-rol2="<?= $daily[date('w', strtotime($yy . '-' . $mm . '-' . $dd))] ?>"><?= (int) date('m', strtotime($selected_date)-86400*$i) ?>월 <?= (int) date('d', strtotime($selected_date)-86400*$i) ?>일</option>
						<?}?>
					</select>
				</div>
				<button type="button" class="btn-reserve-calendar-ui btn-month-next"><span class="icon icon-calendar-next-small"></span></button>
			</div>
			<!-- //캘린더 상단 -->
			<!-- 캘린더 라벨 -->
			<div class="reserve-calendar-label">
				<div class="grid-layout reserve-calendar-label-group">
					<div class="grid-layout-inner">
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state yellow"></div>앱-선결제</div></div>
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state purple"></div>앱-매장결제</div></div>
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state green"></div>매장예약</div></div>
						<div class="grid-layout-cell"><div class="reserve-calendar-label-items"><div class="reserve-calendar-label-state red"></div>NoShow</div></div>
					</div>
				</div>	
			</div>
			<!-- //캘린더 라벨 -->
			<!-- 리스트형 -->
			<div>
				<div class="reserve-calendar-list">
					
					<div class="reserve-calendar-list-group" id="manage_sell_info_list">
						
					</div>
				</div>
			</div>
			<!-- //리스트형 -->
		</div>
        <div class="reserve-calendar-float">
            <div class="reserve-calendar-float-cell">
                <button type="button" onclick="location.href='reserve_main_day';"  class="btn-reserve-calendar-today"><span
                        class="icon icon-circle-float-today"></span></button>
            </div>
            <div class="reserve-calendar-float-cell">
                <button type="button" class="btn-reserve-calendar-menu btn-reserve-calendar-toggle"><span
                        class="icon icon-circle-float-menu"></span><em><?= $wait_count+$await_cnt ?></em></button>
                <div class="reserve-calendar-float-menu">
                    <button type="button" class="btn-float-menu" onclick="location.href='customer_inquiry';">고객조회</button>
                    <button type="button" class="btn-float-menu" onclick="location.href='customer_pet_new';">신규등록</button>
                    <button type="button" class="btn-float-menu" onclick="location.href='reserve_advice_list_1';">상담 승인 대기 : <?= $wait_count ?></button>
                    <button type="button" class="btn-float-menu" onclick="location.href='reserve_waiting';">예약 승인 대기 : <?php echo $await_cnt; ?> </button>
                    <!--<button type="button" onclick="location.href='reserve_time_sale_step1_3'" class="btn-float-menu">빈시간 판매하기</button>-->
                </div>
            </div>
        </div>
	</div>
	<!-- //page-body -->	
    
</section>
<!-- //container -->






<script>
	var $manage_sell_info_list = $('#manage_sell_info_list');
	var artist_id = "<?=$user_id ?>";
	var ch = "<?=$ch ?>";
	var yy = "<?=$yy ?>";
	var mm = "<?=$mm ?>";
	var dd = "<?=($dd != "")? $dd : DATE('d') ?>";
	var weekend_kr = ['일', '월', '화', '수', '목', '금', '토'];
	var artist_list = {};

	$(function(){
		$("#loading").css("align-items", "center").css("justify-content", "center");
		$("#loading").html("<span style='color: #fff; max-width: 50%; text-align:center;'><img src='/pet/images/logo_loading0.gif' style='width: 100px; height: 100px;'/><br/><span style='color:#f5bf2e;'>반</span>려생활의 단<span style='color:#f5bf2e;'>짝</span></span>");

		init_html()
			.then(get_artist_list)
			.then(get_beauty_payment_log);
	});


	$manage_sell_info_list.on('click', '.view_payment_customer_info_btn', function(){
		var payment_log_seq = $(this).data('payment_log_seq');
		var time_start = $(this).data('time_start');
		var time_end = $(this).data('time_end');
		console.log(payment_log_seq);
		location.href = '<?=$shop_directory ?>/view_payment_customer_info.php?payment_log_seq='+payment_log_seq+'&thisTimeStart='+time_start+'&thisTimeEnd='+time_end+'&backurl='+encodeURIComponent(window.location.pathname+'?ch=list&artist_id='+artist_id+'&yy='+yy+'&mm='+fillZero(2, mm)+'&dd='+fillZero(2, dd)+'&backurl=<?=$backurl ?>');
	});

	$manage_sell_info_list.on('click', '.btn_schedule', function(){
		var ch = $(this).data('ch');
		location.href = '?ch='+ch+'&yy='+yy+'&mm='+mm+'&dd='+dd+'&backurl='+encodeURIComponent(window.location.pathname+'?ch=list&artist_id='+artist_id+'&yy='+yy+'&mm='+fillZero(2, mm)+'&dd='+fillZero(2, dd)+'&backurl=<?=$backurl ?>');
	});

	$manage_sell_info_list.on('click', '.prev_date', function(){
		var prev_date = new Date(yy+'-'+mm+'-'+dd);
		prev_date.setDate(prev_date.getDate()-1);

		yy = prev_date.getFullYear();
		mm = fillZero(2, (prev_date.getMonth()+1));
		dd = fillZero(2, prev_date.getDate());

		history.replaceState('', '', window.location.pathname+'?ch=list&artist_id='+artist_id+'&yy='+prev_date.getFullYear()+'&mm='+fillZero(2, (prev_date.getMonth()+1))+'&dd='+fillZero(2, prev_date.getDate()));
		$manage_sell_info_list.find('.now_date').text(parseInt(mm)+'월 '+parseInt(dd)+'일 ('+weekend_kr[prev_date.getDay()]+')');
		get_beauty_payment_log();
	});

	$manage_sell_info_list.on('click', '.next_date', function(){
		var next_date = new Date(yy+'-'+mm+'-'+dd);
		next_date.setDate(next_date.getDate()+1);

		yy = next_date.getFullYear();
		mm = fillZero(2, (next_date.getMonth()+1));
		dd = fillZero(2, next_date.getDate());

		history.replaceState('', '', window.location.pathname+'?ch=list&artist_id='+artist_id+'&yy='+next_date.getFullYear()+'&mm='+fillZero(2, (next_date.getMonth()+1))+'&dd='+fillZero(2, next_date.getDate()));
		$manage_sell_info_list.find('.now_date').text(parseInt(mm)+'월 '+parseInt(dd)+'일 ('+weekend_kr[next_date.getDay()]+')');
		get_beauty_payment_log();
	});

	$manage_sell_info_list.on('click', '.toggle_btn', function(){
		var no = $(this).data('no');
		console.log(no);
		$manage_sell_info_list.find('.toggle_target[data-no="'+no+'"]').toggle();
		if($(this).hasClass('on')){
			$(this).removeClass('on');
			$(this).html('<i class="fas fa-angle-down"></i>');
		}else{
			$(this).addClass('on');
			$(this).html('<i class="fas fa-angle-up"></i>');
		}
	});

	function init_html(){
		return new Promise(function(resolve, reject) {
			var html = '';
			var now_date = new Date(yy+'-'+mm+'-'+dd);

            /*
			html += '<div class="btn-header">';
			html += '	<div>';
			var is_on = (ch == 'month')? 'on' : '';
			html += '		<a href="javascript:;" class="btn btn_schedule '+is_on+'" data-ch="month"><span>월</span></a>';
			var is_on = (ch == 'week')? 'on' : '';
			html += '		<a href="javascript:;" class="btn btn_schedule '+is_on+'" data-ch="week"><span>주</span></a>';
			var is_on = (ch == 'day')? 'on' : '';
			html += '		<a href="javascript:;" class="btn btn_schedule '+is_on+'" data-ch="day"><span>일</span></a>';
			var is_on = (ch == 'list')? 'on' : '';
			html += '		<a href="javascript:;" class="btn btn_schedule '+is_on+'" data-ch="list"><span><i class="fas fa-list-ul"></i><span></a>';
			html += '	</div>';
			html += '	<ul>';
			html += '		<li style="font-size:14px;text-align:center;">';
			html += '			<label><span><span class="status_bank_color">■</span>앱-선결제</span></label>';
			html += '			<label><span><span class="status_offline_color">■</span>앱-매장결제</span></label>';
			html += '			<label><span><span class="status_pos_color">■</span>매장예약</span></label>';
			html += '			<label><span><span class="status_noshow_color">■</span>NoShow</span></label>';
			html += '		</li>';
			html += '	</ul>';
			html += '	<div>';
			html += '		<table class="calendar_wrap">';
			html += '			<tr>';
			html += '				<td align="center" class="now_date">'+parseInt(mm)+'월 '+parseInt(dd)+'일 ('+weekend_kr[now_date.getDay()]+')</td>';
			html += '				<td align="left" class="prev_date"><a href="javascript:;" class="btn_calendar"><i class="fas fa-chevron-left"></i></a></td>';
			html += '				<td align="right" class="next_date"><a href="javascript:;" class="btn_calendar"><i class="fas fa-chevron-right"></i></a></td>';
			html += '			</tr>';
			html += '		</table>';
			html += '	</div>';
			html += '</div>';
*/
			$manage_sell_info_list.html(html);
			resolve();
		});
	}

	function get_artist_list(){
		return new Promise(function(resolve, reject) {
			$.ajax({
				url: 'data/manage_sell_info_ajax.php',
				data: {
					mode: "get_artist_list",
					artist_id: artist_id
				},
				type: 'POST',
				dataType: 'JSON',
				async: false,
				success: function(data) {
					$("#loading").css('display', 'none');
					if(data.code == "000000"){
						console.log(data.data);
						artist_list = data.data;
						resolve();
					}else{
						alert(data.data+"("+data.code+")");
						console.log(data.data);
					}
				},
				error: function(xhr, status, error) {
					//alert(error + "네트워크에러");
					if(xhr.status != 0){
						alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
					}
				}
			});
		});
	}

	function get_beauty_payment_log(){
		return new Promise(function(resolve, reject) {
			$manage_sell_info_list.find(".manage_sell_info_list_wrap").remove();

			$.ajax({
				url: 'data/manage_sell_info_ajax.php',
				data: {
					mode: "get_beauty_payment_log",
					year: yy,
					month: mm,
					day: dd,
					artist_id: artist_id
				},
				type: 'POST',
				dataType: 'JSON',
				async: false,
				success: function(data) {
					$("#loading").css('display', 'none');
					if(data.code == "000000"){
						console.log(data.data);
						console.log(data.sql);
						var html = '';
						var _worker = '';

						html += '<div class="manage_sell_info_list_wrap">';
						if(data.data && data.data.length > 0){
							var _cnt = 0;
							$.each(data.data, function(i, v){
                                console.log(v);
								var _local_price = (v.local_price && v.local_price != "")? '카드: '+v.local_price+'원' : '카드: 0원';
								var _local_price_cash = (v.local_price_cash && v.local_price_cash != "")? '현금: '+v.local_price_cash+'원' : '현금: 0원';
								var _is_no_show = (v.is_no_show && v.is_no_show == "1")? '1' : '';
								var _pay_type = '';
								var _is_out = '';

								if(v.pay_type == 'card' || v.pay_type == 'bank'){
									_pay_type = 'in_app';
                                    _pay_type2 = 'yellow';
								}else if(v.pay_type == 'offline-card' || v.pay_type == 'offline-cash' || v.pay_type == 'offline'){
									_pay_type = 'in_offline';
                                    _pay_type2 = 'puple';
								}else if(v.pay_type == 'pos-card' || v.pay_type == 'pos-cash'){
									_pay_type = 'in_pos';
                                    _pay_type2 = 'green';
								}

								if(_is_no_show == '1'){
									_pay_type = 'is_no_show';
                                    _pay_type2 = 'red';
								}

								var is_view = 2;
								$.each(artist_list, function(i2, v2){
									if(v2.name == v.worker){
										is_view = 1;
										_is_out = (v2.is_out == '1')? ' (퇴사)' : '';
									}
								});

								console.log(is_view);
								if(is_view == 1){
									html += '<div>';
									if(_worker != v.worker){
										_worker = v.worker;
										var _worker_txt = (_worker == artist_id)? '대표' : _worker;
                                        html += '<div class="con-title-group">';
                                        html += '   <h5 class="con-title worker">'+_worker_txt+_is_out+'</h5>';
                                        html += '</div>';

                                        /*
										html += '	<div class="title">';
										html += '		<div class="worker">'+_worker_txt+_is_out+'</div>';								
										html += '		<div class="right_menu"><div class="toggle_btn" data-no="'+_worker+'"><i class="fas fa-angle-down"></i></div></div>';
										html += '	</div>';
                                        */
									}
                                    html += '<div class="reserve-calendar-list-items '+_pay_type2+' toggle_target" style="margin-top:10px;" onclick="location.href=\'reserve_pay_management_2?payment_log_seq='+v.payment_log_seq+'\';" data-payment_log_seq="'+v.payment_log_seq+'" data-time_start="'+v.hour+':'+v.minute+'" data-time_end="'+v.to_hour+':'+v.to_minute+'">';
                                    html += '   <div class="item-time">';
                                    html += '	    <div class="item-time-start"><em>오전</em><strong>'+fillZero(2, v.hour)+':'+fillZero(2, v.minute)+'</strong></div>';
                                    html += '	    <div class="item-time-unit">~</div>';
                                    html += '	    <div class="item-time-end"><em>오후</em><strong>'+fillZero(2, v.to_hour)+':'+fillZero(2, v.to_minute)+'</strong></div>';
                                    html += '   </div>';
                                    html += '   <div class="item-info">';
                                    html += '	    <div class="item-name">';
                                    html += '		    <div class="item-name-txt"><strong class="pet_name" data-payment_log_seq="'+v.payment_log_seq+'"></strong></div>';
                                    html += '		    <div class="item-name-division">/</div>';
                                    html += '		    <div class="item-name-txt">'+v.pet_name+'</div>';
                                    html += '	    </div>';
                                    html += '	    <div class="item-options">';
                                    html += '		    <div class="item-options-txt">'+_local_price+'</div>';
                                    html += '			<div class="item-options-division">/</div>';
                                    html += '			<div class="item-options-txt">'+_local_price_cash+'</div>';
                                    html += '		</div>';
                                    html += '	</div>';
                                    html += '</div>';
                                    /*
									html += '	<div class="toggle_target" data-no="'+_worker+'">';
									html += '		<div class="view_payment_customer_info_btn" data-payment_log_seq="'+v.payment_log_seq+'" data-time_start="'+v.hour+':'+v.minute+'" data-time_end="'+v.to_hour+':'+v.to_minute+'">';
									html += '			<ul class="table">';
									html += '				<li class="'+_pay_type+'">';
									html += '					<div class="time">'+fillZero(2, v.hour)+':'+fillZero(2, v.minute)+'</div>';
									html += '					<div class="service">'+v.service+'</div>';
									html += '				</li>';
									html += '				<li>';
									html += '					<div class="pet_name" data-payment_log_seq="'+v.payment_log_seq+'"><span>'+v.pet_name+'</span></div>';
									html += '					<div class="price">'+_local_price+' / '+_local_price_cash+'</div>';
									html += '				</li>';
									html += '			</ul>';
									html += '		</div>';
									html += '	</div>';
									html += '</div>';
                                    */
									_cnt++;
								}
							});

							if(_cnt == 0){
								html += '<div>';
								html += '	<div class="no_data">예약 일정이 없습니다.</div>';
								html += '</div>';
							}
						}else{
							html += '<div>';
							html += '	<div class="no_data">예약 일정이 없습니다.</div>';
							html += '</div>';
						}
						html += '</div>';
						console.log(html);
						$manage_sell_info_list.append(html);

						if(data.data && data.data.length > 0){
							$.each(data.data, function(i, v){
								get_pet_type(v.payment_log_seq, v.pet_seq, v.pet_name);
							});
						}
						resolve();
					}else{
						alert(data.data+"("+data.code+")");
						console.log(data.data);
					}
				},
				error: function(xhr, status, error) {
					//alert(error + "네트워크에러");
					if(xhr.status != 0){
						alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
					}
				}
			});
		});
	}
	
	function get_pet_type(_payment_log_seq, _pet_seq, _pet_name){
		return new Promise(function(resolve, reject) {
			$.ajax({
				url: 'data/manage_sell_info_ajax.php',
				data: {
					mode: "get_pet_type",
					pet_seq: _pet_seq
				},
				type: 'POST',
				dataType: 'JSON',
				async: false,
				success: function(data) {
					$("#loading").css('display', 'none');
					if(data.code == "000000"){
						console.log(data.data);

						if(data.data && data.data.length > 0){
							$.each(data.data, function(i, v){
								$manage_sell_info_list.find('.toggle_target .pet_name[data-payment_log_seq="'+_payment_log_seq+'"]').html(v.pet_type);
							});
						}

						resolve();
					}else{
						alert(data.data+"("+data.code+")");
						console.log(data.data);
					}
				},
				error: function(xhr, status, error) {
					//alert(error + "네트워크에러");
					if(xhr.status != 0){
						alert("code = "+ xhr.status + " message = " + xhr.responseText + " error = " + error); // 실패 시 처리
					}
				}
			});
		});
	}

	function formatDate(date) { 
		var a = date+'';
		a = (a.indexOf('-'))? a.replace(/-/g, '/') : date; // ios cross browsing
		var d = new Date(a), 
				month = '' + (d.getMonth() + 1), 
				day = '' + d.getDate(), 
				year = d.getFullYear(); 
		
		if (month.length < 2) month = '0' + month; 
		if (day.length < 2) day = '0' + day; 
		
		return [year, month, day].join('-'); 
	}

	//남는 길이만큼 0으로 채움
	function fillZero(width, str){
		var str = String(str);//문자열 변환
		return str.length >= width ? str:new Array(width-str.length+1).join('0')+str;
	}
</script>





<script src="/static/pub/js/Sortable.min.js"></script>
<script>
$(function(){
	/*
	$( "#sortable" ).sortable({
		placeholder: "ui-state-highlight",
		cancel:''
    });
	$( "#sortable" ).disableSelection();
	*/

	//https://github.com/SortableJS/Sortable

	$('.calendar-day-body-col').each(function(){
		if(!$(this).hasClass('break') && !$(this).hasClass('time')){
			//휴무가 아닐 경우 드래그앤 드롭 가능 처리
			var sortable = Sortable.create($(this).find('.calendar-drag-item-group')[0] , {
				group : 'shared',
				delay : 500,
				delayOnTouchOnly : true,
				ghostClass: 'guide',
				draggable : '.calendar-week-time-item',
				onStart : function(evt){
					//드래그 시작 
					console.log('drag start');
				},
				onEnd : function(evt){
					//드래그 끝
					console.log('drag end');
					//evt.to;    // 현재 아이템
					//evt.from;  // 이전 아이템
					//evt.oldIndex;  // 이전 인덱스값
					//evt.newIndex;  // 새로운 인덱스값
				},
				onUpdate : function(evt){
					console.log('update');
				},
				onUpdate : function(evt){
					console.log('onChange');
				},
				onRemove: function (/**Event*/evt) {
					console.log('remove');
				}
				
			});
		}
	});



    

    
    //$(".reserve-calendar-top select").val('<?= (int) date('Y', strtotime($first_date)) ?>.<?= (int) date('m', strtotime($first_date)) ?>.<?= (int) date('d', strtotime($first_date)) ?>');
    //console.log($(".reserve-calendar-top select").val());
    $(".reserve-calendar-top .txt").text($(".reserve-calendar-top select option:selected").attr("data-rol1")+" ("+$(".reserve-calendar-top select option:selected").attr("data-rol2")+")");
    
    var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
    if(idx==0){
        $(".btn-month-next").hide();
    }

    if(idx==11){
        $(".btn-month-prev").hide();
    }
    

    $(".reserve-calendar-top select").change(function () { 
        
        var yymm    = $(this).val().split(".");
        if(yymm[1]>=10){
            location.href="reserve_main_list?ch=week&yy="+yymm[0]+"&mm="+yymm[1]+"&dd="+yymm[2];
        }else if(yymm[1]<10 && yymm[2]<10){
            location.href="reserve_main_list?ch=week&yy="+yymm[0]+"&mm="+yymm[1].replace("0","")+"&dd="+yymm[2].replace("0","");
        }else if(yymm[1]>10 && yymm[2]<10){
            location.href="reserve_main_list?ch=week&yy="+yymm[0]+"&mm="+yymm[1]+"&dd="+yymm[2].replace("0","");
        }else{
            location.href="reserve_main_list?ch=week&yy="+yymm[0]+"&mm="+yymm[1].replace("0","")+"&dd="+yymm[2];
        }
        
    });



    $(".btn-month-prev").click(function (e) { 
        var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
        $('.reserve-calendar-top select option:eq(' + (idx+1) + ')').attr('selected', 'selected').change();
        e.preventDefault();
        
    });

    $(".btn-month-next").click(function (e) { 
        var idx = $(".reserve-calendar-top select option").index( $(".reserve-calendar-top select option:selected") );
        $('.reserve-calendar-top select option:eq(' + (idx-1) + ')').attr('selected', 'selected').change();
        e.preventDefault();
        
    });

    console.log($(".calendar-day-body").height());


    var now_date = new Date();
    var now_hours = now_date.getHours();
    var now_m = now_date.getMinutes();
    
    
    var line_hieght = ((now_hours-9)*60+now_m)*2.07;
    //console.log((((18-9)*100+now_m)/100));
    if(line_hieght>0 && line_hieght<1240){
        $(".calendar-day-current-time").css("top",line_hieght+"px");
    }else{
        $(".calendar-day-current-time").hide();
    }
});
</script>



<?
include($_SERVER['DOCUMENT_ROOT']."/include/skin/footer_shop.php");
?>
